<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KISS FM - Control de facturaci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover:hover { transform: translateY(-2px); transition: all 0.3s ease; }
        .status-paid { background: #10b981; }
        .status-pending { background: #f59e0b; }
        .status-overdue { background: #ef4444; }
        .config-tab-active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl flex items-center justify-center mx-auto mb-4">
                    <span class="text-white font-bold text-2xl">üìª</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">KISS FM Dashboard</h1>
                <p class="text-gray-600 mt-2">Acceso al sistema de gesti√≥n</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="login-email" required class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                    <input type="password" id="login-password" required class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 px-4 rounded-lg hover:shadow-lg transition-all font-medium">
                    Iniciar Sesi√≥n
                </button>
                
                <div id="login-error" class="hidden bg-red-100 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                    <!-- Error message will appear here -->
                </div>
                
                <div id="login-loading" class="hidden text-center">
                    <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm text-blue-600">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Iniciando sesi√≥n...
                    </div>
                </div>
            </form>
            
            <div class="mt-8 pt-6 border-t border-gray-200">
                <p class="text-xs text-gray-500 text-center">
                    ¬øNo tienes cuenta? Contacta al administrador del sistema
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application (hidden by default) -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-lg border-b border-gray-200">
        <div class="w-full px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-lg">üìª</span>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">KISS FM Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600" id="current-user-email"></span>
                    <button onclick="logout()" class="text-sm text-red-600 hover:text-red-800 font-medium">
                        Cerrar Sesi√≥n
                    </button>
                    <span class="text-sm text-gray-600" id="current-date">mi√©rcoles, 8 de enero de 2025</span>
                </div>
            </div>
        </div>
    </header>

    <div class="w-full px-6 py-8">
        <!-- Navigation Tabs -->
        <div class="flex space-x-1 bg-gray-100 p-1 rounded-xl mb-8">
            <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-active text-white px-6 py-3 rounded-lg font-medium transition-all">
                Dashboard
            </button>
            <button onclick="showTab('clients')" id="tab-clients" class="text-gray-600 hover:text-gray-800 px-6 py-3 rounded-lg font-medium transition-all">
                Clientes
            </button>
            <button onclick="showConfigModal()" class="text-gray-600 hover:text-gray-800 px-6 py-3 rounded-lg font-medium transition-all">
                ‚öôÔ∏è Configuraci√≥n
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-content" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-lg card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total Facturado</p>
                            <p class="text-3xl font-bold text-blue-600" id="total-facturado">0 ‚Ç¨</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <span class="text-blue-600 text-xl">üìä</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total Cobrado</p>
                            <p class="text-3xl font-bold text-green-600" id="total-cobrado">0 ‚Ç¨</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <span class="text-green-600 text-xl">‚úÖ</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg card-hover cursor-pointer" onclick="showOverdueDebtModal()">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Deuda Vencida</p>
                            <p class="text-3xl font-bold text-red-600" id="deuda-vencida">0 ‚Ç¨</p>
                        </div>
                        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                            <span class="text-red-600 text-xl">‚ö†Ô∏è</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Pendiente</p>
                            <p class="text-3xl font-bold text-orange-600" id="pendiente">0 ‚Ç¨</p>
                        </div>
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                            <span class="text-orange-600 text-xl">‚è≥</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Planificado</p>
                            <p class="text-3xl font-bold text-gray-600" id="planificado">0 ‚Ç¨</p>
                        </div>
                        <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                            <span class="text-gray-600 text-xl">üìÖ</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Cobrado este mes</p>
                            <p class="text-3xl font-bold text-purple-600" id="ventas-mes">0 ‚Ç¨</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <span class="text-purple-600 text-xl">üí∞</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Billing Table -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-800">Facturaci√≥n Mensual por Cliente</h3>
                    <div class="flex items-center space-x-4">
                        <button onclick="showAddCampaignModal()" class="bg-gradient-to-r from-green-600 to-blue-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm">
                            + Nueva Campa√±a
                        </button>
                        <button onclick="exportBillingTableToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all text-sm">
                            üìä Exportar Excel
                        </button>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700">A√±o:</label>
                            <button onclick="changeTableYear(-1)" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded transition-colors" title="A√±o anterior">
                                ‚Üê
                            </button>
                            <select id="year-filter" onchange="filterByYear(this.value)" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="2023">2023</option>
                                <option value="2024" selected>2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                            <button onclick="changeTableYear(1)" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded transition-colors" title="A√±o siguiente">
                                ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Filtros de la tabla -->
                <div class="flex flex-wrap items-center gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                    <div class="flex-1 min-w-48">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Buscar cliente:</label>
                        <input type="text" id="client-filter" placeholder="Nombre del cliente..." onkeyup="applyTableFilters()" autocomplete="off" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Emisora:</label>
                        <select id="emisora-filter" onchange="applyTableFilters()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Agente:</label>
                        <select id="agent-filter" onchange="applyTableFilters()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="clearTableFilters()" class="bg-gray-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-gray-600 transition-colors">
                            Limpiar filtros
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <div class="max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0 z-20">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sticky left-0 bg-gray-50 z-30">Cliente</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Emisora</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Agente</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ene</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Feb</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Mar</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Abr</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">May</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jun</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jul</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ago</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Sep</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Oct</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Nov</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Dic</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase bg-blue-50">Total</th>
                                </tr>
                            </thead>
                            <tbody id="monthly-billing-table" class="divide-y divide-gray-200">
                                <!-- Monthly billing data will be populated by JavaScript -->
                            </tbody>
                            <tfoot class="bg-gray-50 font-semibold sticky bottom-0 z-20">
                                <tr id="monthly-totals">
                                    <!-- Monthly totals will be populated by JavaScript -->
                                </tr>
                                <tr id="monthly-pending" class="bg-orange-50">
                                    <!-- Monthly pending amounts will be populated by JavaScript -->
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico Evolutivo -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-800">Evoluci√≥n de Facturaci√≥n</h3>
                    <div class="flex items-center space-x-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">A√±o:</label>
                            <div class="flex items-center space-x-1">
                                <button onclick="changeChartYear(-1)" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded transition-colors text-sm" title="A√±o anterior">
                                    ‚Üê
                                </button>
                                <select id="chart-year-filter" onchange="updateChart()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                </select>
                                <button onclick="changeChartYear(1)" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded transition-colors text-sm" title="A√±o siguiente">
                                    ‚Üí
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Emisora:</label>
                            <select id="chart-emisora-filter" onchange="updateChart()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Agente:</label>
                            <select id="chart-agent-filter" onchange="updateChart()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Todos</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="relative h-80">
                    <canvas id="billing-chart" class="w-full h-full"></canvas>
                </div>
            </div>

            <!-- An√°lisis Predictivo -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-800">üìà An√°lisis Predictivo de Ingresos</h3>
                    <div class="flex items-center space-x-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Meses a proyectar:</label>
                            <select id="forecast-months" onchange="updateForecast()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="3">3 meses</option>
                                <option value="6" selected>6 meses</option>
                                <option value="12">12 meses</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Modelo:</label>
                            <select id="forecast-model" onchange="updateForecast()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="linear">Tendencia Lineal</option>
                                <option value="seasonal" selected>Estacional</option>
                                <option value="conservative">Conservador</option>
                            </select>
                        </div>
                        <button onclick="showForecastDetailsModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                            Ver Detalles
                        </button>
                    </div>
                </div>
                
                <!-- Forecast Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                        <p class="text-sm text-blue-600 font-medium">Proyecci√≥n 3 Meses</p>
                        <p class="text-xl font-bold text-blue-700" id="forecast-3m">0 ‚Ç¨</p>
                        <p class="text-xs text-blue-500 mt-1" id="forecast-3m-change">vs per√≠odo anterior</p>
                    </div>
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200">
                        <p class="text-sm text-green-600 font-medium">Proyecci√≥n 6 Meses</p>
                        <p class="text-xl font-bold text-green-700" id="forecast-6m">0 ‚Ç¨</p>
                        <p class="text-xs text-green-500 mt-1" id="forecast-6m-change">vs per√≠odo anterior</p>
                    </div>
                    <div class="bg-gradient-to-r from-purple-50 to-violet-50 p-4 rounded-lg border border-purple-200">
                        <p class="text-sm text-purple-600 font-medium">Tendencia Mensual</p>
                        <p class="text-xl font-bold text-purple-700" id="monthly-trend">0%</p>
                        <p class="text-xs text-purple-500 mt-1">crecimiento promedio</p>
                    </div>
                    <div class="bg-gradient-to-r from-orange-50 to-amber-50 p-4 rounded-lg border border-orange-200">
                        <p class="text-sm text-orange-600 font-medium">Confianza</p>
                        <p class="text-xl font-bold text-orange-700" id="forecast-confidence">0%</p>
                        <p class="text-xs text-orange-500 mt-1">precisi√≥n estimada</p>
                    </div>
                </div>
                
                <!-- Forecast Chart -->
                <div class="relative h-80 bg-gray-50 rounded-lg p-4">
                    <canvas id="forecast-chart" class="w-full h-full"></canvas>
                </div>
                

            </div>

            <!-- Comisiones de Agentes -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-800">Comisiones de Agentes</h3>
                    <div class="flex items-center space-x-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Mes:</label>
                            <select id="commission-month-filter" onchange="updateCommissions()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">A√±o:</label>
                            <select id="commission-year-filter" onchange="updateCommissions()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Agente</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Tramo Actual</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ventas del Mes</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Comisi√≥n del Mes</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ventas del A√±o</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Comisi√≥n del A√±o</th>
                            </tr>
                        </thead>
                        <tbody id="commissions-table" class="divide-y divide-gray-200">
                            <!-- Commissions will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>


        </div>

        <!-- Clients Tab -->
        <div id="clients-content" class="tab-content hidden">
            <!-- Client Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-lg card-hover cursor-pointer" onclick="showTopClientsModal('revenue')">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Top Clientes</p>
                            <p class="text-2xl font-bold text-blue-600">Por Ingresos</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <span class="text-blue-600 text-xl">üëë</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg card-hover cursor-pointer" onclick="showTopClientsModal('loyalty')">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Top Clientes</p>
                            <p class="text-2xl font-bold text-green-600">Por Fidelidad</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <span class="text-green-600 text-xl">‚≠ê</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg card-hover cursor-pointer" onclick="showTopClientsModal('payment')">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Mejor Tasa</p>
                            <p class="text-2xl font-bold text-purple-600">de Cobro</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <span class="text-purple-600 text-xl">üíØ</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg card-hover cursor-pointer" onclick="showTopClientsModal('growth')">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Mayor</p>
                            <p class="text-2xl font-bold text-orange-600">Crecimiento</p>
                        </div>
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                            <span class="text-orange-600 text-xl">üìà</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">Gesti√≥n de Clientes</h2>
                    <div class="flex space-x-3">
                        <button onclick="exportClientsToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all">
                            üìä Exportar Excel
                        </button>
                        <button onclick="showAddClientModal()" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all">
                            + Nuevo Cliente
                        </button>
                    </div>
                </div>
                
                <!-- Filtros de clientes -->
                <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="flex-1 min-w-48">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Buscar cliente:</label>
                        <input type="text" id="client-name-filter" placeholder="Nombre del cliente..." onkeyup="applyClientFilters()" autocomplete="off" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Emisora:</label>
                        <select id="client-emisora-filter" onchange="applyClientFilters()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Agente:</label>
                        <select id="client-agent-filter" onchange="applyClientFilters()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Estado:</label>
                        <select id="client-status-filter" onchange="applyClientFilters()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Todos</option>
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Fin de campa√±a:</label>
                        <select id="client-campaign-end-filter" onchange="applyClientFilters()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Todos</option>
                            <option value="this-month">Este mes</option>
                            <option value="next-month">Pr√≥ximo mes</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="clearClientFilters()" class="bg-gray-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-gray-600 transition-colors">
                            Limpiar filtros
                        </button>
                    </div>
                </div>
                
                <!-- Pagination Controls -->
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-700">Mostrar:</span>
                        <select id="clients-per-page" onchange="changeClientsPerPage()" class="border border-gray-300 rounded px-2 py-1 text-sm">
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="text-sm text-gray-700">clientes por p√°gina</span>
                    </div>
                    <div id="clients-pagination-info" class="text-sm text-gray-700">
                        <!-- Pagination info will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Emisora</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Agente</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fin Campa√±a</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Pagado</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table" class="divide-y divide-gray-200">
                            <!-- Clients will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Navigation -->
                <div id="clients-pagination" class="flex justify-center items-center space-x-2 mt-4">
                    <!-- Pagination buttons will be populated by JavaScript -->
                </div>
            </div>
        </div>



    </div>
    <!-- End Main Application -->

    <!-- Modals -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="if(event.target === this) closeModal()">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div id="modal-content" class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Invoice Status Dropdown -->
    <div id="invoice-status-dropdown" class="fixed bg-white border border-gray-200 rounded-md shadow-lg p-1 hidden z-50" style="min-width: 110px;">
        <div class="space-y-0">
            <button onclick="updateInvoiceStatus('paid')" class="w-full text-left px-2 py-1 text-xs hover:bg-green-50 hover:text-green-700 rounded flex items-center space-x-1">
                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                <span>Pagada</span>
            </button>
            <button onclick="updateInvoiceStatus('pending')" class="w-full text-left px-2 py-1 text-xs hover:bg-yellow-50 hover:text-yellow-700 rounded flex items-center space-x-1">
                <span class="w-2 h-2 bg-yellow-500 rounded-full"></span>
                <span>Pendiente</span>
            </button>
            <button onclick="updateInvoiceStatus('overdue')" class="w-full text-left px-2 py-1 text-xs hover:bg-red-50 hover:text-red-700 rounded flex items-center space-x-1">
                <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                <span>Vencida</span>
            </button>
            <button onclick="updateInvoiceStatus('not_sent')" class="w-full text-left px-2 py-1 text-xs hover:bg-gray-50 hover:text-gray-700 rounded flex items-center space-x-1">
                <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
                <span>No enviada</span>
            </button>
        </div>
    </div>

    <script>
        // Supabase configuration - Fixed defaults
        const SUPABASE_URL = 'https://irtouttxmanaueujllys.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlydG91dHR4bWFuYXVldWpsbHlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyODY4MjAsImV4cCI6MjA2OTg2MjgyMH0.ZtqWmtZh6OSocorl2a_xqKe7K9E0fqebz-TCRd3wd1Q';
        
        let supabaseUrl = SUPABASE_URL;
        let supabaseKey = SUPABASE_KEY;
        let supabaseClient = null;
        let currentUser = null;

        // Holded API configuration
        let holdedApiKey = localStorage.getItem('holded-api-key') || '';
        let holdedSyncEnabled = localStorage.getItem('holded-sync-enabled') === 'true';
        let lastHoldedSync = localStorage.getItem('last-holded-sync') || null;
        
        // Holded sync interval (check every 5 minutes)
        let holdedSyncInterval = null;

        // Using Node.js proxy instead of CORS proxies
        const PROXY_BASE_URL = 'https://holded-proxy.onrender.com';

        // Initialize Supabase client if credentials exist
        function initSupabase() {
            if (supabaseUrl && supabaseKey) {
                try {
                    // Load Supabase client from CDN
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                    script.onload = () => {
                        supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                        console.log('Supabase client initialized');
                        checkAuthState();
                    };
                    document.head.appendChild(script);
                } catch (error) {
                    console.error('Error initializing Supabase:', error);
                }
            }
        }

        // Initialize Supabase client synchronously (for login)
        async function initializeSupabaseClient() {
            if (supabaseClient) return supabaseClient;
            
            if (!window.supabase) {
                // Load Supabase client from CDN if not already loaded
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
            
            if (supabaseUrl && supabaseKey) {
                supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                console.log('Supabase client initialized synchronously');
                return supabaseClient;
            } else {
                throw new Error('Supabase credentials not configured');
            }
        }

        // Authentication functions
        async function login(email, password) {
            if (!supabaseClient) {
                throw new Error('Supabase no est√° configurado. Ve a Configuraci√≥n ‚Üí Base de Datos para configurarlo.');
            }

            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) {
                throw error;
            }

            currentUser = data.user;
            return data;
        }

        async function logout() {
            if (supabaseClient) {
                await supabaseClient.auth.signOut();
            }
            currentUser = null;
            showLoginScreen();
        }

        async function checkAuthState() {
            console.log('Checking auth state...');
            
            // Check for demo mode first
            if (checkDemoMode()) {
                return;
            }
            
            if (!supabaseClient) {
                console.log('No Supabase client, showing login screen');
                showLoginScreen();
                return;
            }

            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    console.error('Error getting session:', error);
                    showLoginScreen();
                    return;
                }
                
                console.log('Current session:', session);
                
                if (session && session.user) {
                    console.log('User is authenticated:', session.user.email);
                    currentUser = session.user;
                    showMainApp();
                } else {
                    console.log('No active session, showing login screen');
                    showLoginScreen();
                }

                // Listen for auth changes
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    console.log('Auth state changed:', event, session);
                    
                    if (event === 'SIGNED_IN' && session) {
                        console.log('User signed in:', session.user.email);
                        currentUser = session.user;
                        showMainApp();
                    } else if (event === 'SIGNED_OUT') {
                        console.log('User signed out');
                        currentUser = null;
                        showLoginScreen();
                    }
                });
            } catch (error) {
                console.error('Error in checkAuthState:', error);
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        // Demo mode - bypass login if no Supabase configured
        function checkDemoMode() {
            if (!supabaseUrl || !supabaseKey || supabaseUrl === 'YOUR_SUPABASE_URL' || supabaseKey === 'YOUR_SUPABASE_KEY') {
                console.log('üìä Demo mode - bypassing login');
                loadSampleData();
                showMainApp();
                return true;
            }
            return false;
        }

        async function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // Update user email in header
            if (currentUser) {
                document.getElementById('current-user-email').textContent = currentUser.email;
            }
            
            // Load data from Supabase if available
            await loadDataFromSupabase();
            
            // Ensure we have sample data if no data was loaded
            if (clients.length === 0 || campaigns.length === 0 || agents.length === 0) {
                console.log('üìä No data found, loading sample data');
                loadSampleData();
            }
            
            // Initialize dashboard and restore last active tab
            initializeDashboard();
        }

        // Handle login form submission
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    const errorDiv = document.getElementById('login-error');
                    const loadingDiv = document.getElementById('login-loading');
                    
                    // Hide previous errors
                    errorDiv.classList.add('hidden');
                    loadingDiv.classList.remove('hidden');
                    
                    try {
                        console.log('Attempting login with:', email);
                        
                        // Check if Supabase is initialized
                        if (!supabaseClient) {
                            console.log('Supabase not initialized, initializing now...');
                            await initializeSupabaseClient();
                        }
                        
                        const result = await login(email, password);
                        console.log('Login successful:', result);
                        
                        // Success - the auth state change will handle showing the main app
                    } catch (error) {
                        console.error('Login error:', error);
                        let errorMessage = 'Error al iniciar sesi√≥n. Verifica tus credenciales.';
                        
                        if (error.message) {
                            if (error.message.includes('Invalid login credentials')) {
                                errorMessage = 'Credenciales incorrectas. Verifica tu email y contrase√±a.';
                            } else if (error.message.includes('Email not confirmed')) {
                                errorMessage = 'Email no confirmado. Revisa tu bandeja de entrada.';
                            } else if (error.message.includes('Too many requests')) {
                                errorMessage = 'Demasiados intentos. Espera unos minutos e intenta de nuevo.';
                            } else {
                                errorMessage = error.message;
                            }
                        }
                        
                        errorDiv.textContent = errorMessage;
                        errorDiv.classList.remove('hidden');
                    } finally {
                        loadingDiv.classList.add('hidden');
                    }
                });
            }
        });

        // Test Supabase connection
        async function testSupabaseConnection() {
            const url = document.getElementById('supabase-url').value;
            const key = document.getElementById('supabase-key').value;
            const statusDiv = document.getElementById('connection-status');
            
            if (!url || !key) {
                showConnectionStatus('error', 'Por favor, introduce la URL y la clave de Supabase');
                return;
            }
            
            try {
                // Load Supabase client if not already loaded
                if (!window.supabase) {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                }
                
                const testClient = window.supabase.createClient(url, key);
                const { data, error } = await testClient.from('emisoras').select('count', { count: 'exact' });
                
                if (error) {
                    showConnectionStatus('error', `Error de conexi√≥n: ${error.message}`);
                } else {
                    showConnectionStatus('success', '‚úÖ Conexi√≥n exitosa a Supabase');
                    
                    // Don't reload data during test - just test connection
                    console.log('Connection test successful, keeping current data');
                }
            } catch (error) {
                showConnectionStatus('error', `Error: ${error.message}`);
            }
        }

        // Save Supabase configuration
        function saveSupabaseConfig() {
            const url = document.getElementById('supabase-url').value;
            const key = document.getElementById('supabase-key').value;
            
            if (!url || !key) {
                showConnectionStatus('error', 'Por favor, introduce la URL y la clave de Supabase');
                return;
            }
            
            localStorage.setItem('supabase-url', url);
            localStorage.setItem('supabase-key', key);
            
            supabaseUrl = url;
            supabaseKey = key;
            
            initSupabase();
            showConnectionStatus('success', 'üíæ Configuraci√≥n guardada correctamente');
        }

        // Automatic sync function - syncs silently in background
        async function autoSyncToSupabase() {
            if (!supabaseClient) return;
            
            try {
                // Sync all data silently
                await syncEmisoras();
                await syncCommissionPolicies();
                await syncAgents();
                await syncClients();
                await syncCampaigns();
                await syncCampaignStatuses();
                
                console.log('‚úÖ Auto-sync to Supabase completed successfully');
            } catch (error) {
                console.error('‚ùå Auto-sync to Supabase failed:', error);
                // Don't show error to user for auto-sync, just log it
            }
        }

        // Sync data to Supabase
        async function syncToSupabase() {
            if (!supabaseClient) {
                showConnectionStatus('error', 'Primero configura y prueba la conexi√≥n a Supabase');
                return;
            }
            
            try {
                showConnectionStatus('info', 'üîÑ Sincronizando datos...');
                
                // Sync emisoras
                await syncEmisoras();
                
                // Sync commission policies
                await syncCommissionPolicies();
                
                // Sync agents
                await syncAgents();
                
                // Sync clients
                await syncClients();
                
                // Sync campaigns
                await syncCampaigns();
                
                // Sync campaign statuses
                await syncCampaignStatuses();
                
                showConnectionStatus('success', '‚úÖ Datos sincronizados correctamente');
            } catch (error) {
                showConnectionStatus('error', `Error en sincronizaci√≥n: ${error.message}`);
            }
        }

        // Individual sync functions
        async function syncEmisoras() {
            // Filter out invalid records and use upsert
            const validEmisoras = emisoras.filter(e => e.id && e.name && e.frequency);
            if (validEmisoras.length === 0) return;
            
            const { error } = await supabaseClient.from('emisoras').upsert(
                validEmisoras.map(e => ({ id: e.id, name: e.name, frequency: e.frequency })),
                { onConflict: 'id' }
            );
            
            if (error) throw error;
        }

        async function syncCommissionPolicies() {
            // Filter out invalid records and use upsert
            const validPolicies = commissionPolicies.filter(p => p.id && p.name && p.tiers);
            if (validPolicies.length === 0) return;
            
            const { error } = await supabaseClient.from('commission_policies').upsert(
                validPolicies.map(p => ({ id: p.id, name: p.name, tiers: p.tiers })),
                { onConflict: 'id' }
            );
            
            if (error) throw error;
        }

        async function syncAgents() {
            // Filter out invalid records and use upsert
            const validAgents = agents.filter(a => a.id && a.name);
            if (validAgents.length === 0) return;
            
            const { error } = await supabaseClient.from('agents').upsert(
                validAgents.map(a => ({
                    id: a.id,
                    name: a.name,
                    email: a.email || '',
                    phone: a.phone || '',
                    commission_policy_id: a.commissionPolicyId || null,
                    sales: a.sales || 0,
                    active: a.active !== undefined ? a.active : true
                })),
                { onConflict: 'id' }
            );
            
            if (error) throw error;
        }

        async function syncClients() {
            // Filter out invalid records and use upsert
            const validClients = clients.filter(c => 
                c && 
                typeof c.id === 'number' && 
                c.id > 0 && 
                c.name && 
                typeof c.name === 'string' && 
                c.name.trim().length > 0 &&
                c.emisora && 
                typeof c.emisora === 'string' && 
                c.emisora.trim().length > 0
            );
            
            console.log('üìä Syncing clients:', validClients.length, 'of', clients.length);
            
            if (validClients.length === 0) {
                console.log('üìä No valid clients to sync');
                return;
            }
            
            const { error } = await supabaseClient.from('clients').upsert(
                validClients.map(c => ({
                    id: c.id,
                    name: c.name.trim(),
                    emisora: c.emisora.trim(),
                    agent_id: (c.agentId && typeof c.agentId === 'number' && c.agentId > 0) ? c.agentId : null
                })),
                { onConflict: 'id' }
            );
            
            if (error) {
                console.error('üìä Error syncing clients:', error);
                throw error;
            }
            
            console.log('üìä Clients synced successfully');
        }

        async function syncCampaigns() {
            // Filter out invalid records and use upsert
            const validCampaigns = campaigns.filter(c => 
                c && 
                typeof c.id === 'number' && 
                c.id > 0 &&
                typeof c.clientId === 'number' && 
                c.clientId > 0 &&
                c.emisora && 
                typeof c.emisora === 'string' && 
                c.emisora.trim().length > 0 &&
                typeof c.amount === 'number' && 
                c.amount > 0 &&
                typeof c.startMonth === 'number' && 
                c.startMonth >= 1 && 
                c.startMonth <= 12 &&
                typeof c.startYear === 'number' && 
                c.startYear > 2000 &&
                typeof c.endMonth === 'number' && 
                c.endMonth >= 1 && 
                c.endMonth <= 12 &&
                typeof c.endYear === 'number' && 
                c.endYear > 2000
            );
            
            console.log('üìä Syncing campaigns:', validCampaigns.length, 'of', campaigns.length);
            
            if (validCampaigns.length === 0) {
                console.log('üìä No valid campaigns to sync');
                return;
            }
            
            const { error } = await supabaseClient.from('campaigns').upsert(
                validCampaigns.map(c => ({
                    id: c.id,
                    client_id: c.clientId,
                    emisora: c.emisora.trim(),
                    agent_id: (c.agentId && typeof c.agentId === 'number' && c.agentId > 0) ? c.agentId : null,
                    amount: c.amount,
                    start_month: c.startMonth,
                    start_year: c.startYear,
                    end_month: c.endMonth,
                    end_year: c.endYear,
                    billing_day: (typeof c.billingDay === 'number' && c.billingDay > 0) ? c.billingDay : 1,
                    due_after_days: (typeof c.dueAfterDays === 'number' && c.dueAfterDays > 0) ? c.dueAfterDays : 30
                })),
                { onConflict: 'id' }
            );
            
            if (error) {
                console.error('üìä Error syncing campaigns:', error);
                throw error;
            }
            
            console.log('üìä Campaigns synced successfully');
        }

        async function syncCampaignStatuses() {
            const statusData = [];
            Object.keys(campaignStatuses).forEach(key => {
                const [campaignId, month, year] = key.split('-');
                const parsedCampaignId = parseInt(campaignId);
                const parsedMonth = parseInt(month);
                const parsedYear = parseInt(year);
                
                // Validate data before adding
                if (parsedCampaignId && parsedMonth && parsedYear && campaignStatuses[key]) {
                    statusData.push({
                        campaign_id: parsedCampaignId,
                        month: parsedMonth,
                        year: parsedYear,
                        status: campaignStatuses[key]
                    });
                }
            });
            
            if (statusData.length > 0) {
                // Use upsert to avoid duplicates
                const { error } = await supabaseClient.from('campaign_statuses').upsert(
                    statusData,
                    { onConflict: 'campaign_id,month,year' }
                );
                if (error) throw error;
            }
        }

        // Load data from Supabase
        async function loadDataFromSupabase() {
            if (!supabaseClient) return;
            
            try {
                // Load campaigns
                const { data: campaignsData, error: campaignsError } = await supabaseClient
                    .from('campaigns')
                    .select('*');
                
                if (!campaignsError && campaignsData) {
                    campaigns = campaignsData.map(c => ({
                        id: c.id,
                        clientId: c.client_id,
                        emisora: c.emisora,
                        agentId: c.agent_id,
                        amount: c.amount,
                        startMonth: c.start_month,
                        startYear: c.start_year,
                        endMonth: c.end_month,
                        endYear: c.end_year,
                        billingDay: c.billing_day,
                        dueAfterDays: c.due_after_days
                    }));
                }
                
                // Load campaign statuses
                const { data: statusesData, error: statusesError } = await supabaseClient
                    .from('campaign_statuses')
                    .select('*');
                
                if (!statusesError && statusesData) {
                    campaignStatuses = {};
                    statusesData.forEach(status => {
                        const key = `${status.campaign_id}-${status.month}-${status.year}`;
                        campaignStatuses[key] = status.status;
                    });
                }
                
                // Load clients
                const { data: clientsData, error: clientsError } = await supabaseClient
                    .from('clients')
                    .select('*');
                
                if (!clientsError && clientsData) {
                    clients = clientsData.map(c => ({
                        id: c.id,
                        name: c.name,
                        emisora: c.emisora,
                        agentId: c.agent_id
                    }));
                    
                    // Sort clients alphabetically
                    clients.sort((a, b) => a.name.localeCompare(b.name, 'es', { sensitivity: 'base' }));
                }
                
                // Load agents
                const { data: agentsData, error: agentsError } = await supabaseClient
                    .from('agents')
                    .select('*');
                
                if (!agentsError && agentsData) {
                    agents = agentsData.map(a => ({
                        id: a.id,
                        name: a.name,
                        email: a.email,
                        phone: a.phone,
                        commissionPolicyId: a.commission_policy_id,
                        sales: a.sales,
                        active: a.active
                    }));
                }
                
                // Load emisoras
                const { data: emisorasData, error: emisorasError } = await supabaseClient
                    .from('emisoras')
                    .select('*');
                
                if (!emisorasError && emisorasData) {
                    emisoras = emisorasData.map(e => ({
                        id: e.id,
                        name: e.name,
                        frequency: e.frequency
                    }));
                }
                
                // Load commission policies
                const { data: policiesData, error: policiesError } = await supabaseClient
                    .from('commission_policies')
                    .select('*');
                
                if (!policiesError && policiesData) {
                    commissionPolicies = policiesData.map(p => ({
                        id: p.id,
                        name: p.name,
                        tiers: p.tiers
                    }));
                }
                
                console.log('Data loaded from Supabase successfully');
            } catch (error) {
                console.error('Error loading data from Supabase:', error);
            }
        }

        // Show success toast notification
        function showSuccessToast(message) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
            toast.textContent = message;
            
            // Add to page
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Show connection status
        function showConnectionStatus(type, message) {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.className = `mt-4 p-3 rounded-lg ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
            
            // Auto-hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Diagnose sync issues
        async function diagnoseSyncIssues() {
            showConnectionStatus('info', 'üîç Diagnosticando problemas de sincronizaci√≥n...');
            
            const diagnostics = {
                supabaseConnected: !!supabaseClient,
                localData: {
                    clients: clients.length,
                    campaigns: campaigns.length,
                    agents: agents.length,
                    emisoras: emisoras.length,
                    commissionPolicies: commissionPolicies.length,
                    campaignStatuses: Object.keys(campaignStatuses).length
                },
                supabaseData: {
                    clients: 0,
                    campaigns: 0,
                    agents: 0,
                    emisoras: 0,
                    commissionPolicies: 0,
                    campaignStatuses: 0
                },
                errors: []
            };
            
            if (!supabaseClient) {
                diagnostics.errors.push('‚ùå Supabase no est√° conectado');
                showDiagnosticsModal(diagnostics);
                return;
            }
            
            try {
                // Check each table
                const tables = ['clients', 'campaigns', 'agents', 'emisoras', 'commission_policies', 'campaign_statuses'];
                
                for (const table of tables) {
                    try {
                        const { data, error, count } = await supabaseClient
                            .from(table)
                            .select('*', { count: 'exact' });
                        
                        if (error) {
                            diagnostics.errors.push(`‚ùå Error en tabla ${table}: ${error.message}`);
                        } else {
                            const key = table === 'commission_policies' ? 'commissionPolicies' : 
                                       table === 'campaign_statuses' ? 'campaignStatuses' : table;
                            diagnostics.supabaseData[key] = count || 0;
                        }
                    } catch (err) {
                        diagnostics.errors.push(`‚ùå No se pudo acceder a la tabla ${table}: ${err.message}`);
                    }
                }
                
                showDiagnosticsModal(diagnostics);
                
            } catch (error) {
                diagnostics.errors.push(`‚ùå Error general: ${error.message}`);
                showDiagnosticsModal(diagnostics);
            }
        }
        
        function showDiagnosticsModal(diagnostics) {
            const localDataHtml = Object.entries(diagnostics.localData)
                .map(([key, value]) => `<div class="flex justify-between"><span>${key}:</span><span class="font-semibold">${value}</span></div>`)
                .join('');
                
            const supabaseDataHtml = Object.entries(diagnostics.supabaseData)
                .map(([key, value]) => `<div class="flex justify-between"><span>${key}:</span><span class="font-semibold">${value}</span></div>`)
                .join('');
                
            const errorsHtml = diagnostics.errors.length > 0 
                ? diagnostics.errors.map(error => `<div class="text-red-600 text-sm">${error}</div>`).join('')
                : '<div class="text-green-600 text-sm">‚úÖ No se encontraron errores</div>';
            
            const modalContent = `
                <div class="max-w-2xl w-full">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üîç Diagn√≥stico de Sincronizaci√≥n</h3>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-medium text-blue-800 mb-2">Estado de Conexi√≥n</h4>
                            <div class="text-sm ${diagnostics.supabaseConnected ? 'text-green-600' : 'text-red-600'}">
                                ${diagnostics.supabaseConnected ? '‚úÖ Conectado a Supabase' : '‚ùå No conectado a Supabase'}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 mb-2">Datos Locales</h4>
                                <div class="text-sm space-y-1">
                                    ${localDataHtml}
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 mb-2">Datos en Supabase</h4>
                                <div class="text-sm space-y-1">
                                    ${supabaseDataHtml}
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="font-medium text-red-800 mb-2">Errores Detectados</h4>
                            <div class="space-y-1">
                                ${errorsHtml}
                            </div>
                        </div>
                        
                        ${diagnostics.supabaseConnected ? `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-medium text-green-800 mb-2">Acciones Recomendadas</h4>
                            <div class="space-y-2">
                                <button onclick="forceSyncAllData()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                                    üîÑ Forzar Sincronizaci√≥n Completa
                                </button>
                                <button onclick="loadDataFromSupabase()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 transition-colors">
                                    ‚¨áÔ∏è Cargar Datos desde Supabase
                                </button>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex justify-end pt-4 border-t mt-4">
                        <button onclick="closeModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }
        
        // Force sync all data
        async function forceSyncAllData() {
            try {
                showConnectionStatus('info', 'üîÑ Forzando sincronizaci√≥n completa...');
                
                await syncEmisoras();
                await syncCommissionPolicies();
                await syncAgents();
                await syncClients();
                await syncCampaigns();
                await syncCampaignStatuses();
                
                showConnectionStatus('success', '‚úÖ Sincronizaci√≥n completa exitosa');
                
                // Close modal and refresh
                setTimeout(() => {
                    closeModal();
                    loadDashboard();
                }, 2000);
                
            } catch (error) {
                showConnectionStatus('error', `‚ùå Error en sincronizaci√≥n: ${error.message}`);
            }
        }

        // Copy SQL script
        function copySQL() {
            const sqlScript = document.getElementById('sql-script').textContent;
            
            // Try modern clipboard API first
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(sqlScript).then(() => {
                    showConnectionStatus('success', 'üìã SQL copiado al portapapeles');
                }).catch(() => {
                    fallbackCopyTextToClipboard(sqlScript);
                });
            } else {
                // Fallback for older browsers or non-secure contexts
                fallbackCopyTextToClipboard(sqlScript);
            }
        }

        // Holded API Integration Functions
        async function testHoldedConnection() {
            const apiKey = document.getElementById('holded-api-key').value;
            const statusDiv = document.getElementById('holded-connection-status');
            
            if (!apiKey) {
                showHoldedStatus('error', 'Por favor, introduce la API Key de Holded');
                return;
            }
            
            try {
                showHoldedStatus('info', 'üîÑ Probando conexi√≥n con tu proxy Node.js...');
                
                // Clean API key to ensure it only contains valid characters
                const cleanApiKey = apiKey.trim().replace(/[^\x00-\xFF]/g, '');
                
                if (cleanApiKey !== apiKey.trim()) {
                    showHoldedStatus('error', '‚ùå La API Key contiene caracteres no v√°lidos. Verifica que est√© copiada correctamente.');
                    return;
                }
                
                // Update global API key for the request
                holdedApiKey = cleanApiKey;
                
                // Test connection through your Node.js proxy
                const response = await fetch('https://mi-proxy.com/api/documents', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${cleanApiKey}`
                    },
                    signal: AbortSignal.timeout(15000)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showHoldedStatus('success', `‚úÖ Conexi√≥n exitosa a trav√©s de tu proxy Node.js. Se encontraron ${data.length || 0} documentos.`);
                } else if (response.status === 401) {
                    showHoldedStatus('error', '‚ùå API Key inv√°lida. Verifica tu clave de acceso en Holded.');
                } else if (response.status === 403) {
                    showHoldedStatus('error', '‚ùå Acceso denegado. La API Key no tiene permisos para acceder a facturas.');
                } else if (response.status === 429) {
                    showHoldedStatus('error', '‚ùå L√≠mite de peticiones excedido. Espera unos minutos e intenta de nuevo.');
                } else {
                    const errorText = await response.text();
                    showHoldedStatus('error', `‚ùå Error HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showHoldedStatus('error', '‚ùå Tiempo de espera agotado. Verifica que tu proxy est√© funcionando.');
                } else if (error.message.includes('Failed to fetch')) {
                    showHoldedStatus('error', '‚ùå No se puede conectar al proxy. Verifica que https://holded-proxy.onrender.com est√© accesible.');
                } else {
                    showHoldedStatus('error', `‚ùå Error de conexi√≥n: ${error.message}`);
                }
            }
        }

        // Test basic internet connectivity
        async function testInternetConnectivity() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch('https://httpbin.org/get', {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    return { success: true, message: 'Conectividad OK' };
                } else {
                    return { success: false, message: 'Sin conexi√≥n a internet' };
                }
            } catch (error) {
                return { success: false, message: 'Sin conexi√≥n a internet o bloqueado por firewall' };
            }
        }

        // Make request to your Node.js proxy
        async function makeHoldedRequest(endpoint, options = {}) {
            const proxyUrl = `https://mi-proxy.com/api/${endpoint}`;
            
            const response = await fetch(proxyUrl, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${holdedApiKey}`,
                    ...options.headers
                }
            });
            
            return response;
        }

        // Handle Holded connection errors with detailed diagnostics
        async function handleHoldedConnectionError(error) {
            console.error('Holded connection error:', error);
            
            if (error.name === 'AbortError') {
                showHoldedStatus('error', '‚ùå Tiempo de espera agotado. La API de Holded no responde.');
                showHoldedDiagnostics('timeout');
            } else if (error.message.includes('All CORS proxies failed')) {
                showHoldedStatus('error', '‚ùå Todos los proxies CORS han fallado. Detalles en consola.');
                console.error('Proxy failure details:', error.message);
                setTimeout(() => runHoldedDiagnostics(), 1000);
            } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                showHoldedStatus('error', '‚ùå Error de conexi√≥n detectado. Probando proxies autom√°ticamente...');
                // Auto-run diagnostics for connection errors
                setTimeout(() => runHoldedDiagnostics(), 1000);
            } else if (error.message.includes('non ISO-8859-1') || error.message.includes('headers')) {
                showHoldedStatus('error', '‚ùå Error de codificaci√≥n en la API Key. Verifica que no contenga caracteres especiales.');
            } else if (error.message.includes('CORS')) {
                showHoldedStatus('error', '‚ùå Error CORS detectado. Probando proxies autom√°ticamente...');
                setTimeout(() => runHoldedDiagnostics(), 1000);
            } else {
                showHoldedStatus('error', `‚ùå Error inesperado: ${error.message}. Ejecutando diagn√≥stico...`);
                setTimeout(() => runHoldedDiagnostics(), 1000);
            }
        }

        // Run diagnostics for Node.js proxy connection
        async function runHoldedDiagnostics() {
            const diagnostics = {
                internetConnection: false,
                proxyReachable: false,
                apiKeyValid: false,
                responseTime: null,
                httpStatus: null,
                networkType: 'unknown',
                browserInfo: {
                    userAgent: navigator.userAgent,
                    cookiesEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine,
                    language: navigator.language,
                    platform: navigator.platform,
                    vendor: navigator.vendor,
                    connection: navigator.connection ? {
                        effectiveType: navigator.connection.effectiveType,
                        downlink: navigator.connection.downlink,
                        rtt: navigator.connection.rtt
                    } : null
                }
            };
            
            showHoldedStatus('info', 'üîç Ejecutando diagn√≥stico del proxy Node.js...');
            
            // Test 1: Basic internet connectivity
            try {
                const startTime = Date.now();
                const response = await fetch('https://httpbin.org/get', { 
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                const responseTime = Date.now() - startTime;
                
                if (response.ok) {
                    diagnostics.internetConnection = true;
                    diagnostics.responseTime = responseTime;
                }
            } catch (e) {
                diagnostics.internetConnection = false;
            }
            
            // Test 2: Check if proxy is reachable
            try {
                const startTime = Date.now();
                const response = await fetch(`${PROXY_BASE_URL}/health`, { 
                    method: 'GET',
                    signal: AbortSignal.timeout(8000)
                });
                const responseTime = Date.now() - startTime;
                
                if (response.ok) {
                    diagnostics.proxyReachable = true;
                    diagnostics.proxyResponseTime = responseTime;
                }
            } catch (e) {
                diagnostics.proxyReachable = false;
                diagnostics.proxyError = e.message;
            }
            
            // Test 3: API Key validation through proxy
            if (holdedApiKey && holdedApiKey.length > 10) {
                try {
                    const response = await makeHoldedRequest('documents?limit=1', {
                        method: 'GET',
                        signal: AbortSignal.timeout(10000)
                    });
                    
                    diagnostics.httpStatus = response.status;
                    
                    if (response.ok) {
                        diagnostics.apiKeyValid = true;
                        
                        try {
                            const data = await response.json();
                            diagnostics.apiResponse = {
                                hasData: Array.isArray(data),
                                dataLength: Array.isArray(data) ? data.length : 0
                            };
                        } catch (jsonError) {
                            diagnostics.apiResponse = { parseError: true };
                        }
                    } else {
                        diagnostics.apiKeyValid = false;
                        
                        try {
                            const errorData = await response.text();
                            diagnostics.apiError = errorData.substring(0, 200);
                        } catch (e) {
                            diagnostics.apiError = 'No se pudo obtener detalles del error';
                        }
                    }
                } catch (e) {
                    if (e.name === 'AbortError') {
                        diagnostics.apiTimeout = true;
                    } else {
                        diagnostics.apiError = e.message;
                    }
                }
            }
            
            // Test 4: Network type detection
            if (navigator.connection) {
                diagnostics.networkType = navigator.connection.effectiveType || 'unknown';
            }
            
            showProxyDiagnosticsResults(diagnostics);
        }

        // Show diagnostic results with specific solutions
        function showHoldedDiagnosticsResults(diagnostics) {
            let statusType = 'info';
            let message = 'üîç **Diagn√≥stico Avanzado de Conexi√≥n con Holded**\n\n';
            let solutions = [];
            let technicalInfo = [];
            
            // Connection status with detailed results
            message += '**üì° Estado de Conectividad:**\n';
            
            if (!diagnostics.internetConnection) {
                message += '‚ùå Sin conexi√≥n a internet';
                if (diagnostics.responseTime === 'timeout') {
                    message += ' (timeout)';
                }
                message += '\n';
                solutions.push('‚Ä¢ Verifica tu conexi√≥n a internet');
                solutions.push('‚Ä¢ Comprueba que no est√©s detr√°s de un firewall corporativo');
                statusType = 'error';
            } else {
                message += '‚úÖ Conexi√≥n a internet OK';
                if (diagnostics.responseTime) {
                    message += ` (${diagnostics.responseTime}ms)`;
                }
                message += '\n';
                
                // Show connectivity test results
                if (diagnostics.connectivityTests && diagnostics.connectivityTests.length > 0) {
                    const successfulTests = diagnostics.connectivityTests.filter(t => t.success).length;
                    message += `   ‚îî‚îÄ ${successfulTests}/${diagnostics.connectivityTests.length} endpoints accesibles\n`;
                }
            }
            
            // DNS and SSL status
            if (!diagnostics.dnsResolution) {
                message += '‚ùå No se puede resolver api.holded.com\n';
                solutions.push('‚Ä¢ Problema de DNS o firewall corporativo');
                solutions.push('‚Ä¢ Contacta a tu administrador de red');
                solutions.push('‚Ä¢ Solicita acceso a api.holded.com en el firewall');
                statusType = 'error';
            } else {
                message += '‚úÖ DNS de Holded OK\n';
                
                if (diagnostics.sslCertificate) {
                    message += '‚úÖ Certificado SSL v√°lido\n';
                } else {
                    message += '‚ö†Ô∏è Problema con certificado SSL\n';
                    solutions.push('‚Ä¢ Verifica la fecha y hora del sistema');
                    solutions.push('‚Ä¢ Contacta al administrador de red sobre certificados SSL');
                }
            }
            
            // Network information
            if (diagnostics.networkType !== 'unknown') {
                message += `üì∂ Tipo de red: ${diagnostics.networkType}\n`;
                
                if (diagnostics.browserInfo.connection) {
                    const conn = diagnostics.browserInfo.connection;
                    if (conn.downlink) {
                        message += `   ‚îî‚îÄ Velocidad: ${conn.downlink} Mbps, Latencia: ${conn.rtt}ms\n`;
                    }
                }
            }
            
            // API Key validation with detailed error analysis
            if (holdedApiKey && holdedApiKey.length > 10) {
                message += '\n**üîë Validaci√≥n de API Key:**\n';
                
                if (diagnostics.apiKeyValid) {
                    message += '‚úÖ API Key v√°lida y funcional\n';
                    
                    if (diagnostics.apiResponse) {
                        if (diagnostics.apiResponse.hasData) {
                            message += `   ‚îî‚îÄ ${diagnostics.apiResponse.dataLength} documentos encontrados\n`;
                        } else {
                            message += '   ‚îî‚îÄ Respuesta v√°lida (sin documentos)\n';
                        }
                    }
                    statusType = 'success';
                } else if (diagnostics.corsIssue) {
                    message += '‚ö†Ô∏è No se puede validar API Key (bloqueado por CORS)\n';
                    statusType = 'error';
                } else if (diagnostics.httpStatus) {
                    message += `‚ùå Error HTTP ${diagnostics.httpStatus}`;
                    
                    switch (diagnostics.httpStatus) {
                        case 401:
                            message += ' - API Key inv√°lida\n';
                            solutions.push('‚Ä¢ Verifica que la API Key sea correcta');
                            solutions.push('‚Ä¢ Regenera la API Key en Holded');
                            break;
                        case 403:
                            message += ' - Sin permisos de acceso\n';
                            solutions.push('‚Ä¢ Aseg√∫rate de que la API Key tenga permisos de "Facturaci√≥n"');
                            solutions.push('‚Ä¢ Verifica los permisos en Holded ‚Üí Configuraci√≥n ‚Üí Integraciones');
                            break;
                        case 429:
                            message += ' - L√≠mite de peticiones excedido\n';
                            solutions.push('‚Ä¢ Espera unos minutos antes de intentar de nuevo');
                            solutions.push('‚Ä¢ Reduce la frecuencia de sincronizaci√≥n');
                            break;
                        case 500:
                        case 502:
                        case 503:
                            message += ' - Error del servidor de Holded\n';
                            solutions.push('‚Ä¢ Problema temporal en los servidores de Holded');
                            solutions.push('‚Ä¢ Intenta de nuevo en unos minutos');
                            break;
                        default:
                            message += ' - Error desconocido\n';
                            if (diagnostics.apiError) {
                                message += `   ‚îî‚îÄ ${diagnostics.apiError}\n`;
                            }
                    }
                    statusType = 'error';
                } else if (diagnostics.apiTimeout) {
                    message += '‚è±Ô∏è Timeout al validar API Key\n';
                    solutions.push('‚Ä¢ La API de Holded est√° respondiendo lentamente');
                    solutions.push('‚Ä¢ Intenta de nuevo en unos minutos');
                    solutions.push('‚Ä¢ Verifica tu conexi√≥n a internet');
                    statusType = 'error';
                } else {
                    message += '‚ùå Error al validar API Key\n';
                    if (diagnostics.apiError) {
                        message += `   ‚îî‚îÄ ${diagnostics.apiError}\n`;
                    }
                    solutions.push('‚Ä¢ Verifica que la API Key sea correcta');
                    solutions.push('‚Ä¢ Aseg√∫rate de que tenga permisos de "Facturaci√≥n"');
                    statusType = 'error';
                }
            } else {
                message += '\n**üîë API Key:**\n';
                message += '‚ö†Ô∏è No se ha proporcionado una API Key v√°lida\n';
                solutions.push('‚Ä¢ Introduce tu API Key de Holded');
                solutions.push('‚Ä¢ Obt√©n la API Key desde Holded ‚Üí Configuraci√≥n ‚Üí Integraciones ‚Üí API');
            }
            
            // CORS issues with enhanced solutions
            if (diagnostics.corsIssue) {
                message += '\n**üö´ Problema CORS Detectado:**\n';
                message += '‚ùå El navegador bloquea las peticiones por pol√≠tica de seguridad\n';
                
                // Browser-specific solutions
                const userAgent = diagnostics.browserInfo.userAgent.toLowerCase();
                if (userAgent.includes('chrome')) {
                    solutions.push('‚Ä¢ **Chrome:** Instala "CORS Unblock" o "CORS Toggle" desde Chrome Web Store');
                    solutions.push('‚Ä¢ **Chrome (avanzado):** Inicia con --disable-web-security --user-data-dir=/tmp/chrome_dev');
                } else if (userAgent.includes('firefox')) {
                    solutions.push('‚Ä¢ **Firefox:** Instala "CORS Everywhere" desde Firefox Add-ons');
                    solutions.push('‚Ä¢ **Firefox (avanzado):** Cambia security.fileuri.strict_origin_policy a false en about:config');
                } else if (userAgent.includes('safari')) {
                    solutions.push('‚Ä¢ **Safari:** Habilita "Desarrollador" ‚Üí "Deshabilitar pol√≠ticas de origen cruzado"');
                } else {
                    solutions.push('‚Ä¢ **Soluci√≥n universal:** Instala extensi√≥n para deshabilitar CORS');
                }
                
                solutions.push('‚Ä¢ **Soluci√≥n t√©cnica:** Usa un servidor web local (python -m http.server)');
                solutions.push('‚Ä¢ **Alternativa:** Configura un proxy CORS (cors-anywhere)');
                statusType = 'error';
            }
            
            // Firewall issues
            if (diagnostics.firewallBlocked) {
                message += '\n**üî• Firewall Corporativo:**\n';
                message += '‚ùå Posible bloqueo por firewall de empresa\n';
                solutions.push('‚Ä¢ Contacta al administrador de red de tu empresa');
                solutions.push('‚Ä¢ Solicita acceso a api.holded.com (puerto 443)');
                solutions.push('‚Ä¢ Pide que agreguen *.holded.com a la lista blanca');
                solutions.push('‚Ä¢ Verifica si hay proxy corporativo configurado');
                statusType = 'error';
            }
            
            // Enhanced technical information
            technicalInfo.push(`‚Ä¢ Navegador: ${diagnostics.browserInfo.userAgent.split(' ')[0]} (${diagnostics.browserInfo.vendor})`);
            technicalInfo.push(`‚Ä¢ Plataforma: ${diagnostics.browserInfo.platform}`);
            technicalInfo.push(`‚Ä¢ Cookies habilitadas: ${diagnostics.browserInfo.cookiesEnabled ? 'S√≠' : 'No'}`);
            technicalInfo.push(`‚Ä¢ Estado de red: ${diagnostics.browserInfo.onLine ? 'Conectado' : 'Desconectado'}`);
            technicalInfo.push(`‚Ä¢ Idioma: ${diagnostics.browserInfo.language}`);
            
            if (diagnostics.networkType !== 'unknown') {
                technicalInfo.push(`‚Ä¢ Tipo de conexi√≥n: ${diagnostics.networkType}`);
            }
            
            if (diagnostics.httpStatus) {
                technicalInfo.push(`‚Ä¢ √öltimo c√≥digo HTTP: ${diagnostics.httpStatus}`);
            }
            
            technicalInfo.push(`‚Ä¢ Timestamp: ${new Date().toLocaleString('es-ES')}`);
            
            // Add solutions if any
            if (solutions.length > 0) {
                message += '\n**üí° Soluciones Recomendadas:**\n' + solutions.join('\n');
            }
            
            // Success case
            if (diagnostics.apiKeyValid && !diagnostics.corsIssue) {
                message += '\n**üéâ ¬°Conexi√≥n Exitosa!**\n';
                message += '‚úÖ Todo funciona correctamente. La sincronizaci√≥n autom√°tica est√° lista.\n';
                
                if (diagnostics.apiResponse && diagnostics.apiResponse.dataLength > 0) {
                    message += `‚úÖ Se pueden acceder a ${diagnostics.apiResponse.dataLength} documentos en Holded.\n`;
                }
                statusType = 'success';
            }
            
            // Always show alternatives
            message += '\n**üîÑ Alternativas Mientras se Resuelve:**\n';
            message += '‚Ä¢ Marcar facturas manualmente en el sistema\n';
            message += '‚Ä¢ Usar la sincronizaci√≥n cuando se resuelva el problema\n';
            message += '‚Ä¢ Exportar datos y trabajar offline temporalmente\n';
            message += '‚Ä¢ Contactar soporte t√©cnico si persiste el error\n';
            
            // Technical info for support
            message += '\n**üîß Informaci√≥n T√©cnica (para soporte):**\n' + technicalInfo.join('\n');
            
            // Connectivity test details (if available)
            if (diagnostics.connectivityTests && diagnostics.connectivityTests.length > 0) {
                message += '\n**üåê Detalles de Conectividad:**\n';
                diagnostics.connectivityTests.forEach(test => {
                    const domain = test.endpoint.replace('https://', '').split('/')[0];
                    if (test.success) {
                        message += `   ‚úÖ ${domain} (${test.responseTime}ms)\n`;
                    } else {
                        message += `   ‚ùå ${domain} (${test.error || 'Error'})\n`;
                    }
                });
            }
            
            showHoldedStatus(statusType, message);
        }

        // Show specific diagnostics based on error type
        function showHoldedDiagnostics(errorType) {
            let message = '';
            
            switch (errorType) {
                case 'timeout':
                    message = `üîç **Diagn√≥stico - Tiempo Agotado:**

**Posibles causas:**
‚Ä¢ Conexi√≥n lenta a internet
‚Ä¢ Sobrecarga en los servidores de Holded
‚Ä¢ Firewall que ralentiza las conexiones

**Soluciones:**
‚Ä¢ Intenta de nuevo en unos minutos
‚Ä¢ Verifica la velocidad de tu conexi√≥n
‚Ä¢ Contacta a Holded si el problema persiste`;
                    break;
                    
                case 'cors':
                    message = `üîç **Diagn√≥stico - Error CORS:**

**¬øQu√© es CORS?**
Cross-Origin Resource Sharing - Pol√≠tica de seguridad del navegador

**Soluciones inmediatas:**
‚Ä¢ Instalar extensi√≥n "CORS Unblock" en Chrome/Firefox
‚Ä¢ Usar navegador con CORS deshabilitado temporalmente
‚Ä¢ Acceder desde un servidor web (no abrir archivo directamente)

**Soluci√≥n permanente:**
‚Ä¢ Configurar un proxy CORS en tu servidor
‚Ä¢ Usar la API desde el backend en lugar del frontend`;
                    break;
                    
                case 'unknown':
                    message = `üîç **Diagn√≥stico - Error Desconocido:**

**Pasos de resoluci√≥n:**
1. Verifica que la API Key sea correcta
2. Comprueba tu conexi√≥n a internet
3. Intenta desde otro navegador
4. Verifica que Holded est√© operativo
5. Contacta soporte t√©cnico si persiste

**Informaci√≥n para soporte:**
‚Ä¢ Navegador: ${navigator.userAgent}
‚Ä¢ Fecha/Hora: ${new Date().toLocaleString()}
‚Ä¢ URL: ${window.location.href}`;
                    break;
            }
            
            if (message) {
                setTimeout(() => {
                    const currentStatus = document.getElementById('holded-connection-status').textContent;
                    showHoldedStatus('error', currentStatus + '\n\n' + message);
                }, 1000);
            }
        }

        function saveHoldedConfig() {
            const apiKey = document.getElementById('holded-api-key').value;
            const syncEnabled = document.getElementById('holded-sync-enabled').checked;
            
            if (!apiKey) {
                showHoldedStatus('error', 'Por favor, introduce la API Key de Holded');
                return;
            }
            
            // Validate and clean API key
            const cleanApiKey = apiKey.trim().replace(/[^\x00-\xFF]/g, '');
            
            if (cleanApiKey !== apiKey.trim()) {
                showHoldedStatus('error', '‚ùå La API Key contiene caracteres no v√°lidos. Verifica que est√© copiada correctamente.');
                return;
            }
            
            if (cleanApiKey.length < 10) {
                showHoldedStatus('error', '‚ùå La API Key parece demasiado corta. Verifica que est√© completa.');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('holded-api-key', cleanApiKey);
            localStorage.setItem('holded-sync-enabled', syncEnabled);
            
            // Update global variables
            holdedApiKey = cleanApiKey;
            holdedSyncEnabled = syncEnabled;
            
            // Update the input field with the cleaned key
            document.getElementById('holded-api-key').value = cleanApiKey;
            
            // Start or stop sync interval
            if (syncEnabled) {
                startHoldedSync();
                showHoldedStatus('success', 'üíæ Configuraci√≥n guardada. Sincronizaci√≥n autom√°tica activada.');
            } else {
                stopHoldedSync();
                showHoldedStatus('success', 'üíæ Configuraci√≥n guardada. Sincronizaci√≥n autom√°tica desactivada.');
            }
        }

        function startHoldedSync() {
            if (holdedSyncInterval) {
                clearInterval(holdedSyncInterval);
            }
            
            // Initial sync
            syncWithHolded();
            
            // Set up interval (every 5 minutes)
            holdedSyncInterval = setInterval(() => {
                if (holdedSyncEnabled && holdedApiKey) {
                    syncWithHolded();
                }
            }, 5 * 60 * 1000); // 5 minutes
            
            console.log('üîÑ Holded sync started - checking every 5 minutes');
        }

        function stopHoldedSync() {
            if (holdedSyncInterval) {
                clearInterval(holdedSyncInterval);
                holdedSyncInterval = null;
            }
            console.log('‚èπÔ∏è Holded sync stopped');
        }

        async function syncWithHolded() {
            if (!holdedApiKey || !holdedSyncEnabled) {
                return;
            }
            
            try {
                console.log('üîÑ Starting Holded sync...');
                
                // Get invoices from Holded (only paid ones updated since last sync)
                const invoices = await getHoldedInvoices();
                
                let updatedCount = 0;
                
                for (const invoice of invoices) {
                    const updated = await processHoldedInvoice(invoice);
                    if (updated) updatedCount++;
                }
                
                // Update last sync timestamp
                const now = new Date().toISOString();
                localStorage.setItem('last-holded-sync', now);
                lastHoldedSync = now;
                
                if (updatedCount > 0) {
                    console.log(`‚úÖ Holded sync completed: ${updatedCount} invoices updated`);
                    
                    // Refresh dashboard if visible
                    if (!document.getElementById('main-app').classList.contains('hidden')) {
                        loadDashboard();
                        updateChart();
                    }
                    
                    // Show notification for manual sync
                    if (document.getElementById('holded-connection-status') && !document.getElementById('holded-connection-status').classList.contains('hidden')) {
                        showHoldedStatus('success', `‚úÖ Sincronizaci√≥n completada: ${updatedCount} facturas actualizadas`);
                    }
                } else {
                    console.log('‚úÖ Holded sync completed: No updates needed');
                }
                
            } catch (error) {
                console.error('‚ùå Holded sync error:', error);
                
                if (document.getElementById('holded-connection-status') && !document.getElementById('holded-connection-status').classList.contains('hidden')) {
                    showHoldedStatus('error', `‚ùå Error en sincronizaci√≥n: ${error.message}`);
                }
            }
        }

        async function getHoldedInvoices() {
            try {
                // Get invoices through your Node.js proxy
                const response = await makeHoldedRequest('documents?type=invoice', {
                    method: 'GET',
                    signal: AbortSignal.timeout(15000)
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('API Key inv√°lida o expirada');
                    } else if (response.status === 403) {
                        throw new Error('Sin permisos para acceder a las facturas');
                    } else if (response.status === 429) {
                        throw new Error('L√≠mite de peticiones excedido. Intenta m√°s tarde');
                    } else {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                }
                
                const invoices = await response.json();
                
                // Validate response format
                if (!Array.isArray(invoices)) {
                    throw new Error('Respuesta inv√°lida de la API de Holded');
                }
                
                // Filter for paid invoices updated since last sync
                const lastSync = lastHoldedSync ? new Date(lastHoldedSync) : new Date(Date.now() - 30 * 24 * 60 * 60 * 1000); // 30 days ago if no last sync
                
                return invoices.filter(invoice => {
                    try {
                        const updatedAt = new Date(invoice.updatedAt);
                        const isPaid = invoice.status === 'paid' || (invoice.paidAmount && invoice.totalAmount && invoice.paidAmount >= invoice.totalAmount);
                        return isPaid && updatedAt > lastSync;
                    } catch (e) {
                        console.warn('Error processing invoice:', invoice.id, e);
                        return false;
                    }
                });
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('Tiempo de espera agotado al conectar con el proxy');
                }
                throw error;
            }
        }

        async function processHoldedInvoice(holdedInvoice) {
            try {
                // Extract client name and invoice date from Holded invoice
                const clientName = holdedInvoice.contactName || holdedInvoice.contact?.name;
                const invoiceDate = new Date(holdedInvoice.date);
                const paidDate = holdedInvoice.paidDate ? new Date(holdedInvoice.paidDate) : invoiceDate;
                
                if (!clientName) {
                    console.warn('‚ö†Ô∏è Holded invoice missing client name:', holdedInvoice.id);
                    return false;
                }
                
                // Find matching client in our system (case-insensitive, partial match)
                const matchingClient = findMatchingClient(clientName);
                
                if (!matchingClient) {
                    console.warn(`‚ö†Ô∏è No matching client found for "${clientName}" from Holded invoice ${holdedInvoice.id}`);
                    return false;
                }
                
                // Determine which month/year this invoice corresponds to
                // Use the invoice date to determine the billing period
                const invoiceMonth = invoiceDate.getMonth() + 1;
                const invoiceYear = invoiceDate.getFullYear();
                
                // Find campaigns for this client that match the invoice period
                const matchingCampaigns = campaigns.filter(campaign => {
                    return campaign.clientId === matchingClient.id && 
                           isMonthInCampaignPeriod(invoiceMonth, invoiceYear, campaign);
                });
                
                if (matchingCampaigns.length === 0) {
                    console.warn(`‚ö†Ô∏è No matching campaigns found for client "${clientName}" in ${invoiceMonth}/${invoiceYear}`);
                    return false;
                }
                
                // Mark all matching campaigns as paid for this period
                let updated = false;
                matchingCampaigns.forEach(campaign => {
                    const campaignKey = `${campaign.id}-${invoiceMonth}-${invoiceYear}`;
                    const currentStatus = campaignStatuses[campaignKey] || getMonthStatus(campaign, invoiceMonth, invoiceYear);
                    
                    if (currentStatus !== 'paid') {
                        campaignStatuses[campaignKey] = 'paid';
                        updated = true;
                        console.log(`‚úÖ Marked campaign ${campaign.id} as paid for ${invoiceMonth}/${invoiceYear} (client: ${clientName})`);
                    }
                });
                
                // Auto-sync to Supabase if available
                if (updated) {
                    await autoSyncToSupabase();
                }
                
                return updated;
                
            } catch (error) {
                console.error('‚ùå Error processing Holded invoice:', holdedInvoice.id, error);
                return false;
            }
        }

        function findMatchingClient(holdedClientName) {
            const normalizedHoldedName = normalizeText(holdedClientName);
            
            // First try exact match
            let match = clients.find(client => 
                normalizeText(client.name) === normalizedHoldedName
            );
            
            if (match) return match;
            
            // Then try partial match (Holded name contains our client name or vice versa)
            match = clients.find(client => {
                const normalizedClientName = normalizeText(client.name);
                return normalizedHoldedName.includes(normalizedClientName) || 
                       normalizedClientName.includes(normalizedHoldedName);
            });
            
            if (match) return match;
            
            // Finally try word-by-word match for company names
            const holdedWords = normalizedHoldedName.split(/\s+/).filter(word => word.length > 2);
            match = clients.find(client => {
                const clientWords = normalizeText(client.name).split(/\s+/).filter(word => word.length > 2);
                return holdedWords.some(holdedWord => 
                    clientWords.some(clientWord => 
                        holdedWord.includes(clientWord) || clientWord.includes(holdedWord)
                    )
                );
            });
            
            return match || null;
        }

        function showHoldedStatus(type, message) {
            const statusDiv = document.getElementById('holded-connection-status');
            if (!statusDiv) return;
            
            statusDiv.className = `mt-4 p-3 rounded-lg ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
            
            // Auto-hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Show proxy diagnostics results
        function showProxyDiagnosticsResults(diagnostics) {
            let statusType = 'info';
            let message = 'üîç **Diagn√≥stico del Proxy Node.js**\n\n';
            let solutions = [];
            
            // Internet connection status
            message += '**üì° Estado de Conectividad:**\n';
            if (!diagnostics.internetConnection) {
                message += '‚ùå Sin conexi√≥n a internet\n';
                solutions.push('‚Ä¢ Verifica tu conexi√≥n a internet');
                statusType = 'error';
            } else {
                message += `‚úÖ Conexi√≥n a internet OK (${diagnostics.responseTime}ms)\n`;
            }
            
            // Proxy reachability
            message += '\n**üîó Estado del Proxy:**\n';
            if (!diagnostics.proxyReachable) {
                message += `‚ùå No se puede conectar al proxy (${PROXY_BASE_URL})\n`;
                if (diagnostics.proxyError) {
                    message += `   ‚îî‚îÄ Error: ${diagnostics.proxyError}\n`;
                }
                solutions.push('‚Ä¢ Verifica que tu proxy Node.js est√© funcionando');
                solutions.push('‚Ä¢ Comprueba que https://holded-proxy.onrender.com est√© accesible');
                solutions.push('‚Ä¢ Revisa los logs del servidor proxy');
                statusType = 'error';
            } else {
                message += `‚úÖ Proxy accesible (${diagnostics.proxyResponseTime}ms)\n`;
            }
            
            // API Key validation
            if (holdedApiKey && holdedApiKey.length > 10) {
                message += '\n**üîë Validaci√≥n de API Key:**\n';
                
                if (diagnostics.apiKeyValid) {
                    message += '‚úÖ API Key v√°lida y funcional\n';
                    
                    if (diagnostics.apiResponse && diagnostics.apiResponse.hasData) {
                        message += `   ‚îî‚îÄ ${diagnostics.apiResponse.dataLength} documentos encontrados\n`;
                    }
                    statusType = 'success';
                } else if (diagnostics.httpStatus) {
                    message += `‚ùå Error HTTP ${diagnostics.httpStatus}\n`;
                    
                    switch (diagnostics.httpStatus) {
                        case 401:
                            message += '   ‚îî‚îÄ API Key inv√°lida\n';
                            solutions.push('‚Ä¢ Verifica que la API Key sea correcta');
                            solutions.push('‚Ä¢ Regenera la API Key en Holded');
                            break;
                        case 403:
                            message += '   ‚îî‚îÄ Sin permisos de acceso\n';
                            solutions.push('‚Ä¢ Aseg√∫rate de que la API Key tenga permisos de "Facturaci√≥n"');
                            break;
                        case 429:
                            message += '   ‚îî‚îÄ L√≠mite de peticiones excedido\n';
                            solutions.push('‚Ä¢ Espera unos minutos antes de intentar de nuevo');
                            break;
                        default:
                            if (diagnostics.apiError) {
                                message += `   ‚îî‚îÄ ${diagnostics.apiError}\n`;
                            }
                    }
                    statusType = 'error';
                } else if (diagnostics.apiTimeout) {
                    message += '‚è±Ô∏è Timeout al validar API Key\n';
                    solutions.push('‚Ä¢ El proxy est√° respondiendo lentamente');
                    solutions.push('‚Ä¢ Verifica la conexi√≥n del proxy con Holded');
                    statusType = 'error';
                } else {
                    message += '‚ùå Error al validar API Key\n';
                    if (diagnostics.apiError) {
                        message += `   ‚îî‚îÄ ${diagnostics.apiError}\n`;
                    }
                    statusType = 'error';
                }
            }
            
            // Network info
            if (diagnostics.networkType !== 'unknown') {
                message += `\n**üì∂ Informaci√≥n de Red:**\n`;
                message += `‚Ä¢ Tipo de conexi√≥n: ${diagnostics.networkType}\n`;
                
                if (diagnostics.browserInfo.connection) {
                    const conn = diagnostics.browserInfo.connection;
                    if (conn.downlink) {
                        message += `‚Ä¢ Velocidad: ${conn.downlink} Mbps, Latencia: ${conn.rtt}ms\n`;
                    }
                }
            }
            
            // Add solutions if any
            if (solutions.length > 0) {
                message += '\n**üí° Soluciones Recomendadas:**\n' + solutions.join('\n');
            }
            
            // Success case
            if (diagnostics.apiKeyValid && diagnostics.proxyReachable) {
                message += '\n**üéâ ¬°Conexi√≥n Exitosa!**\n';
                message += '‚úÖ El proxy Node.js funciona correctamente y puede acceder a Holded.\n';
                statusType = 'success';
            }
            
            // Technical info
            message += '\n**üîß Informaci√≥n T√©cnica:**\n';
            message += `‚Ä¢ Navegador: ${diagnostics.browserInfo.userAgent.split(' ')[0]}\n`;
            message += `‚Ä¢ Plataforma: ${diagnostics.browserInfo.platform}\n`;
            message += `‚Ä¢ Proxy URL: ${PROXY_BASE_URL}\n`;
            message += `‚Ä¢ Timestamp: ${new Date().toLocaleString('es-ES')}\n`;
            
            showHoldedStatus(statusType, message);
        }



        function loadHoldedConfig() {
            const apiKeyField = document.getElementById('holded-api-key');
            const syncEnabledField = document.getElementById('holded-sync-enabled');
            const lastSyncField = document.getElementById('holded-last-sync');
            
            if (apiKeyField) {
                apiKeyField.value = holdedApiKey;
            }
            if (syncEnabledField) {
                syncEnabledField.checked = holdedSyncEnabled;
            }
            if (lastSyncField && lastHoldedSync) {
                const lastSyncDate = new Date(lastHoldedSync);
                lastSyncField.textContent = lastSyncDate.toLocaleString('es-ES');
            }
        }

        // Fallback copy function
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showConnectionStatus('success', 'üìã SQL copiado al portapapeles');
                } else {
                    showConnectionStatus('error', 'No se pudo copiar el SQL. Selecciona y copia manualmente.');
                }
            } catch (err) {
                showConnectionStatus('error', 'No se pudo copiar el SQL. Selecciona y copia manualmente.');
            }
            
            document.body.removeChild(textArea);
        }

        // Load saved Supabase configuration on page load
        function loadSupabaseConfig() {
            const urlField = document.getElementById('supabase-url');
            const keyField = document.getElementById('supabase-key');
            
            if (urlField) {
                urlField.value = SUPABASE_URL;
            }
            if (keyField) {
                keyField.value = SUPABASE_KEY;
            }
        }

        // Initialize with only real data
        let clients = [
            { 
                id: 1, 
                name: "Acanto", 
                emisora: "Talavera", 
                agentId: 1,
                // Billing information
                companyName: "Acanto S.L.",
                cif: "B12345678",
                address: "Calle Principal 123",
                city: "Talavera de la Reina",
                postalCode: "45600",
                email: "facturacion@acanto.com",
                paymentMethod: "transfer", // transfer, card, cash
                taxRate: 21 // IVA percentage
            }
        ];

        // Billing system data structures
        let invoices = []; // Generated invoices
        let quotes = []; // Generated quotes
        let invoiceTemplates = []; // Email templates
        let billingSettings = {
            companyInfo: {
                name: "KISS FM",
                cif: "B87654321",
                address: "Avenida Radio 456",
                city: "Madrid",
                postalCode: "28001",
                phone: "+34 91 123 4567",
                email: "facturacion@kissfm.com",
                website: "www.kissfm.com"
            },
            invoiceCounter: 1,
            quoteCounter: 1,
            defaultTaxRate: 21,
            defaultPaymentTerms: 30
        };

        // Function to ensure only real data is loaded
        function loadSampleData() {
            console.log('üìä Loading real data only...');
            
            // Only real data - no sample data
            clients = [
                { 
                    id: 1, 
                    name: "Acanto", 
                    emisora: "Talavera", 
                    agentId: 1,
                    // Billing information
                    companyName: "Acanto S.L.",
                    cif: "B12345678",
                    address: "Calle Principal 123",
                    city: "Talavera de la Reina",
                    postalCode: "45600",
                    email: "facturacion@acanto.com",
                    paymentMethod: "transfer",
                    taxRate: 21
                }
            ];
            
            // Sort clients alphabetically
            clients.sort((a, b) => a.name.localeCompare(b.name, 'es', { sensitivity: 'base' }));
            campaigns = [];
            campaignStatuses = {};
            invoices = [];
            quotes = [];

            // Only real agents and emisoras
            agents = [
                { id: 1, name: "Jos√© Fern√°ndez", email: "", phone: "", commissionPolicyId: 1, sales: 0, active: true }
            ];

            emisoras = [
                { id: 1, name: "Talavera", frequency: "Talavera Radio" }
            ];

            commissionPolicies = [
                { 
                    id: 1, 
                    name: "Pol√≠tica B√°sica", 
                    tiers: [
                        { from: 0, to: 5000, percentage: 5 },
                        { from: 5001, to: 10000, percentage: 7 },
                        { from: 10001, to: null, percentage: 10 }
                    ]
                }
            ];

            // Load default email templates
            invoiceTemplates = [
                {
                    id: 1,
                    name: "Presupuesto Pendiente de Pago",
                    type: "quote_pending",
                    subject: "Presupuesto #{number} - {clientName} - {month} {year}",
                    body: `Estimado/a cliente,

Le adjuntamos el presupuesto #{number} correspondiente a los servicios de publicidad en {emisora} para el mes de {month} de {year}.

Importe: {amount}‚Ç¨ + IVA
Total: {totalAmount}‚Ç¨

Una vez realizado el pago, procederemos a emitir la factura correspondiente.

Datos para transferencia:
IBAN: ES12 1234 5678 9012 3456 7890
Concepto: Presupuesto #{number} - {clientName}

Saludos cordiales,
Equipo de KISS FM`
                },
                {
                    id: 2,
                    name: "Factura Pagada",
                    type: "invoice_paid",
                    subject: "Factura #{number} - {clientName} - {month} {year}",
                    body: `Estimado/a cliente,

Le adjuntamos la factura #{number} correspondiente a los servicios de publicidad en {emisora} para el mes de {month} de {year}.

Importe: {amount}‚Ç¨ + IVA
Total: {totalAmount}‚Ç¨

Esta factura ha sido marcada como pagada en nuestro sistema.

Gracias por confiar en KISS FM.

Saludos cordiales,
Equipo de KISS FM`
                }
            ];

            console.log('üìä Real data loaded');
            console.log('üìä Clients:', clients.length);
            console.log('üìä Campaigns:', campaigns.length);
            console.log('üìä Agents:', agents.length);
        }

        // Clear all data and start fresh
        async function clearAllData() {
            const confirmMessage = `¬øEst√°s seguro de que quieres borrar TODOS los datos?

Esta acci√≥n eliminar√°:
‚Ä¢ Todos los clientes
‚Ä¢ Todas las campa√±as
‚Ä¢ Todos los agentes (excepto Jos√© Fern√°ndez)
‚Ä¢ Todas las emisoras (excepto Talavera)
‚Ä¢ Todas las pol√≠ticas de comisi√≥n (excepto la b√°sica)
‚Ä¢ Todos los estados de facturaci√≥n

Esta acci√≥n NO se puede deshacer.`;

            showDeleteConfirmationModal(confirmMessage, async () => {
                try {
                    // Clear all data arrays
                    clients = [];
                    campaigns = [];
                    campaignStatuses = {};
                    agents = [];
                    emisoras = [];
                    commissionPolicies = [];

                    // Load only the minimal real data
                    loadSampleData();

                    // Clear Supabase data if connected
                    if (supabaseClient) {
                        try {
                            // Delete all records from each table
                            await supabaseClient.from('campaign_statuses').delete().neq('id', 0);
                            await supabaseClient.from('campaigns').delete().neq('id', 0);
                            await supabaseClient.from('clients').delete().neq('id', 0);
                            await supabaseClient.from('agents').delete().neq('id', 0);
                            await supabaseClient.from('emisoras').delete().neq('id', 0);
                            await supabaseClient.from('commission_policies').delete().neq('id', 0);

                            // Sync the fresh data to Supabase
                            await syncToSupabase();
                            
                            showConnectionStatus('success', '‚úÖ Todos los datos han sido eliminados y se ha empezado de cero');
                        } catch (error) {
                            console.error('Error clearing Supabase data:', error);
                            showConnectionStatus('error', 'Error al limpiar datos de Supabase: ' + error.message);
                        }
                    }

                    // Refresh all views
                    loadDashboard();
                    loadClients();
                    
                    // Close config modal and show success
                    setTimeout(() => {
                        closeModal();
                        alert('‚úÖ Todos los datos han sido eliminados. El sistema ha empezado de cero con solo los datos b√°sicos.');
                    }, 1000);

                } catch (error) {
                    console.error('Error clearing data:', error);
                    alert('‚ùå Error al limpiar los datos: ' + error.message);
                }
            });
        }

        // Campaigns data structure - Start empty for real data
        let campaigns = [];

        // Current selected invoice for status update
        let currentInvoiceSelection = null;

        // Commission policies data
        let commissionPolicies = [];

        // Emisoras data
        let emisoras = [];

        let agents = [];

        // Tab functionality with memory
        function showTab(tabName) {
            // Save current tab to localStorage
            localStorage.setItem('currentTab', tabName);
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('tab-active', 'text-white');
                tab.classList.add('text-gray-600', 'hover:text-gray-800');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-content').classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTab = document.getElementById('tab-' + tabName);
            activeTab.classList.add('tab-active', 'text-white');
            activeTab.classList.remove('text-gray-600', 'hover:text-gray-800');
            
            // Load content based on tab
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'clients':
                    loadClients();
                    break;
            }
        }

        // Restore last active tab
        function restoreActiveTab() {
            const savedTab = localStorage.getItem('currentTab');
            if (savedTab && ['dashboard', 'clients'].includes(savedTab)) {
                showTab(savedTab);
            } else {
                showTab('dashboard'); // Default to dashboard
            }
        }

        // Billing system functions
        function loadBilling() {
            console.log('üìß Loading billing system...');
            updateBillingStats();
            loadBillingDocuments();
            updateRecurringBillingStats();
        }

        function updateBillingStats() {
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            
            // Count pending quotes
            const pendingQuotes = quotes.filter(q => q.status === 'pending').length;
            document.getElementById('pending-quotes').textContent = pendingQuotes;
            
            // Count issued invoices
            const issuedInvoices = invoices.filter(i => i.status !== 'draft').length;
            document.getElementById('issued-invoices').textContent = issuedInvoices;
            
            // Count overdue invoices
            const overdueInvoices = invoices.filter(i => {
                if (i.status !== 'sent') return false;
                const dueDate = new Date(i.dueDate);
                return dueDate < today;
            }).length;
            document.getElementById('overdue-invoices').textContent = overdueInvoices;
            
            // Calculate monthly revenue (paid invoices this month)
            const monthlyRevenue = invoices
                .filter(i => {
                    if (i.status !== 'paid') return false;
                    const invoiceDate = new Date(i.date);
                    return invoiceDate.getMonth() + 1 === currentMonth && invoiceDate.getFullYear() === currentYear;
                })
                .reduce((sum, i) => sum + i.totalAmount, 0);
            
            document.getElementById('monthly-revenue').textContent = formatCurrency(monthlyRevenue);
        }

        function loadBillingDocuments() {
            // Combine quotes and invoices for display
            const allDocuments = [
                ...quotes.map(q => ({ ...q, type: 'quote', typeLabel: 'Presupuesto' })),
                ...invoices.map(i => ({ ...i, type: 'invoice', typeLabel: 'Factura' }))
            ];
            
            // Sort by date (most recent first)
            allDocuments.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const documentsHtml = allDocuments.slice(0, 20).map(doc => {
                const client = clients.find(c => c.id === doc.clientId);
                const statusClass = getDocumentStatusClass(doc.status);
                const statusLabel = getDocumentStatusLabel(doc.status);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${doc.type === 'quote' ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800'}">
                                ${doc.typeLabel}
                            </span>
                        </td>
                        <td class="px-4 py-3 font-medium text-gray-900">${doc.number}</td>
                        <td class="px-4 py-3 text-gray-700">${client ? client.name : 'Cliente eliminado'}</td>
                        <td class="px-4 py-3 text-gray-700">${formatDate(doc.date)}</td>
                        <td class="px-4 py-3 text-gray-700 font-semibold">${formatCurrency(doc.totalAmount)}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
                                ${statusLabel}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex space-x-2">
                                <button onclick="viewDocument('${doc.type}', ${doc.id})" class="text-blue-600 hover:text-blue-800 text-sm">Ver</button>
                                <button onclick="downloadDocumentPDF('${doc.type}', ${doc.id})" class="text-green-600 hover:text-green-800 text-sm">PDF</button>
                                ${doc.status === 'pending' ? `<button onclick="sendDocument('${doc.type}', ${doc.id})" class="text-purple-600 hover:text-purple-800 text-sm">Enviar</button>` : ''}
                                ${doc.type === 'quote' && doc.status === 'sent' ? `<button onclick="convertQuoteToInvoice(${doc.id})" class="text-orange-600 hover:text-orange-800 text-sm">‚Üí Factura</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('billing-documents-table').innerHTML = documentsHtml || 
                '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No hay documentos generados</td></tr>';
        }

        function updateRecurringBillingStats() {
            // Count recurring configurations
            const autoQuotes = campaigns.filter(c => c.recurringType === 'quote').length;
            const autoInvoices = campaigns.filter(c => c.recurringType === 'invoice').length;
            
            document.getElementById('auto-quotes').textContent = autoQuotes;
            document.getElementById('auto-invoices').textContent = autoInvoices;
            
            // Calculate next execution date (first day of next month)
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            nextMonth.setDate(1);
            
            document.getElementById('next-execution').textContent = formatDate(nextMonth);
        }

        function getDocumentStatusClass(status) {
            switch(status) {
                case 'pending': return 'bg-gray-100 text-gray-800';
                case 'sent': return 'bg-blue-100 text-blue-800';
                case 'paid': return 'bg-green-100 text-green-800';
                case 'overdue': return 'bg-red-100 text-red-800';
                case 'draft': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getDocumentStatusLabel(status) {
            switch(status) {
                case 'pending': return 'Pendiente';
                case 'sent': return 'Enviado';
                case 'paid': return 'Pagado';
                case 'overdue': return 'Vencido';
                case 'draft': return 'Borrador';
                default: return 'Desconocido';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Generate quotes for current month
        function showGenerateQuotesModal() {
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            
            // Find campaigns that should have quotes for current month
            const eligibleCampaigns = campaigns.filter(campaign => {
                return isMonthInCampaignPeriod(currentMonth, currentYear, campaign) &&
                       !quotes.some(q => q.campaignId === campaign.id && q.month === currentMonth && q.year === currentYear);
            });
            
            const campaignsHtml = eligibleCampaigns.map(campaign => {
                const client = clients.find(c => c.id === campaign.clientId);
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="font-medium text-gray-900">${client ? client.name : 'Cliente eliminado'}</p>
                            <p class="text-sm text-gray-600">${campaign.emisora} - ${formatCurrency(campaign.amount)}</p>
                        </div>
                        <input type="checkbox" name="campaign_${campaign.id}" checked class="h-4 w-4 text-blue-600 rounded">
                    </div>
                `;
            }).join('');
            
            const modalContent = `
                <div class="max-w-2xl w-full">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üìã Generar Presupuestos - ${getMonthName(currentMonth)} ${currentYear}</h3>
                    
                    <form onsubmit="generateQuotes(event)" class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <p class="text-sm text-blue-700">
                                Se generar√°n presupuestos para <strong>${eligibleCampaigns.length}</strong> campa√±as activas en ${getMonthName(currentMonth)} ${currentYear}.
                            </p>
                        </div>
                        
                        <div class="max-h-64 overflow-y-auto space-y-2">
                            ${campaignsHtml || '<p class="text-gray-500 text-center py-4">No hay campa√±as elegibles para generar presupuestos</p>'}
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="auto-send-quotes" class="h-4 w-4 text-blue-600 rounded">
                            <label for="auto-send-quotes" class="text-sm text-gray-700">Enviar autom√°ticamente por email</label>
                        </div>
                        
                        <div class="flex space-x-3 pt-4 border-t">
                            <button type="submit" class="flex-1 bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors" ${eligibleCampaigns.length === 0 ? 'disabled' : ''}>
                                Generar Presupuestos
                            </button>
                            <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        async function generateQuotes(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const autoSend = formData.get('auto-send-quotes') === 'on';
            
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            
            let generatedCount = 0;
            
            // Generate quotes for selected campaigns
            campaigns.forEach(campaign => {
                if (formData.get(`campaign_${campaign.id}`) === 'on') {
                    const client = clients.find(c => c.id === campaign.clientId);
                    if (!client) return;
                    
                    const quote = {
                        id: Math.max(...quotes.map(q => q.id), 0) + 1,
                        number: `P${String(billingSettings.quoteCounter).padStart(4, '0')}`,
                        campaignId: campaign.id,
                        clientId: campaign.clientId,
                        date: today.toISOString().split('T')[0],
                        month: currentMonth,
                        year: currentYear,
                        amount: campaign.amount,
                        taxRate: client.taxRate || billingSettings.defaultTaxRate,
                        taxAmount: (campaign.amount * (client.taxRate || billingSettings.defaultTaxRate)) / 100,
                        totalAmount: campaign.amount + ((campaign.amount * (client.taxRate || billingSettings.defaultTaxRate)) / 100),
                        status: autoSend ? 'sent' : 'pending',
                        paymentMethod: client.paymentMethod || 'transfer',
                        dueDate: new Date(today.getTime() + (billingSettings.defaultPaymentTerms * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                        emailSent: autoSend,
                        emailSentDate: autoSend ? today.toISOString() : null
                    };
                    
                    quotes.push(quote);
                    billingSettings.quoteCounter++;
                    generatedCount++;
                    
                    // If auto-send is enabled, simulate email sending
                    if (autoSend) {
                        console.log(`üìß Sending quote ${quote.number} to ${client.email}`);
                    }
                }
            });
            
            // Auto-sync to Supabase if available
            await autoSyncToSupabase();
            
            closeModal();
            loadBilling();
            
            showSuccessToast(`‚úÖ ${generatedCount} presupuestos generados${autoSend ? ' y enviados' : ''} correctamente`);
        }

        // Convert quote to invoice
        async function convertQuoteToInvoice(quoteId) {
            const quote = quotes.find(q => q.id === quoteId);
            if (!quote) return;
            
            const client = clients.find(c => c.id === quote.clientId);
            if (!client) return;
            
            // Create invoice from quote
            const invoice = {
                id: Math.max(...invoices.map(i => i.id), 0) + 1,
                number: `F${String(billingSettings.invoiceCounter).padStart(4, '0')}`,
                quoteId: quote.id,
                campaignId: quote.campaignId,
                clientId: quote.clientId,
                date: new Date().toISOString().split('T')[0],
                month: quote.month,
                year: quote.year,
                amount: quote.amount,
                taxRate: quote.taxRate,
                taxAmount: quote.taxAmount,
                totalAmount: quote.totalAmount,
                status: 'paid', // Mark as paid since quote was paid
                paymentMethod: quote.paymentMethod,
                dueDate: quote.dueDate,
                emailSent: false,
                emailSentDate: null,
                paidDate: new Date().toISOString().split('T')[0]
            };
            
            invoices.push(invoice);
            billingSettings.invoiceCounter++;
            
            // Update quote status
            quote.status = 'converted';
            quote.convertedToInvoice = invoice.id;
            
            // Update campaign status in monthly table
            const campaignKey = `${quote.campaignId}-${quote.month}-${quote.year}`;
            campaignStatuses[campaignKey] = 'paid';
            
            // Auto-sync to Supabase if available
            await autoSyncToSupabase();
            
            loadBilling();
            loadMonthlyBillingTable(); // Refresh monthly table
            loadDashboard(); // Refresh dashboard stats
            
            showSuccessToast(`‚úÖ Presupuesto ${quote.number} convertido a factura ${invoice.number}`);
        }

        // Generate invoices modal
        function showGenerateInvoicesModal() {
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            
            // Find campaigns that should have invoices for current month (already paid quotes or direct invoices)
            const eligibleCampaigns = campaigns.filter(campaign => {
                if (!isMonthInCampaignPeriod(currentMonth, currentYear, campaign)) return false;
                
                // Check if there's already an invoice for this campaign/month
                const hasInvoice = invoices.some(i => i.campaignId === campaign.id && i.month === currentMonth && i.year === currentYear);
                if (hasInvoice) return false;
                
                // Check if there's a paid quote that can be converted
                const paidQuote = quotes.find(q => q.campaignId === campaign.id && q.month === currentMonth && q.year === currentYear && q.status === 'sent');
                
                // Check if campaign is marked as paid in monthly table
                const campaignKey = `${campaign.id}-${currentMonth}-${currentYear}`;
                const isPaid = campaignStatuses[campaignKey] === 'paid';
                
                return paidQuote || isPaid;
            });
            
            const campaignsHtml = eligibleCampaigns.map(campaign => {
                const client = clients.find(c => c.id === campaign.clientId);
                const quote = quotes.find(q => q.campaignId === campaign.id && q.month === currentMonth && q.year === currentYear);
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="font-medium text-gray-900">${client ? client.name : 'Cliente eliminado'}</p>
                            <p class="text-sm text-gray-600">${campaign.emisora} - ${formatCurrency(campaign.amount)}</p>
                            ${quote ? `<p class="text-xs text-blue-600">Desde presupuesto ${quote.number}</p>` : '<p class="text-xs text-green-600">Marcado como pagado</p>'}
                        </div>
                        <input type="checkbox" name="campaign_${campaign.id}" checked class="h-4 w-4 text-blue-600 rounded">
                    </div>
                `;
            }).join('');
            
            const modalContent = `
                <div class="max-w-2xl w-full">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üßæ Generar Facturas - ${getMonthName(currentMonth)} ${currentYear}</h3>
                    
                    <form onsubmit="generateInvoices(event)" class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <p class="text-sm text-blue-700">
                                Se generar√°n facturas para <strong>${eligibleCampaigns.length}</strong> campa√±as pagadas en ${getMonthName(currentMonth)} ${currentYear}.
                            </p>
                        </div>
                        
                        <div class="max-h-64 overflow-y-auto space-y-2">
                            ${campaignsHtml || '<p class="text-gray-500 text-center py-4">No hay campa√±as elegibles para generar facturas</p>'}
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="auto-send-invoices" class="h-4 w-4 text-blue-600 rounded">
                            <label for="auto-send-invoices" class="text-sm text-gray-700">Enviar autom√°ticamente por email</label>
                        </div>
                        
                        <div class="flex space-x-3 pt-4 border-t">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors" ${eligibleCampaigns.length === 0 ? 'disabled' : ''}>
                                Generar Facturas
                            </button>
                            <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        async function generateInvoices(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const autoSend = formData.get('auto-send-invoices') === 'on';
            
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            
            let generatedCount = 0;
            
            // Generate invoices for selected campaigns
            campaigns.forEach(campaign => {
                if (formData.get(`campaign_${campaign.id}`) === 'on') {
                    const client = clients.find(c => c.id === campaign.clientId);
                    if (!client) return;
                    
                    const quote = quotes.find(q => q.campaignId === campaign.id && q.month === currentMonth && q.year === currentYear);
                    
                    const invoice = {
                        id: Math.max(...invoices.map(i => i.id), 0) + 1,
                        number: `F${String(billingSettings.invoiceCounter).padStart(4, '0')}`,
                        quoteId: quote ? quote.id : null,
                        campaignId: campaign.id,
                        clientId: campaign.clientId,
                        date: today.toISOString().split('T')[0],
                        month: currentMonth,
                        year: currentYear,
                        amount: campaign.amount,
                        taxRate: client.taxRate || billingSettings.defaultTaxRate,
                        taxAmount: (campaign.amount * (client.taxRate || billingSettings.defaultTaxRate)) / 100,
                        totalAmount: campaign.amount + ((campaign.amount * (client.taxRate || billingSettings.defaultTaxRate)) / 100),
                        status: 'paid',
                        paymentMethod: client.paymentMethod || 'transfer',
                        dueDate: new Date(today.getTime() + (billingSettings.defaultPaymentTerms * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                        emailSent: autoSend,
                        emailSentDate: autoSend ? today.toISOString() : null,
                        paidDate: today.toISOString().split('T')[0]
                    };
                    
                    invoices.push(invoice);
                    billingSettings.invoiceCounter++;
                    generatedCount++;
                    
                    // Update quote status if exists
                    if (quote) {
                        quote.status = 'converted';
                        quote.convertedToInvoice = invoice.id;
                    }
                    
                    // Ensure campaign status is marked as paid
                    const campaignKey = `${campaign.id}-${currentMonth}-${currentYear}`;
                    campaignStatuses[campaignKey] = 'paid';
                    
                    // If auto-send is enabled, simulate email sending
                    if (autoSend) {
                        console.log(`üìß Sending invoice ${invoice.number} to ${client.email}`);
                    }
                }
            });
            
            // Auto-sync to Supabase if available
            await autoSyncToSupabase();
            
            closeModal();
            loadBilling();
            loadMonthlyBillingTable(); // Refresh monthly table
            loadDashboard(); // Refresh dashboard stats
            
            showSuccessToast(`‚úÖ ${generatedCount} facturas generadas${autoSend ? ' y enviadas' : ''} correctamente`);
        }

        // Billing settings modal
        function showBillingSettingsModal() {
            const modalContent = `
                <div class="max-w-2xl w-full">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">‚öôÔ∏è Configuraci√≥n de Facturaci√≥n</h3>
                    
                    <form onsubmit="saveBillingSettings(event)" class="space-y-6">
                        <!-- Company Information -->
                        <div>
                            <h4 class="font-medium text-gray-800 mb-3">Informaci√≥n de la Empresa</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la empresa</label>
                                    <input type="text" name="companyName" value="${billingSettings.companyInfo.name}" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">CIF/NIF</label>
                                    <input type="text" name="companyCif" value="${billingSettings.companyInfo.cif}" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Direcci√≥n</label>
                                    <input type="text" name="companyAddress" value="${billingSettings.companyInfo.address}" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ciudad</label>
                                    <input type="text" name="companyCity" value="${billingSettings.companyInfo.city}" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">C√≥digo Postal</label>
                                    <input type="text" name="companyPostalCode" value="${billingSettings.companyInfo.postalCode}" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono</label>
                                    <input type="text" name="companyPhone" value="${billingSettings.companyInfo.phone}" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" name="companyEmail" value="${billingSettings.companyInfo.email}" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Billing Configuration -->
                        <div>
                            <h4 class="font-medium text-gray-800 mb-3">Configuraci√≥n de Facturaci√≥n</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pr√≥ximo n√∫mero de presupuesto</label>
                                    <input type="number" name="quoteCounter" value="${billingSettings.quoteCounter}" min="1" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pr√≥ximo n√∫mero de factura</label>
                                    <input type="number" name="invoiceCounter" value="${billingSettings.invoiceCounter}" min="1" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">IVA por defecto (%)</label>
                                    <input type="number" name="defaultTaxRate" value="${billingSettings.defaultTaxRate}" min="0" max="100" step="0.1" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 pt-4 border-t">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                Guardar Configuraci√≥n
                            </button>
                            <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        async function saveBillingSettings(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            // Update billing settings
            billingSettings.companyInfo = {
                name: formData.get('companyName'),
                cif: formData.get('companyCif'),
                address: formData.get('companyAddress'),
                city: formData.get('companyCity'),
                postalCode: formData.get('companyPostalCode'),
                phone: formData.get('companyPhone'),
                email: formData.get('companyEmail'),
                website: billingSettings.companyInfo.website
            };
            
            billingSettings.quoteCounter = parseInt(formData.get('quoteCounter'));
            billingSettings.invoiceCounter = parseInt(formData.get('invoiceCounter'));
            billingSettings.defaultTaxRate = parseFloat(formData.get('defaultTaxRate'));
            
            // Auto-sync to Supabase if available
            await autoSyncToSupabase();
            
            closeModal();
            showSuccessToast('‚úÖ Configuraci√≥n de facturaci√≥n guardada correctamente');
        }

        // Email templates modal
        function showEmailTemplatesModal() {
            const templatesHtml = invoiceTemplates.map(template => `
                <div class="border border-gray-200 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h5 class="font-medium text-gray-800">${template.name}</h5>
                            <p class="text-sm text-gray-600">${template.type === 'quote_pending' ? 'Presupuesto pendiente' : 'Factura pagada'}</p>
                        </div>
                        <button onclick="editEmailTemplate(${template.id})" class="text-blue-600 hover:text-blue-800 text-sm">
                            Editar
                        </button>
                    </div>
                    <div class="bg-gray-50 rounded p-3">
                        <p class="text-sm font-medium text-gray-700 mb-1">Asunto:</p>
                        <p class="text-sm text-gray-600 mb-2">${template.subject}</p>
                        <p class="text-sm font-medium text-gray-700 mb-1">Mensaje:</p>
                        <p class="text-sm text-gray-600 whitespace-pre-line">${template.body.substring(0, 200)}...</p>
                    </div>
                </div>
            `).join('');
            
            const modalContent = `
                <div class="max-w-4xl w-full">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">üìù Plantillas de Email</h3>
                        <button onclick="addEmailTemplate()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            + Nueva Plantilla
                        </button>
                    </div>
                    
                    <div class="max-h-96 overflow-y-auto">
                        ${templatesHtml}
                    </div>
                    
                    <div class="flex justify-end pt-4 border-t mt-4">
                        <button onclick="closeModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-4xl w-full p-6";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        // Placeholder functions for additional features
        function showBulkEmailModal() {
            showSuccessToast('üöß Funci√≥n de env√≠o masivo en desarrollo');
        }

        function showRecurringBillingModal() {
            showSuccessToast('üöß Configuraci√≥n de facturaci√≥n recurrente en desarrollo');
        }

        function filterBillingDocuments() {
            loadBillingDocuments(); // For now, just reload - can add filtering later
        }

        function viewDocument(type, id) {
            showSuccessToast(`üöß Visualizaci√≥n de ${type === 'quote' ? 'presupuesto' : 'factura'} en desarrollo`);
        }

        function downloadDocumentPDF(type, id) {
            showSuccessToast(`üöß Descarga de PDF en desarrollo`);
        }

        function sendDocument(type, id) {
            showSuccessToast(`üöß Env√≠o de ${type === 'quote' ? 'presupuesto' : 'factura'} en desarrollo`);
        }

        function exportBillingData() {
            showSuccessToast('üöß Exportaci√≥n de datos de facturaci√≥n en desarrollo');
        }

        function editEmailTemplate(id) {
            showSuccessToast('üöß Edici√≥n de plantillas de email en desarrollo');
        }

        function addEmailTemplate() {
            showSuccessToast('üöß Creaci√≥n de plantillas de email en desarrollo');
        }

        // Calculate dashboard statistics
        function calculateDashboardStats() {
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            
            let totalFacturado = 0;
            let totalCobrado = 0;
            let deudaVencida = 0;
            let pendiente = 0;
            let planificado = 0;
            let ventasMes = 0;
            
            // Iterate through all campaigns and all historical periods
            campaigns.forEach(campaign => {
                // Check all years from campaign start to end
                for (let year = campaign.startYear; year <= campaign.endYear; year++) {
                    const startMonth = year === campaign.startYear ? campaign.startMonth : 1;
                    const endMonth = year === campaign.endYear ? campaign.endMonth : 12;
                    
                    for (let month = startMonth; month <= endMonth; month++) {
                        if (isMonthInCampaignPeriod(month, year, campaign)) {
                            // Add to total facturado (all scheduled invoices)
                            totalFacturado += campaign.amount;
                            
                            // Get status for this specific month/year
                            const campaignKey = `${campaign.id}-${month}-${year}`;
                            const status = campaignStatuses[campaignKey] || getMonthStatus(campaign, month, year);
                            
                            // Categorize by status
                            switch (status) {
                                case 'paid':
                                    totalCobrado += campaign.amount;
                                    break;
                                case 'pending':
                                    pendiente += campaign.amount;
                                    break;
                                case 'overdue':
                                    deudaVencida += campaign.amount;
                                    break;
                                case 'not_sent':
                                    planificado += campaign.amount;
                                    break;
                            }
                            
                            // Add to current month sales if it's the current month
                            if (month === currentMonth && year === currentYear && status === 'paid') {
                                ventasMes += campaign.amount;
                            }
                        }
                    }
                }
            });
            
            return {
                totalFacturado,
                totalCobrado,
                deudaVencida,
                pendiente,
                planificado,
                ventasMes
            };
        }

        // Load dashboard data
        function loadDashboard() {
            // Calculate and update dashboard statistics
            const stats = calculateDashboardStats();
            
            document.getElementById('total-facturado').textContent = formatCurrency(stats.totalFacturado);
            document.getElementById('total-cobrado').textContent = formatCurrency(stats.totalCobrado);
            document.getElementById('deuda-vencida').textContent = formatCurrency(stats.deudaVencida);
            document.getElementById('pendiente').textContent = formatCurrency(stats.pendiente);
            document.getElementById('planificado').textContent = formatCurrency(stats.planificado);
            document.getElementById('ventas-mes').textContent = formatCurrency(stats.ventasMes);

            // Load monthly billing table
            loadMonthlyBillingTable();

            // Load commissions
            loadCommissions();

            // Load forecast
            loadForecast();
        }

        // Global variables for filtering
        let billingChart = null;
        let forecastChart = null;
        let filteredCampaigns = campaigns;
        let currentConfigTab = 'agents'; // Track current config tab
        
        // Pagination variables
        let currentPage = 1;
        let clientsPerPage = 10;
        let filteredClients = [];

        // Number formatting function for Spanish locale
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-ES', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
                useGrouping: true
            }).format(amount) + ' ‚Ç¨';
        }

        // Load monthly billing table
        function loadMonthlyBillingTable() {
            // Populate agent filter options
            const agentFilterSelect = document.getElementById('agent-filter');
            const chartAgentFilterSelect = document.getElementById('chart-agent-filter');
            
            if (agentFilterSelect) {
                const agentOptions = agents.map(agent => `<option value="${agent.id}">${agent.name}</option>`).join('');
                agentFilterSelect.innerHTML = '<option value="">Todos</option>' + agentOptions;
            }
            
            if (chartAgentFilterSelect) {
                const agentOptions = agents.map(agent => `<option value="${agent.id}">${agent.name}</option>`).join('');
                chartAgentFilterSelect.innerHTML = '<option value="">Todos</option>' + agentOptions;
            }

            // Populate emisora filter options
            const emisoraFilterSelect = document.getElementById('emisora-filter');
            const chartEmisoraFilterSelect = document.getElementById('chart-emisora-filter');
            
            if (emisoraFilterSelect) {
                const emisoraOptions = emisoras.map(emisora => `<option value="${emisora.name}">${emisora.name}</option>`).join('');
                emisoraFilterSelect.innerHTML = '<option value="">Todas</option>' + emisoraOptions;
            }
            
            if (chartEmisoraFilterSelect) {
                const emisoraOptions = emisoras.map(emisora => `<option value="${emisora.name}">${emisora.name}</option>`).join('');
                chartEmisoraFilterSelect.innerHTML = '<option value="">Todas</option>' + emisoraOptions;
            }
            
            // Apply current filters
            applyTableFilters();
        }

        // Apply table filters
        function applyTableFilters() {
            const selectedYear = parseInt(document.getElementById('year-filter').value);
            const clientFilter = document.getElementById('client-filter')?.value || '';
            const emisoraFilter = document.getElementById('emisora-filter')?.value || '';
            const agentFilter = document.getElementById('agent-filter')?.value || '';
            
            // Normalize client filter for accent-insensitive search
            const normalizedClientFilter = normalizeText(clientFilter);
            
            // Filter campaigns based on criteria
            filteredCampaigns = campaigns.filter(campaign => {
                const client = clients.find(c => c.id === campaign.clientId);
                const agent = agents.find(a => a.id === campaign.agentId);
                
                // Year filter
                if (!(campaign.startYear <= selectedYear && campaign.endYear >= selectedYear)) {
                    return false;
                }
                
                // Client name filter - accent insensitive
                if (normalizedClientFilter && !normalizeText(client?.name || '').includes(normalizedClientFilter)) {
                    return false;
                }
                
                // Emisora filter
                if (emisoraFilter && campaign.emisora !== emisoraFilter) {
                    return false;
                }
                
                // Agent filter
                if (agentFilter && campaign.agentId !== parseInt(agentFilter)) {
                    return false;
                }
                
                return true;
            });
            
            // Render filtered table
            renderBillingTable(selectedYear);
        }

        // Clear table filters
        function clearTableFilters() {
            document.getElementById('client-filter').value = '';
            document.getElementById('emisora-filter').value = '';
            document.getElementById('agent-filter').value = '';
            applyTableFilters();
        }

        // Render billing table with filtered data
        function renderBillingTable(selectedYear) {
            // Group campaigns by client to avoid duplicate rows
            const clientCampaigns = {};
            
            filteredCampaigns.forEach(campaign => {
                if (!clientCampaigns[campaign.clientId]) {
                    clientCampaigns[campaign.clientId] = [];
                }
                clientCampaigns[campaign.clientId].push(campaign);
            });
            
            let tableHtml = '';
            let monthlyTotals = new Array(12).fill(0);
            
            // Get client IDs and sort them alphabetically by client name
            const sortedClientIds = Object.keys(clientCampaigns).sort((a, b) => {
                const clientA = clients.find(c => c.id === parseInt(a));
                const clientB = clients.find(c => c.id === parseInt(b));
                if (!clientA || !clientB) return 0;
                return clientA.name.localeCompare(clientB.name, 'es', { sensitivity: 'base' });
            });
            
            // Render one row per client, combining all their campaigns
            sortedClientIds.forEach(clientId => {
                const clientId_num = parseInt(clientId);
                const client = clients.find(c => c.id === clientId_num);
                if (!client) return;
                
                const clientCampaignsList = clientCampaigns[clientId];
                const representativeCampaign = clientCampaignsList[0]; // Use first campaign for client info
                const agent = agents.find(a => a.id === representativeCampaign.agentId);
                
                let rowTotal = 0;
                let monthCells = '';
                let hasAnyActivity = false; // Track if client has any activity in the year
                
                for (let month = 1; month <= 12; month++) {
                    let monthTotal = 0;
                    let hasActiveCampaign = false;
                    let monthStatus = 'not_sent';
                    let representativeCampaignForMonth = null;
                    
                    // Sum all campaigns for this client in this month
                    clientCampaignsList.forEach(campaign => {
                        if (isMonthInCampaignPeriod(month, selectedYear, campaign)) {
                            monthTotal += campaign.amount;
                            hasActiveCampaign = true;
                            hasAnyActivity = true; // Mark that client has activity
                            representativeCampaignForMonth = campaign;
                            
                            // Get status (use the most recent campaign's status logic)
                            const campaignKey = `${campaign.id}-${month}-${selectedYear}`;
                            const status = campaignStatuses[campaignKey] || getMonthStatus(campaign, month, selectedYear);
                            
                            // Prioritize status: paid > pending > overdue > not_sent
                            if (status === 'paid' || monthStatus === 'not_sent') {
                                monthStatus = status;
                            } else if (status === 'pending' && monthStatus !== 'paid') {
                                monthStatus = status;
                            } else if (status === 'overdue' && monthStatus !== 'paid' && monthStatus !== 'pending') {
                                monthStatus = status;
                            }
                        }
                    });
                    
                    if (hasActiveCampaign && monthTotal > 0) {
                        const statusClass = getStatusClass(monthStatus);
                        rowTotal += monthTotal;
                        monthlyTotals[month - 1] += monthTotal;
                        
                        monthCells += `
                            <td class="px-2 py-1 text-center cursor-pointer hover:opacity-80 transition-colors ${statusClass}" 
                                onclick="showInvoiceStatusDropdown(event, ${representativeCampaignForMonth.id}, ${month}, ${selectedYear})">
                                <span class="text-xs font-medium">${formatCurrency(monthTotal)}</span>
                            </td>
                        `;
                    } else {
                        monthCells += `<td class="px-2 py-1 text-center bg-gray-100 text-gray-600">-</td>`;
                    }
                }
                
                // Show row if client has any activity in the selected year (even if total is 0 due to filters)
                if (hasAnyActivity) {
                    tableHtml += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 font-medium text-gray-900 sticky left-0 bg-white text-left">
                                <div class="flex items-center space-x-2">
                                    <button onclick="editCampaign(${representativeCampaign.id})" class="text-blue-600 hover:text-blue-800 p-1" title="Editar campa√±a">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="deleteCampaign(${representativeCampaign.id})" class="text-red-600 hover:text-red-800 p-1" title="Eliminar campa√±a">
                                        ‚úñÔ∏è
                                    </button>
                                    <button onclick="showClientStatsModal(${client.id})" class="text-xs text-blue-600 hover:text-blue-800 underline cursor-pointer">
                                        ${client.name}
                                    </button>
                                </div>
                            </td>
                            <td class="px-4 py-2 text-xs text-gray-700 text-center">${representativeCampaign.emisora}</td>
                            <td class="px-4 py-2 text-xs text-gray-700 text-center">${agent ? agent.name : 'Sin asignar'}</td>
                            ${monthCells}
                            <td class="px-4 py-2 text-center font-semibold text-blue-600 bg-blue-50">${formatCurrency(rowTotal)}</td>
                        </tr>
                    `;
                }
            });
            
            document.getElementById('monthly-billing-table').innerHTML = tableHtml;
            
            // Calculate pending amounts (not paid)
            let monthlyPending = new Array(12).fill(0);
            
            filteredCampaigns.forEach(campaign => {
                for (let month = 1; month <= 12; month++) {
                    if (isMonthInCampaignPeriod(month, selectedYear, campaign)) {
                        const campaignKey = `${campaign.id}-${month}-${selectedYear}`;
                        const status = campaignStatuses[campaignKey] || getMonthStatus(campaign, month, selectedYear);
                        
                        // Add to pending if not paid
                        if (status !== 'paid') {
                            monthlyPending[month - 1] += campaign.amount;
                        }
                    }
                }
            });
            
            // Update totals row
            const totalAmount = monthlyTotals.reduce((sum, total) => sum + total, 0);
            const totalPending = monthlyPending.reduce((sum, total) => sum + total, 0);
            
            const totalsHtml = `
                <tr>
                    <td class="px-4 py-2 text-gray-700 sticky left-0 bg-gray-50 font-semibold">TOTALES</td>
                    <td class="px-4 py-2 bg-gray-50"></td>
                    <td class="px-4 py-2 bg-gray-50"></td>
                    ${monthlyTotals.map(total => `<td class="px-2 py-2 text-center font-semibold bg-gray-50">${formatCurrency(total)}</td>`).join('')}
                    <td class="px-4 py-2 text-center font-bold text-blue-600 bg-blue-100">${formatCurrency(totalAmount)}</td>
                </tr>
            `;
            document.getElementById('monthly-totals').innerHTML = totalsHtml;
            
            // Update pending row
            const pendingHtml = `
                <tr>
                    <td class="px-4 py-2 text-orange-700 sticky left-0 bg-orange-50 font-semibold">PENDIENTE DE COBRO</td>
                    <td class="px-4 py-2 bg-orange-50"></td>
                    <td class="px-4 py-2 bg-orange-50"></td>
                    ${monthlyPending.map(pending => `<td class="px-2 py-2 text-center font-semibold bg-orange-50 text-orange-700">${formatCurrency(pending)}</td>`).join('')}
                    <td class="px-4 py-2 text-center font-bold text-orange-600 bg-orange-100">${formatCurrency(totalPending)}</td>
                </tr>
            `;
            document.getElementById('monthly-pending').innerHTML = pendingHtml;
        }

        // Check if month is within campaign period
        function isMonthInCampaignPeriod(month, year, campaign) {
            const startDate = new Date(campaign.startYear, campaign.startMonth - 1, 1);
            const endDate = new Date(campaign.endYear, campaign.endMonth, 0); // Last day of end month
            const checkDate = new Date(year, month - 1, 1);
            
            return checkDate >= startDate && checkDate <= endDate;
        }

        // Get month status based on billing day and due date
        function getMonthStatus(campaign, month, year) {
            const today = new Date();
            const billingDate = new Date(year, month - 1, campaign.billingDay);
            const dueDate = new Date(billingDate);
            dueDate.setDate(dueDate.getDate() + campaign.dueAfterDays);
            
            // Check if there's a manual status override
            const campaignKey = `${campaign.id}-${month}-${year}`;
            if (campaignStatuses[campaignKey]) {
                return campaignStatuses[campaignKey];
            }
            
            // Auto-calculate status based on dates
            if (today < billingDate) {
                return 'not_sent'; // Before billing date
            } else if (today >= billingDate && today <= dueDate) {
                return 'pending'; // Between billing date and due date
            } else {
                return 'overdue'; // After due date
            }
        }

        // Campaign status overrides (manual payments)
        let campaignStatuses = {};

        // Get status class for styling
        function getStatusClass(status) {
            switch(status) {
                case 'paid': return 'bg-green-100 text-green-800';
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'overdue': return 'bg-red-100 text-red-800';
                case 'not_sent': return 'bg-gray-100 text-gray-600';
                default: return 'bg-gray-100 text-gray-600';
            }
        }

        // Get status icon
        function getStatusIcon(status) {
            return ''; // No icons needed anymore
        }

        // Show invoice status dropdown
        function showInvoiceStatusDropdown(event, campaignId, month, year) {
            event.stopPropagation();
            
            const dropdown = document.getElementById('invoice-status-dropdown');
            const rect = event.target.getBoundingClientRect();
            
            // Position dropdown
            dropdown.style.left = rect.left + 'px';
            dropdown.style.top = (rect.bottom + 5) + 'px';
            dropdown.classList.remove('hidden');
            
            // Store current selection
            currentInvoiceSelection = { campaignId, month, year };
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeInvoiceDropdown);
            }, 100);
        }

        // Close invoice dropdown
        function closeInvoiceDropdown() {
            document.getElementById('invoice-status-dropdown').classList.add('hidden');
            document.removeEventListener('click', closeInvoiceDropdown);
        }

        // Update invoice status
        async function updateInvoiceStatus(newStatus) {
            if (!currentInvoiceSelection) return;
            
            const { campaignId, month, year } = currentInvoiceSelection;
            
            // Update the campaign status override
            const campaignKey = `${campaignId}-${month}-${year}`;
            campaignStatuses[campaignKey] = newStatus;
            
            // Auto-sync to Supabase if available
            await autoSyncToSupabase();
            
            // Reload the table
            loadMonthlyBillingTable();
            
            // Update the chart automatically
            updateChart();
            
            // Update dashboard statistics
            loadDashboard();
            
            closeInvoiceDropdown();
            currentInvoiceSelection = null;
        }

        // Configuration modal
        function showConfigModal() {
            const modalContent = `
                <div class="max-w-4xl w-full">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">‚öôÔ∏è Configuraci√≥n del Sistema</h3>
                    
                    <!-- Tabs for configuration sections -->
                    <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg mb-6">
                        <button onclick="showConfigTab('agents')" id="config-tab-agents" class="config-tab-active text-white px-4 py-2 rounded-md font-medium transition-all text-sm">
                            Agentes
                        </button>
                        <button onclick="showConfigTab('emisoras')" id="config-tab-emisoras" class="text-gray-600 hover:text-gray-800 px-4 py-2 rounded-md font-medium transition-all text-sm">
                            Emisoras
                        </button>
                        <button onclick="showConfigTab('policies')" id="config-tab-policies" class="text-gray-600 hover:text-gray-800 px-4 py-2 rounded-md font-medium transition-all text-sm">
                            Pol√≠ticas de Comisi√≥n
                        </button>
                        <button onclick="showConfigTab('holded')" id="config-tab-holded" class="text-gray-600 hover:text-gray-800 px-4 py-2 rounded-md font-medium transition-all text-sm">
                            Holded API
                        </button>
                        <button onclick="showConfigTab('database')" id="config-tab-database" class="text-gray-600 hover:text-gray-800 px-4 py-2 rounded-md font-medium transition-all text-sm">
                            Base de Datos
                        </button>
                    </div>

                    <!-- Agents Configuration -->
                    <div id="config-agents" class="config-section">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-medium text-gray-800">Agentes Comerciales</h4>
                            <button onclick="showAddAgentModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                                + Nuevo Agente
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Pol√≠tica Comisi√≥n</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="agents-config-table" class="divide-y divide-gray-200">
                                    <!-- Agents will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Emisoras Configuration -->
                    <div id="config-emisoras" class="config-section hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-medium text-gray-800">Emisoras</h4>
                            <button onclick="showAddEmisoraModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                                + Nueva Emisora
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Frecuencia</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="emisoras-config-table" class="divide-y divide-gray-200">
                                    <!-- Emisoras will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Commission Policies Configuration -->
                    <div id="config-policies" class="config-section hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-medium text-gray-800">Pol√≠ticas de Comisi√≥n</h4>
                            <button onclick="showAddPolicyModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                                + Nueva Pol√≠tica
                            </button>
                        </div>
                        <div id="policies-config-container">
                            <!-- Policies will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Holded API Configuration -->
                    <div id="config-holded" class="config-section hidden">
                        <div class="mb-6">
                            <h4 class="text-lg font-medium text-gray-800 mb-4">üîó Integraci√≥n con Holded (v√≠a Proxy Node.js)</h4>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                <p class="text-sm text-blue-700">
                                    <strong>‚úÖ Configuraci√≥n de Proxy:</strong> Este sistema est√° configurado para usar tu proxy Node.js en <code>https://holded-proxy.onrender.com</code> para evitar problemas de CORS.
                                </p>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key de Holded</label>
                                    <input type="password" id="holded-api-key" placeholder="Introduce tu API Key de Holded..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">
                                        La API Key se enviar√° a tu proxy Node.js que se encargar√° de comunicarse con Holded
                                    </p>
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="holded-sync-enabled" class="h-4 w-4 text-blue-600 rounded">
                                    <label for="holded-sync-enabled" class="text-sm text-gray-700">Activar sincronizaci√≥n autom√°tica</label>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="testHoldedConnection()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 transition-colors">
                                        üîó Probar Proxy
                                    </button>
                                    <button onclick="runHoldedDiagnostics()" class="bg-orange-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-orange-700 transition-colors">
                                        üîç Diagn√≥stico Proxy
                                    </button>
                                    <button onclick="saveHoldedConfig()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                                        üíæ Guardar Configuraci√≥n
                                    </button>
                                    <button onclick="syncWithHolded()" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700 transition-colors">
                                        üîÑ Sincronizar Ahora
                                    </button>
                                </div>
                                
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-sm text-gray-700 space-y-1">
                                        <div>
                                            <strong>Proxy URL:</strong>
                                            <span class="ml-2 text-gray-600 font-mono">https://holded-proxy.onrender.com</span>
                                        </div>
                                        <div>
                                            <strong>√öltima sincronizaci√≥n:</strong>
                                            <span id="holded-last-sync" class="ml-2 text-gray-600">Nunca</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="holded-connection-status" class="mt-4 p-3 rounded-lg hidden">
                                <!-- Connection status will be shown here -->
                            </div>
                        </div>
                        

                    </div>

                    <!-- Database Configuration -->
                    <div id="config-database" class="config-section hidden">
                        <div class="mb-6">
                            <h4 class="text-lg font-medium text-gray-800 mb-4">Configuraci√≥n de Supabase</h4>
                            

                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">URL del Proyecto</label>
                                    <input type="url" id="supabase-url" placeholder="https://tu-proyecto.supabase.co" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Clave An√≥nima</label>
                                    <input type="password" id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div class="flex space-x-3">
                                    <button onclick="testSupabaseConnection()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 transition-colors">
                                        üîó Probar Conexi√≥n
                                    </button>
                                    <button onclick="saveSupabaseConfig()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                                        üíæ Guardar Configuraci√≥n
                                    </button>
                                    <button onclick="syncToSupabase()" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700 transition-colors">
                                        ‚òÅÔ∏è Sincronizar Datos
                                    </button>
                                </div>
                                <div class="mt-3 space-y-2">
                                    <button onclick="diagnoseSyncIssues()" class="bg-orange-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-orange-700 transition-colors w-full">
                                        üîç Diagnosticar Problemas de Sincronizaci√≥n
                                    </button>
                                    <button onclick="clearAllData()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700 transition-colors w-full">
                                        üóëÔ∏è Borrar Todos los Datos y Empezar de Cero
                                    </button>
                                </div>
                            </div>
                            
                            <div id="connection-status" class="mt-4 p-3 rounded-lg hidden">
                                <!-- Connection status will be shown here -->
                            </div>
                        </div>
                        
                        <div class="border-t pt-6">
                            <h5 class="font-medium text-gray-800 mb-3">üìù SQL para crear las tablas</h5>
                            <div class="bg-gray-900 text-green-400 p-2 rounded-lg text-xs font-mono overflow-x-auto max-h-24 overflow-y-auto">
                                <pre id="sql-script">-- PASO 1: Crear usuario admin en Authentication ‚Üí Users
-- Email: admin@kissfm.com, Password: (tu contrase√±a)

-- PASO 2: Ejecutar este SQL (funciona aunque las tablas ya existan)

-- Tablas (IF NOT EXISTS evita errores)
CREATE TABLE IF NOT EXISTS emisoras (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    frequency VARCHAR(50) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS commission_policies (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    tiers JSONB NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS agents (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    phone VARCHAR(20),
    commission_policy_id INTEGER REFERENCES commission_policies(id),
    sales DECIMAL(10,2) DEFAULT 0,
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS clients (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    emisora VARCHAR(100) NOT NULL,
    agent_id INTEGER REFERENCES agents(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS campaigns (
    id SERIAL PRIMARY KEY,
    client_id INTEGER REFERENCES clients(id) ON DELETE CASCADE,
    emisora VARCHAR(100) NOT NULL,
    agent_id INTEGER REFERENCES agents(id),
    amount DECIMAL(10,2) NOT NULL,
    start_month INTEGER NOT NULL,
    start_year INTEGER NOT NULL,
    end_month INTEGER NOT NULL,
    end_year INTEGER NOT NULL,
    billing_day INTEGER NOT NULL,
    due_after_days INTEGER NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS campaign_statuses (
    id SERIAL PRIMARY KEY,
    campaign_id INTEGER REFERENCES campaigns(id) ON DELETE CASCADE,
    month INTEGER NOT NULL,
    year INTEGER NOT NULL,
    status VARCHAR(20) NOT NULL CHECK (status IN ('paid', 'pending', 'overdue', 'not_sent')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(campaign_id, month, year)
);

-- RLS (siempre ejecutar)
ALTER TABLE emisoras ENABLE ROW LEVEL SECURITY;
ALTER TABLE commission_policies ENABLE ROW LEVEL SECURITY;
ALTER TABLE agents ENABLE ROW LEVEL SECURITY;
ALTER TABLE clients ENABLE ROW LEVEL SECURITY;
ALTER TABLE campaigns ENABLE ROW LEVEL SECURITY;
ALTER TABLE campaign_statuses ENABLE ROW LEVEL SECURITY;

-- Pol√≠ticas (ignora errores si existen)
DO $$ BEGIN
    CREATE POLICY "auth_emisoras" ON emisoras FOR ALL TO authenticated USING (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
    CREATE POLICY "auth_policies" ON commission_policies FOR ALL TO authenticated USING (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
    CREATE POLICY "auth_agents" ON agents FOR ALL TO authenticated USING (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
    CREATE POLICY "auth_clients" ON clients FOR ALL TO authenticated USING (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
    CREATE POLICY "auth_campaigns" ON campaigns FOR ALL TO authenticated USING (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
    CREATE POLICY "auth_statuses" ON campaign_statuses FOR ALL TO authenticated USING (true);
EXCEPTION WHEN duplicate_object THEN NULL; END $$;</pre>
                            </div>
                            <button onclick="copySQL()" class="mt-2 bg-gray-600 text-white px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">
                                üìã Copiar SQL
                            </button>
                        </div>
                    </div>

                    <div class="flex justify-end pt-6 border-t">
                        <button onclick="closeModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            // Show modal with smaller size
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-2xl w-full p-4";
            document.getElementById('modal-overlay').classList.remove('hidden');
            
            // Load initial data
            loadConfigData();
            
            // Load configurations after modal is shown
            setTimeout(() => {
                loadSupabaseConfig();
                loadHoldedConfig();
            }, 100);
        }

        function showConfigTab(tabName) {
            // Track current config tab
            currentConfigTab = tabName;
            
            // Hide all config sections
            document.querySelectorAll('.config-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Remove active class from all config tabs
            document.querySelectorAll('[id^="config-tab-"]').forEach(tab => {
                tab.classList.remove('config-tab-active', 'text-white');
                tab.classList.add('text-gray-600', 'hover:text-gray-800');
            });
            
            // Show selected section
            document.getElementById('config-' + tabName).classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTab = document.getElementById('config-tab-' + tabName);
            activeTab.classList.add('config-tab-active', 'text-white');
            activeTab.classList.remove('text-gray-600', 'hover:text-gray-800');
        }

        function loadConfigData() {
            loadAgentsConfig();
            loadEmisorasConfig();
            loadPoliciesConfig();
        }

        function loadAgentsConfig() {
            const agentsHtml = agents.map(agent => {
                const policy = commissionPolicies.find(p => p.id === agent.commissionPolicyId);
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2 font-medium text-gray-900">${agent.name}</td>
                        <td class="px-4 py-2 text-gray-700">${policy ? policy.name : 'Sin pol√≠tica'}</td>
                        <td class="px-4 py-2">
                            <button onclick="editAgent(${agent.id})" class="text-blue-600 hover:text-blue-800 mr-2 text-sm">Editar</button>
                            <button onclick="deleteAgent(${agent.id})" class="text-red-600 hover:text-red-800 text-sm">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('agents-config-table').innerHTML = agentsHtml;
        }

        function loadEmisorasConfig() {
            const emisorasHtml = emisoras.map(emisora => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-medium text-gray-900">${emisora.name}</td>
                    <td class="px-4 py-2 text-gray-700">${emisora.frequency}</td>
                    <td class="px-4 py-2">
                        <button onclick="editEmisora(${emisora.id})" class="text-blue-600 hover:text-blue-800 mr-2 text-sm">Editar</button>
                        <button onclick="deleteEmisora(${emisora.id})" class="text-red-600 hover:text-red-800 text-sm">Eliminar</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('emisoras-config-table').innerHTML = emisorasHtml;
        }

        function loadPoliciesConfig() {
            const policiesHtml = commissionPolicies.map(policy => {
                const tiersHtml = policy.tiers.map(tier => {
                    const toAmount = tier.to ? `${tier.to.toLocaleString()} ‚Ç¨` : '‚àû';
                    return `
                        <div class="flex justify-between items-center py-1 px-3 bg-gray-50 rounded text-sm">
                            <span>De ${tier.from.toLocaleString()} ‚Ç¨ a ${toAmount}</span>
                            <span class="font-medium text-blue-600">${tier.percentage}%</span>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-start mb-3">
                            <h5 class="font-medium text-gray-800">${policy.name}</h5>
                            <div>
                                <button onclick="editPolicy(${policy.id})" class="text-blue-600 hover:text-blue-800 mr-2 text-sm">Editar</button>
                                <button onclick="deletePolicy(${policy.id})" class="text-red-600 hover:text-red-800 text-sm">Eliminar</button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            ${tiersHtml}
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('policies-config-container').innerHTML = policiesHtml;
        }

        // Agent CRUD functions
        function showAddAgentModal() {
            const policyOptions = commissionPolicies.map(policy => `<option value="${policy.id}">${policy.name}</option>`).join('');
            
            const modalContent = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Nuevo Agente</h3>
                <form onsubmit="addAgent(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre completo</label>
                        <input type="text" name="name" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pol√≠tica de comisi√≥n</label>
                        <select name="commissionPolicyId" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Seleccionar pol√≠tica...</option>
                            ${policyOptions}
                        </select>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Guardar Agente
                        </button>
                        <button type="button" onclick="showConfigModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Cancelar
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-sm w-full p-6";
        }

        async function addAgent(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const newAgent = {
                id: Math.max(...agents.map(a => a.id)) + 1,
                name: formData.get('name'),
                email: '',
                phone: '',
                commissionPolicyId: parseInt(formData.get('commissionPolicyId')),
                sales: 0,
                active: true
            };
            agents.push(newAgent);
            
            // Auto-sync to Supabase if available
            await autoSyncToSupabase();
            
            showConfigModal();
        }

        function editAgent(agentId) {
            const agent = agents.find(a => a.id === agentId);
            if (!agent) return;
            
            const policyOptions = commissionPolicies.map(policy => 
                `<option value="${policy.id}" ${policy.id === agent.commissionPolicyId ? 'selected' : ''}>${policy.name}</option>`
            ).join('');
            
            const modalContent = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Editar Agente</h3>
                <form onsubmit="updateAgent(event, ${agentId})" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre completo</label>
                        <input type="text" name="name" value="${agent.name}" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pol√≠tica de comisi√≥n</label>
                        <select name="commissionPolicyId" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Seleccionar pol√≠tica...</option>
                            ${policyOptions}
                        </select>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Actualizar Agente
                        </button>
                        <button type="button" onclick="showConfigModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Cancelar
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-sm w-full p-6";
        }

        async function updateAgent(event, agentId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const agentIndex = agents.findIndex(a => a.id === agentId);
            
            if (agentIndex !== -1) {
                agents[agentIndex] = {
                    ...agents[agentIndex],
                    name: formData.get('name'),
                    commissionPolicyId: parseInt(formData.get('commissionPolicyId'))
                };
                
                // Auto-sync to Supabase if available
                await autoSyncToSupabase();
            }
            showConfigModal();
        }

        function deleteAgent(agentId) {
            const agent = agents.find(a => a.id === agentId);
            if (!agent) return;
            
            // Check if agent has clients or campaigns
            const hasClients = clients.some(c => c.agentId === agentId);
            const hasCampaigns = campaigns.some(c => c.agentId === agentId);
            
            let confirmMessage = `¬øEst√° seguro de eliminar el agente "${agent.name}"?`;
            if (hasClients || hasCampaigns) {
                confirmMessage += `\n\nEste agente tiene clientes o campa√±as asignadas que tambi√©n se eliminar√°n.`;
            }
            
            showDeleteConfirmationModal(confirmMessage, async () => {
                // Remove agent
                agents = agents.filter(a => a.id !== agentId);
                
                // Remove clients assigned to this agent
                clients = clients.filter(c => c.agentId !== agentId);
                
                // Remove campaigns assigned to this agent
                campaigns = campaigns.filter(c => c.agentId !== agentId);
                
                // Clean up campaign statuses
                Object.keys(campaignStatuses).forEach(key => {
                    const campaignId = parseInt(key.split('-')[0]);
                    const campaign = campaigns.find(c => c.id === campaignId);
                    if (!campaign) {
                        delete campaignStatuses[key];
                    }
                });
                
                // Auto-sync to Supabase if available
                await autoSyncToSupabase();
                
                // Reload configuration modal with agents tab
                setTimeout(() => {
                    showConfigModal();
                    showConfigTab('agents');
                }, 100);
                
                // Refresh other data
                loadMonthlyBillingTable();
                loadDashboard();
            });
        }

        // Emisora CRUD functions
        function showAddEmisoraModal() {
            const modalContent = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Nueva Emisora</h3>
                <form onsubmit="addEmisora(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la emisora</label>
                        <input type="text" name="name" placeholder="Ej: FM 101.5" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Frecuencia</label>
                        <input type="text" name="frequency" placeholder="Ej: 101.5 FM" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Guardar Emisora
                        </button>
                        <button type="button" onclick="showConfigModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Cancelar
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-md w-full p-6";
        }

        async function addEmisora(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const newEmisora = {
                id: Math.max(...emisoras.map(e => e.id)) + 1,
                name: formData.get('name'),
                frequency: formData.get('frequency')
            };
            emisoras.push(newEmisora);
            
            // Auto-sync to Supabase if available
            await autoSyncToSupabase();
            
            showConfigModal();
            showConfigTab('emisoras');
        }

        function editEmisora(emisoraId) {
            const emisora = emisoras.find(e => e.id === emisoraId);
            if (!emisora) return;
            
            const modalContent = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Editar Emisora</h3>
                <form onsubmit="updateEmisora(event, ${emisoraId})" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la emisora</label>
                        <input type="text" name="name" value="${emisora.name}" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Frecuencia</label>
                        <input type="text" name="frequency" value="${emisora.frequency}" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Actualizar Emisora
                        </button>
                        <button type="button" onclick="showConfigModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Cancelar
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-md w-full p-6";
        }

        async function updateEmisora(event, emisoraId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const emisoraIndex = emisoras.findIndex(e => e.id === emisoraId);
            
            if (emisoraIndex !== -1) {
                const oldName = emisoras[emisoraIndex].name;
                const newName = formData.get('name');
                
                emisoras[emisoraIndex] = {
                    ...emisoras[emisoraIndex],
                    name: newName,
                    frequency: formData.get('frequency')
                };
                
                // Update clients and campaigns that use this emisora
                clients.forEach(client => {
                    if (client.emisora === oldName) {
                        client.emisora = newName;
                    }
                });
                
                campaigns.forEach(campaign => {
                    if (campaign.emisora === oldName) {
                        campaign.emisora = newName;
                    }
                });
                
                // Auto-sync to Supabase if available
                await autoSyncToSupabase();
            }
            showConfigModal();
            showConfigTab('emisoras');
        }

        function deleteEmisora(emisoraId) {
            const emisora = emisoras.find(e => e.id === emisoraId);
            if (!emisora) return;
            
            // Check if emisora is being used
            const hasClients = clients.some(c => c.emisora === emisora.name);
            const hasCampaigns = campaigns.some(c => c.emisora === emisora.name);
            
            let confirmMessage = `¬øEst√° seguro de eliminar la emisora "${emisora.name}"?`;
            if (hasClients || hasCampaigns) {
                confirmMessage += `\n\nEsta emisora tiene clientes o campa√±as asignadas que tambi√©n se eliminar√°n.`;
            }
            
            showDeleteConfirmationModal(confirmMessage, async () => {
                // Remove emisora
                emisoras = emisoras.filter(e => e.id !== emisoraId);
                
                // Remove clients using this emisora
                clients = clients.filter(c => c.emisora !== emisora.name);
                
                // Remove campaigns using this emisora
                campaigns = campaigns.filter(c => c.emisora !== emisora.name);
                
                // Clean up campaign statuses
                Object.keys(campaignStatuses).forEach(key => {
                    const campaignId = parseInt(key.split('-')[0]);
                    const campaign = campaigns.find(c => c.id === campaignId);
                    if (!campaign) {
                        delete campaignStatuses[key];
                    }
                });
                
                // Auto-sync to Supabase if available
                await autoSyncToSupabase();
                
                // Reload configuration modal with emisoras tab
                setTimeout(() => {
                    showConfigModal();
                    showConfigTab('emisoras');
                }, 100);
                
                // Refresh other data
                loadMonthlyBillingTable();
                loadDashboard();
            });
        }

        // Commission Policy CRUD functions
        function showAddPolicyModal() {
            const modalContent = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Nueva Pol√≠tica de Comisi√≥n</h3>
                <form onsubmit="addPolicy(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la pol√≠tica</label>
                        <input type="text" name="name" placeholder="Ej: Pol√≠tica Premium" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tramos de comisi√≥n</label>
                        <div id="policy-tiers" class="space-y-3">
                            <div class="policy-tier grid grid-cols-3 gap-2 items-end">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Desde (‚Ç¨)</label>
                                    <input type="number" name="tier_from_0" value="0" min="0" required class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Hasta (‚Ç¨) - vac√≠o = ‚àû</label>
                                    <input type="number" name="tier_to_0" min="1" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">% Comisi√≥n</label>
                                    <input type="number" name="tier_percentage_0" min="0" max="100" step="0.1" required class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="addPolicyTier()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm">+ A√±adir tramo</button>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Guardar Pol√≠tica
                        </button>
                        <button type="button" onclick="showConfigModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Cancelar
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-lg w-full p-6";
        }

        let tierCounter = 1;
        function removePolicyTier(button) {
            const tiersContainer = document.getElementById('policy-tiers');
            const totalTiers = tiersContainer.querySelectorAll('.policy-tier').length;
            
            if (totalTiers <= 1) {
                alert('Debe haber al menos un tramo de comisi√≥n.');
                return;
            }
            
            button.closest('.policy-tier').remove();
        }

        function addPolicyTier() {
            const tiersContainer = document.getElementById('policy-tiers');
            const newTier = document.createElement('div');
            newTier.className = 'policy-tier grid grid-cols-7 gap-2 items-end';
            newTier.innerHTML = `
                <div>
                    <label class="block text-xs text-gray-600 mb-1">Mes inicio</label>
                    <select name="period_${tierCounter}_startMonth" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        ${generateMonthOptions(1)}
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">A√±o inicio</label>
                    <input type="number" name="period_${tierCounter}_startYear" value="2024" min="2020" max="2030" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">Mes fin</label>
                    <select name="period_${tierCounter}_endMonth" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        ${generateMonthOptions(12)}
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">A√±o fin</label>
                    <input type="number" name="period_${tierCounter}_endYear" value="2024" min="2020" max="2030" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">Cuota (‚Ç¨)</label>
                    <input type="number" name="period_${tierCounter}_amount" value="0" min="0.01" step="0.01" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">D√≠a facturaci√≥n</label>
                    <input type="number" name="period_${tierCounter}_billingDay" value="1" min="1" max="31" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                </div>
                <div class="flex space-x-1">
                    <div class="flex-1">
                        <label class="block text-xs text-gray-600 mb-1">D√≠as vencimiento</label>
                        <input type="number" name="period_${tierCounter}_dueAfterDays" value="30" min="1" max="90" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    </div>
                    <button type="button" onclick="this.parentElement.parentElement.parentElement.remove()" class="text-red-600 hover:text-red-800 px-2 mt-5">√ó</button>
                </div>
            `;
            tiersContainer.appendChild(newTier);
            tierCounter++;
        }

        async function addPolicy(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            // Collect tiers
            const tiers = [];
            let i = 0;
            while (formData.has(`tier_from_${i}`)) {
                const from = parseInt(formData.get(`tier_from_${i}`));
                const to = formData.get(`tier_to_${i}`) ? parseInt(formData.get(`tier_to_${i}`)) : null;
                const percentage = parseFloat(formData.get(`tier_percentage_${i}`));
                
                tiers.push({ from, to, percentage });
                i++;
            }
            
            const newPolicy = {
                id: Math.max(...commissionPolicies.map(p => p.id)) + 1,
                name: formData.get('name'),
                tiers: tiers
            };
            
            commissionPolicies.push(newPolicy);
            
            // Auto-sync to Supabase if available
            await autoSyncToSupabase();
            
            showConfigModal();
            showConfigTab('policies');
        }

        function editPolicy(policyId) {
            const policy = commissionPolicies.find(p => p.id === policyId);
            if (!policy) return;
            
            const tiersHtml = policy.tiers.map((tier, index) => `
                <div class="policy-tier grid grid-cols-3 gap-2 items-end">
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Desde (‚Ç¨)</label>
                        <input type="number" name="tier_from_${index}" value="${tier.from}" min="0" required class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Hasta (‚Ç¨) - vac√≠o = ‚àû</label>
                        <input type="number" name="tier_to_${index}" value="${tier.to || ''}" min="1" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    </div>
                    <div class="flex space-x-1">
                        <input type="number" name="tier_percentage_${index}" value="${tier.percentage}" min="0" max="100" step="0.1" required class="flex-1 border border-gray-300 rounded px-2 py-1 text-sm">
                        ${index > 0 ? '<button type="button" onclick="removePolicyTier(this)" class="text-red-600 hover:text-red-800 px-2">√ó</button>' : ''}
                    </div>
                </div>
            `).join('');
            
            const modalContent = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Editar Pol√≠tica de Comisi√≥n</h3>
                <form onsubmit="updatePolicy(event, ${policyId})" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la pol√≠tica</label>
                        <input type="text" name="name" value="${policy.name}" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tramos de comisi√≥n</label>
                        <div id="policy-tiers" class="space-y-3">
                            ${tiersHtml}
                        </div>
                        <button type="button" onclick="addPolicyTier()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm">+ A√±adir tramo</button>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Actualizar Pol√≠tica
                        </button>
                        <button type="button" onclick="showConfigModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Cancelar
                        </button>
                    </div>
                </form>
            `;
            
            tierCounter = policy.tiers.length;
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-lg w-full p-6";
        }

        async function updatePolicy(event, policyId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const policyIndex = commissionPolicies.findIndex(p => p.id === policyId);
            
            if (policyIndex !== -1) {
                // Collect tiers
                const tiers = [];
                let i = 0;
                while (formData.has(`tier_from_${i}`)) {
                    const from = parseInt(formData.get(`tier_from_${i}`));
                    const to = formData.get(`tier_to_${i}`) ? parseInt(formData.get(`tier_to_${i}`)) : null;
                    const percentage = parseFloat(formData.get(`tier_percentage_${i}`));
                    
                    tiers.push({ from, to, percentage });
                    i++;
                }
                
                commissionPolicies[policyIndex] = {
                    ...commissionPolicies[policyIndex],
                    name: formData.get('name'),
                    tiers: tiers
                };
                
                // Auto-sync to Supabase if available
                await autoSyncToSupabase();
            }
            showConfigModal();
            showConfigTab('policies');
        }

        function deletePolicy(policyId) {
            const policy = commissionPolicies.find(p => p.id === policyId);
            if (!policy) return;
            
            // Check if policy is being used by agents
            const hasAgents = agents.some(a => a.commissionPolicyId === policyId);
            
            let confirmMessage = `¬øEst√° seguro de eliminar la pol√≠tica "${policy.name}"?`;
            if (hasAgents) {
                confirmMessage += `\n\nEsta pol√≠tica est√° asignada a agentes que perder√°n su pol√≠tica de comisi√≥n.`;
            }
            
            showDeleteConfirmationModal(confirmMessage, async () => {
                // Remove policy
                commissionPolicies = commissionPolicies.filter(p => p.id !== policyId);
                
                // Remove policy assignment from agents
                agents.forEach(agent => {
                    if (agent.commissionPolicyId === policyId) {
                        agent.commissionPolicyId = null;
                    }
                });
                
                // Auto-sync to Supabase if available
                await autoSyncToSupabase();
                
                // Reload configuration modal with policies tab
                setTimeout(() => {
                    showConfigModal();
                    showConfigTab('policies');
                }, 100);
                
                // Refresh other data
                loadDashboard();
            });
        }

        // Filter by year
        function filterByYear(year) {
            applyTableFilters();
            updateChart();
        }

        // Change table year with navigation arrows
        function changeTableYear(direction) {
            const yearFilter = document.getElementById('year-filter');
            const currentYear = parseInt(yearFilter.value);
            const newYear = currentYear + direction;
            
            // Check if the new year is within the available options
            const option = yearFilter.querySelector(`option[value="${newYear}"]`);
            if (option) {
                yearFilter.value = newYear;
                filterByYear(newYear);
            }
        }

        // Change chart year with navigation arrows
        function changeChartYear(direction) {
            const chartYearFilter = document.getElementById('chart-year-filter');
            const currentYear = parseInt(chartYearFilter.value);
            const newYear = currentYear + direction;
            
            // Check if the new year is within the available options
            const option = chartYearFilter.querySelector(`option[value="${newYear}"]`);
            if (option) {
                chartYearFilter.value = newYear;
                updateChart();
            }
        }

        // Initialize and update chart
        function initChart() {
            const ctx = document.getElementById('billing-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (billingChart) {
                billingChart.destroy();
            }
            
            billingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                    datasets: [{
                        label: 'Facturaci√≥n Total',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }, {
                        label: 'Facturas Pagadas',
                        data: [],
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        pointBackgroundColor: 'rgb(34, 197, 94)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('es-ES').format(value) + ' ‚Ç¨';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverRadius: 8
                        }
                    }
                }
            });
            
            updateChart();
        }

        // Update chart with filtered data
        function updateChart() {
            if (!billingChart) return;
            
            const selectedYear = parseInt(document.getElementById('chart-year-filter').value);
            const emisoraFilter = document.getElementById('chart-emisora-filter').value;
            const agentFilter = document.getElementById('chart-agent-filter').value;
            
            // Filter campaigns for chart
            const chartCampaigns = campaigns.filter(campaign => {
                // Year filter
                if (!(campaign.startYear <= selectedYear && campaign.endYear >= selectedYear)) {
                    return false;
                }
                
                // Emisora filter
                if (emisoraFilter && campaign.emisora !== emisoraFilter) {
                    return false;
                }
                
                // Agent filter
                if (agentFilter && campaign.agentId !== parseInt(agentFilter)) {
                    return false;
                }
                
                return true;
            });
            
            // Calculate monthly totals and paid totals
            const monthlyTotals = new Array(12).fill(0);
            const monthlyPaidTotals = new Array(12).fill(0);
            
            chartCampaigns.forEach(campaign => {
                for (let month = 1; month <= 12; month++) {
                    if (isMonthInCampaignPeriod(month, selectedYear, campaign)) {
                        monthlyTotals[month - 1] += campaign.amount;
                        
                        // Check if this month's invoice is paid
                        const campaignKey = `${campaign.id}-${month}-${selectedYear}`;
                        const status = campaignStatuses[campaignKey] || getMonthStatus(campaign, month, selectedYear);
                        
                        if (status === 'paid') {
                            monthlyPaidTotals[month - 1] += campaign.amount;
                        }
                    }
                }
            });
            
            // Update chart data
            billingChart.data.datasets[0].data = monthlyTotals;
            billingChart.data.datasets[1].data = monthlyPaidTotals;
            billingChart.update();
        }

        // Calculate client status based on campaigns
        function getClientStatus(clientId) {
            const today = new Date();
            const currentMonth = today.getMonth() + 1; // JavaScript months are 0-based
            const currentYear = today.getFullYear();
            
            // Find campaigns for this client
            const clientCampaigns = campaigns.filter(c => c.clientId === clientId);
            
            // Check if client has any active or future campaigns
            const hasActiveCampaigns = clientCampaigns.some(campaign => {
                // Check if campaign is active in current month or future
                const campaignEndDate = new Date(campaign.endYear, campaign.endMonth - 1, 31);
                const currentDate = new Date(currentYear, currentMonth - 1, 1);
                
                return campaignEndDate >= currentDate;
            });
            
            return hasActiveCampaigns ? 'Activo' : 'Inactivo';
        }

        // Load clients table
        function loadClients() {
            console.log('üîç DEBUG: Starting loadClients()');
            console.log('üîç DEBUG: Total clients:', clients.length);
            console.log('üîç DEBUG: Clients data:', clients);
            
            // Ensure we have sample data if no data exists
            if (clients.length === 0) {
                console.log('üîç DEBUG: No clients found, loading sample data');
                loadSampleData();
            }
            
            // Populate filter options
            populateClientFilters();
            console.log('üîç DEBUG: Filters populated');
            
            // Apply filters and render table
            applyClientFilters();
            console.log('üîç DEBUG: Filters applied, filtered clients:', filteredClients.length);
            
            // Check if table element exists
            const tableElement = document.getElementById('clients-table');
            console.log('üîç DEBUG: Table element found:', !!tableElement);
            
            if (tableElement) {
                console.log('üîç DEBUG: Table innerHTML length:', tableElement.innerHTML.length);
            }
        }

        // Populate client filter options
        function populateClientFilters() {
            // Populate emisora filter
            const emisoraFilter = document.getElementById('client-emisora-filter');
            if (emisoraFilter) {
                const emisoraOptions = emisoras.map(emisora => `<option value="${emisora.name}">${emisora.name}</option>`).join('');
                emisoraFilter.innerHTML = '<option value="">Todas</option>' + emisoraOptions;
            }
            
            // Populate agent filter
            const agentFilter = document.getElementById('client-agent-filter');
            if (agentFilter) {
                const agentOptions = agents.map(agent => `<option value="${agent.id}">${agent.name}</option>`).join('');
                agentFilter.innerHTML = '<option value="">Todos</option>' + agentOptions;
            }
        }

        // Function to normalize text for accent-insensitive comparison
        function normalizeText(text) {
            return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        // Apply client filters
        function applyClientFilters() {
            const nameFilter = document.getElementById('client-name-filter')?.value || '';
            const emisoraFilter = document.getElementById('client-emisora-filter')?.value || '';
            const agentFilter = document.getElementById('client-agent-filter')?.value || '';
            const statusFilter = document.getElementById('client-status-filter')?.value || '';
            const campaignEndFilter = document.getElementById('client-campaign-end-filter')?.value || '';
            
            console.log('Applying filters:', { nameFilter, emisoraFilter, agentFilter, statusFilter, campaignEndFilter });
            console.log('Total clients before filtering:', clients.length);
            
            // Normalize name filter for accent-insensitive search
            const normalizedNameFilter = normalizeText(nameFilter);
            
            // Filter clients
            filteredClients = clients.filter(client => {
                const agent = agents.find(a => a.id === client.agentId);
                const status = getClientStatus(client.id);
                
                console.log(`Checking client ${client.name}:`, { client, agent, status });
                
                // Name filter - accent insensitive
                if (normalizedNameFilter && !normalizeText(client.name).includes(normalizedNameFilter)) {
                    console.log(`Client ${client.name} filtered out by name`);
                    return false;
                }
                
                // Emisora filter
                if (emisoraFilter && client.emisora !== emisoraFilter) {
                    console.log(`Client ${client.name} filtered out by emisora`);
                    return false;
                }
                
                // Agent filter
                if (agentFilter && client.agentId !== parseInt(agentFilter)) {
                    console.log(`Client ${client.name} filtered out by agent`);
                    return false;
                }
                
                // Status filter
                if (statusFilter && status !== statusFilter) {
                    console.log(`Client ${client.name} filtered out by status`);
                    return false;
                }
                
                // Campaign end filter
                if (campaignEndFilter) {
                    const campaignEndStatus = getClientCampaignEndStatus(client.id);
                    if (campaignEndFilter !== campaignEndStatus) {
                        console.log(`Client ${client.name} filtered out by campaign end`);
                        return false;
                    }
                }
                
                console.log(`Client ${client.name} passed all filters`);
                return true;
            });
            
            console.log('Filtered clients count:', filteredClients.length);
            
            // Reset to first page when filters change
            currentPage = 1;
            
            // Render filtered clients with pagination
            renderClientsTableWithPagination();
        }

        // Clear client filters
        function clearClientFilters() {
            document.getElementById('client-name-filter').value = '';
            document.getElementById('client-emisora-filter').value = '';
            document.getElementById('client-agent-filter').value = '';
            document.getElementById('client-status-filter').value = '';
            document.getElementById('client-campaign-end-filter').value = '';
            applyClientFilters();
        }

        // Render clients table with pagination
        function renderClientsTableWithPagination() {
            console.log('üîç DEBUG: Starting renderClientsTableWithPagination()');
            
            const totalClients = filteredClients.length;
            const totalPages = Math.ceil(totalClients / clientsPerPage);
            const startIndex = (currentPage - 1) * clientsPerPage;
            const endIndex = startIndex + clientsPerPage;
            const clientsToRender = filteredClients.slice(startIndex, endIndex);
            
            console.log('üîç DEBUG: Pagination data:', {
                totalClients,
                totalPages,
                startIndex,
                endIndex,
                clientsToRender: clientsToRender.length,
                currentPage,
                clientsPerPage
            });
            
            if (totalClients === 0) {
                console.log('üîç DEBUG: No clients to render');
                const tableElement = document.getElementById('clients-table');
                if (tableElement) {
                    tableElement.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No se encontraron clientes</td></tr>';
                }
                return;
            }
            
            // Render table rows
            const clientsHtml = clientsToRender.map(client => {
                console.log(`üîç DEBUG: Processing client:`, client);
                
                const agent = agents.find(a => a.id === client.agentId);
                const status = getClientStatus(client.id);
                const campaignEndDate = getClientCampaignEndDate(client.id);
                const totalPaid = getClientTotalPaid(client.id);
                
                console.log(`üîç DEBUG: Client ${client.name} data:`, { agent, status, campaignEndDate, totalPaid });
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <button onclick="showClientStatsModal(${client.id})" class="font-medium text-blue-600 hover:text-blue-800 underline cursor-pointer text-sm">
                                ${client.name}
                            </button>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${client.emisora}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${agent ? agent.name : 'Sin asignar'}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${status === 'Activo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${status}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${campaignEndDate}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 font-semibold text-green-600">${formatCurrency(totalPaid)}</td>
                        <td class="px-6 py-4 text-sm">
                            <button onclick="editClient(${client.id})" class="text-blue-600 hover:text-blue-800 mr-3 cursor-pointer">Editar</button>
                            <button onclick="deleteClient(${client.id})" class="text-red-600 hover:text-red-800 cursor-pointer">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log('üîç DEBUG: Generated HTML length:', clientsHtml.length);
            console.log('üîç DEBUG: First 200 chars of HTML:', clientsHtml.substring(0, 200));
            
            const tableElement = document.getElementById('clients-table');
            if (tableElement) {
                console.log('üîç DEBUG: Setting table innerHTML...');
                tableElement.innerHTML = clientsHtml;
                console.log('üîç DEBUG: Table HTML set successfully, new length:', tableElement.innerHTML.length);
            } else {
                console.error('üîç DEBUG: clients-table element not found!');
            }
            
            // Update pagination info
            const startClient = totalClients > 0 ? startIndex + 1 : 0;
            const endClient = Math.min(endIndex, totalClients);
            const paginationInfo = document.getElementById('clients-pagination-info');
            if (paginationInfo) {
                paginationInfo.innerHTML = `Mostrando ${startClient}-${endClient} de ${totalClients} clientes`;
                console.log('üîç DEBUG: Pagination info updated');
            } else {
                console.error('üîç DEBUG: clients-pagination-info element not found!');
            }
            
            // Render pagination buttons
            renderPaginationButtons(totalPages);
        }

        // Render pagination buttons
        function renderPaginationButtons(totalPages) {
            const paginationContainer = document.getElementById('clients-pagination');
            let paginationHtml = '';
            
            // Previous button
            if (currentPage > 1) {
                paginationHtml += `
                    <button onclick="goToPage(${currentPage - 1})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50">
                        Anterior
                    </button>
                `;
            } else {
                paginationHtml += `
                    <button disabled class="px-3 py-2 text-sm font-medium text-gray-300 bg-gray-100 border border-gray-300 rounded-l-md cursor-not-allowed">
                        Anterior
                    </button>
                `;
            }
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust start page if we're near the end
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // First page and ellipsis
            if (startPage > 1) {
                paginationHtml += `
                    <button onclick="goToPage(1)" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 hover:bg-gray-50">
                        1
                    </button>
                `;
                if (startPage > 2) {
                    paginationHtml += `
                        <span class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300">
                            ...
                        </span>
                    `;
                }
            }
            
            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    paginationHtml += `
                        <button class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600">
                            ${i}
                        </button>
                    `;
                } else {
                    paginationHtml += `
                        <button onclick="goToPage(${i})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 hover:bg-gray-50">
                            ${i}
                        </button>
                    `;
                }
            }
            
            // Last page and ellipsis
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHtml += `
                        <span class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300">
                            ...
                        </span>
                    `;
                }
                paginationHtml += `
                    <button onclick="goToPage(${totalPages})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 hover:bg-gray-50">
                        ${totalPages}
                    </button>
                `;
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationHtml += `
                    <button onclick="goToPage(${currentPage + 1})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50">
                        Siguiente
                    </button>
                `;
            } else {
                paginationHtml += `
                    <button disabled class="px-3 py-2 text-sm font-medium text-gray-300 bg-gray-100 border border-gray-300 rounded-r-md cursor-not-allowed">
                        Siguiente
                    </button>
                `;
            }
            
            paginationContainer.innerHTML = paginationHtml;
        }

        // Go to specific page
        function goToPage(page) {
            currentPage = page;
            renderClientsTableWithPagination();
        }

        // Change clients per page
        function changeClientsPerPage() {
            clientsPerPage = parseInt(document.getElementById('clients-per-page').value);
            currentPage = 1; // Reset to first page
            renderClientsTableWithPagination();
        }

        // Legacy function for compatibility
        function renderClientsTable(clientsToRender) {
            filteredClients = clientsToRender;
            currentPage = 1;
            renderClientsTableWithPagination();
        }

        // Get client campaign end date
        function getClientCampaignEndDate(clientId) {
            const clientCampaigns = campaigns.filter(c => c.clientId === clientId);
            
            if (clientCampaigns.length === 0) {
                return 'Sin campa√±as';
            }
            
            // Find the latest end date among all campaigns
            let latestEndDate = null;
            
            clientCampaigns.forEach(campaign => {
                const campaignEndDate = new Date(campaign.endYear, campaign.endMonth - 1, 31);
                
                if (!latestEndDate || campaignEndDate > latestEndDate) {
                    latestEndDate = campaignEndDate;
                }
            });
            
            if (latestEndDate) {
                const monthName = getMonthName(latestEndDate.getMonth() + 1);
                return `${monthName} ${latestEndDate.getFullYear()}`;
            }
            
            return 'Sin campa√±as';
        }

        // Get client campaign end status (this-month, next-month, or other)
        function getClientCampaignEndStatus(clientId) {
            const clientCampaigns = campaigns.filter(c => c.clientId === clientId);
            
            if (clientCampaigns.length === 0) {
                return 'other';
            }
            
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            const nextMonth = currentMonth === 12 ? 1 : currentMonth + 1;
            const nextMonthYear = currentMonth === 12 ? currentYear + 1 : currentYear;
            
            // Find the latest end date among all campaigns
            let latestEndDate = null;
            
            clientCampaigns.forEach(campaign => {
                const campaignEndDate = new Date(campaign.endYear, campaign.endMonth - 1, 31);
                
                if (!latestEndDate || campaignEndDate > latestEndDate) {
                    latestEndDate = campaignEndDate;
                }
            });
            
            if (latestEndDate) {
                const endMonth = latestEndDate.getMonth() + 1;
                const endYear = latestEndDate.getFullYear();
                
                if (endMonth === currentMonth && endYear === currentYear) {
                    return 'this-month';
                } else if (endMonth === nextMonth && endYear === nextMonthYear) {
                    return 'next-month';
                }
            }
            
            return 'other';
        }

        // Calculate total paid amount for a client
        function getClientTotalPaid(clientId) {
            const clientCampaigns = campaigns.filter(c => c.clientId === clientId);
            let totalPaid = 0;
            
            clientCampaigns.forEach(campaign => {
                for (let year = campaign.startYear; year <= campaign.endYear; year++) {
                    const startMonth = year === campaign.startYear ? campaign.startMonth : 1;
                    const endMonth = year === campaign.endYear ? campaign.endMonth : 12;
                    
                    for (let month = startMonth; month <= endMonth; month++) {
                        if (isMonthInCampaignPeriod(month, year, campaign)) {
                            const campaignKey = `${campaign.id}-${month}-${year}`;
                            const status = campaignStatuses[campaignKey] || getMonthStatus(campaign, month, year);
                            
                            if (status === 'paid') {
                                totalPaid += campaign.amount;
                            }
                        }
                    }
                }
            });
            
            return totalPaid;
        }



        // Modal functions
        function showAddClientModal() {
            const agentOptions = agents.map(agent => `<option value="${agent.id}">${agent.name}</option>`).join('');
            const emisoraOptions = emisoras.map(emisora => `<option value="${emisora.name}">${emisora.name}</option>`).join('');
            
            const modalContent = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Nuevo Cliente</h3>
                <form onsubmit="addClient(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del cliente</label>
                        <input type="text" name="name" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Emisora</label>
                        <select name="emisora" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Seleccionar emisora...</option>
                            ${emisoraOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Agente</label>
                        <select name="agentId" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Seleccionar agente...</option>
                            ${agentOptions}
                        </select>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Guardar Cliente
                        </button>
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Cancelar
                        </button>
                    </div>
                </form>
            `;
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-lg w-full p-6";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }



        function showAddCampaignModal() {
            const clientOptions = clients.map(client => `<option value="${client.id}">${client.name}</option>`).join('');
            const agentOptions = agents.map(agent => `<option value="${agent.id}">${agent.name}</option>`).join('');
            const emisoraOptions = emisoras.map(emisora => `<option value="${emisora.name}">${emisora.name}</option>`).join('');
            
            const modalContent = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Nueva Campa√±a</h3>
                <form onsubmit="addCampaign(event)" class="space-y-5">
                    <!-- Cliente y bot√≥n Nuevo en una sola fila -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                        <div class="flex space-x-2">
                            <select name="clientId" id="campaign-client-select" onchange="updateCampaignClientFields()" required class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Seleccionar cliente...</option>
                                ${clientOptions}
                            </select>
                            <button type="button" onclick="showNewClientInCampaign()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm whitespace-nowrap flex-shrink-0">
                                + Nuevo
                            </button>
                        </div>
                    </div>
                    
                    <!-- Emisora y Agente en fila separada -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Emisora</label>
                            <select name="emisora" id="campaign-emisora-select" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Seleccionar emisora...</option>
                                ${emisoraOptions}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Agente</label>
                            <select name="agentId" id="campaign-agent-select" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Seleccionar agente...</option>
                                ${agentOptions}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Cuota mensual -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cuota mensual (‚Ç¨)</label>
                        <input type="text" name="amount" placeholder="Ej: 1500.00" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="-webkit-appearance: none; -moz-appearance: textfield;">
                    </div>
                    
                    <!-- Fechas de inicio y fin -->
                    <div class="grid grid-cols-4 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mes inicio</label>
                            <select name="startMonth" required class="w-full border border-gray-300 rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">A√±o inicio</label>
                            <select name="startYear" required class="w-full border border-gray-300 rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="2023">2023</option>
                                <option value="2024" selected>2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mes fin</label>
                            <select name="endMonth" required class="w-full border border-gray-300 rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12" selected>Diciembre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">A√±o fin</label>
                            <select name="endYear" required class="w-full border border-gray-300 rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="2023">2023</option>
                                <option value="2024" selected>2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Configuraci√≥n de facturaci√≥n -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">D√≠a de facturaci√≥n</label>
                            <input type="number" name="billingDay" min="1" max="31" value="1" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">D√≠a del mes en que se factura</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">D√≠as para vencimiento</label>
                            <input type="number" name="dueAfterDays" min="1" max="90" value="30" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">D√≠as despu√©s de facturar para vencer</p>
                        </div>
                    </div>
                    
                    <!-- Botones -->
                    <div class="flex space-x-3 pt-4 border-t">
                        <button type="submit" class="flex-1 bg-gradient-to-r from-green-600 to-blue-600 text-white py-2 px-4 rounded-lg hover:shadow-lg transition-all">
                            Crear Campa√±a
                        </button>
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Cancelar
                        </button>
                    </div>
                </form>
            `;
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function showModal(content) {
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-md w-full p-4";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
            modalStack = []; // Clear modal stack when closing
        }

        function showDeleteConfirmationModal(message, onConfirm) {
            // Store the callback function
            window.deleteCallback = onConfirm;
            
            const modalContent = `
                <div class="text-center">
                    <div class="w-12 h-12 mx-auto mb-3 bg-red-100 rounded-full flex items-center justify-center">
                        <span class="text-red-600 text-xl">‚ö†Ô∏è</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Confirmar eliminaci√≥n</h3>
                    <p class="text-gray-600 mb-4 text-sm whitespace-pre-line">${message}</p>
                    <div class="flex space-x-2">
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-3 rounded-lg hover:bg-gray-400 transition-colors text-sm">
                            Cancelar
                        </button>
                        <button onclick="confirmDelete()" class="flex-1 bg-red-600 text-white py-2 px-3 rounded-lg hover:bg-red-700 transition-colors text-sm">
                            Eliminar
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-sm w-full p-4";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function confirmDelete() {
            if (window.deleteCallback) {
                try {
                    window.deleteCallback();
                    window.deleteCallback = null;
                    closeModal();
                } catch (error) {
                    console.error('Error during deletion:', error);
                    closeModal();
                }
            } else {
                closeModal();
            }
        }

        // Update campaign fields when client is selected
        function updateCampaignClientFields() {
            const clientSelect = document.getElementById('campaign-client-select');
            const emisoraSelect = document.getElementById('campaign-emisora-select');
            const agentSelect = document.getElementById('campaign-agent-select');
            
            if (!clientSelect || !emisoraSelect || !agentSelect) return;
            
            const selectedClientId = parseInt(clientSelect.value);
            if (!selectedClientId) return;
            
            const selectedClient = clients.find(c => c.id === selectedClientId);
            if (!selectedClient) return;
            
            // Pre-select emisora
            if (selectedClient.emisora) {
                emisoraSelect.value = selectedClient.emisora;
            }
            
            // Pre-select agent
            if (selectedClient.agentId) {
                agentSelect.value = selectedClient.agentId;
            }
        }

        // Show new client form in separate modal on top
        function showNewClientInCampaign() {
            const agentOptions = agents.map(agent => `<option value="${agent.id}">${agent.name}</option>`).join('');
            const emisoraOptions = emisoras.map(emisora => `<option value="${emisora.name}">${emisora.name}</option>`).join('');
            
            // Create a new modal overlay for the client creation with higher z-index
            const newClientModal = document.createElement('div');
            newClientModal.id = 'new-client-modal-overlay';
            newClientModal.className = 'fixed inset-0 bg-black bg-opacity-60 z-[70]';
            newClientModal.style.zIndex = '70';
            newClientModal.onclick = function(event) {
                if (event.target === this) closeNewClientModal();
            };
            
            newClientModal.innerHTML = `
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 relative z-[71]">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Nuevo Cliente</h3>
                        <form onsubmit="createClientInCampaign(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del cliente</label>
                                <input type="text" id="new-client-name" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Emisora</label>
                                <select id="new-client-emisora" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Seleccionar emisora...</option>
                                    ${emisoraOptions}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Agente</label>
                                <select id="new-client-agent" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Seleccionar agente...</option>
                                    ${agentOptions}
                                </select>
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                    Crear Cliente
                                </button>
                                <button type="button" onclick="closeNewClientModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Add the modal to the page
            document.body.appendChild(newClientModal);
        }

        // Create client within campaign modal
        async function createClientInCampaign(event) {
            if (event) {
                event.preventDefault();
            }
            
            const name = document.getElementById('new-client-name').value.trim();
            const emisora = document.getElementById('new-client-emisora').value;
            const agentId = parseInt(document.getElementById('new-client-agent').value);
            
            if (!name || !emisora || !agentId) {
                alert('Por favor, completa todos los campos del cliente');
                return;
            }
            
            // Create new client
            const newClient = {
                id: Math.max(...clients.map(c => c.id), 0) + 1,
                name: name,
                emisora: emisora,
                agentId: agentId
            };
            
            // Add to clients array
            clients.push(newClient);
            
            // Sort clients alphabetically
            clients.sort((a, b) => a.name.localeCompare(b.name, 'es', { sensitivity: 'base' }));
            
            // Auto-sync to Supabase if available
            await autoSyncToSupabase();
            
            // Update the client select dropdown in the campaign modal
            const clientSelect = document.getElementById('campaign-client-select');
            if (clientSelect) {
                // Add new option to the select
                const newOption = document.createElement('option');
                newOption.value = newClient.id;
                newOption.textContent = newClient.name;
                clientSelect.appendChild(newOption);
                
                // Select the new client
                clientSelect.value = newClient.id;
                
                // Pre-fill emisora and agent in the campaign form
                const emisoraSelect = document.getElementById('campaign-emisora-select');
                const agentSelect = document.getElementById('campaign-agent-select');
                
                if (emisoraSelect) emisoraSelect.value = emisora;
                if (agentSelect) agentSelect.value = agentId;
            }
            
            // Close the new client modal
            closeNewClientModal();
            
            // Show success message
            showSuccessToast(`‚úÖ Cliente "${name}" creado correctamente`);
        }

        // Close new client modal
        function closeNewClientModal() {
            const modal = document.getElementById('new-client-modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // Form submission handlers
        async function addClient(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const newClient = {
                id: Math.max(...clients.map(c => c.id)) + 1,
                name: formData.get('name'),
                emisora: formData.get('emisora'),
                agentId: parseInt(formData.get('agentId'))
            };
            
            // Add to local array
            clients.push(newClient);
            
            // Sort clients alphabetically by name
            clients.sort((a, b) => a.name.localeCompare(b.name, 'es', { sensitivity: 'base' }));
            
            // Auto-sync to Supabase if available
            await autoSyncToSupabase();
            
            closeModal();
            loadClients();
        }

        async function updateClient(event, clientId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const clientIndex = clients.findIndex(c => c.id === clientId);
            
            if (clientIndex !== -1) {
                clients[clientIndex] = {
                    ...clients[clientIndex],
                    name: formData.get('name'),
                    emisora: formData.get('emisora'),
                    agentId: parseInt(formData.get('agentId'))
                };
                
                // Sort clients alphabetically by name after update
                clients.sort((a, b) => a.name.localeCompare(b.name, 'es', { sensitivity: 'base' }));
                
                // Update campaigns that belong to this client
                campaigns.forEach(campaign => {
                    if (campaign.clientId === clientId) {
                        campaign.emisora = formData.get('emisora');
                        campaign.agentId = parseInt(formData.get('agentId'));
                    }
                });
                
                // Auto-sync to Supabase if available
                await autoSyncToSupabase();
                
                closeModal();
                loadClients();
                loadMonthlyBillingTable(); // Refresh billing table to show updated data
            }
        }



        async function addCampaign(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            // Validate and parse amount
            const amountStr = formData.get('amount').replace(',', '.');
            const amount = parseFloat(amountStr);
            
            if (isNaN(amount) || amount <= 0) {
                alert('Por favor, introduce una cuota mensual v√°lida (mayor que 0)');
                return;
            }
            
            const newCampaign = {
                id: Math.max(...campaigns.map(c => c.id), 0) + 1,
                clientId: parseInt(formData.get('clientId')),
                emisora: formData.get('emisora'),
                agentId: parseInt(formData.get('agentId')),
                amount: amount,
                startMonth: parseInt(formData.get('startMonth')),
                startYear: parseInt(formData.get('startYear')),
                endMonth: parseInt(formData.get('endMonth')),
                endYear: parseInt(formData.get('endYear')),
                billingDay: parseInt(formData.get('billingDay')),
                dueAfterDays: parseInt(formData.get('dueAfterDays'))
            };
            
            console.log('üìä Adding new campaign:', newCampaign);
            
            // Add to local array
            campaigns.push(newCampaign);
            
            // Sync to Supabase immediately with feedback
            if (supabaseClient) {
                try {
                    console.log('üìä Syncing campaign to Supabase...');
                    await syncCampaigns();
                    console.log('‚úÖ Campaign synced successfully to Supabase');
                    
                    // Show success message without button
                    showSuccessToast('‚úÖ Campa√±a creada y sincronizada correctamente');
                } catch (error) {
                    console.error('‚ùå Error syncing campaign to Supabase:', error);
                    showSuccessToast('‚ö†Ô∏è Campa√±a creada localmente, error al sincronizar con Supabase');
                }
            } else {
                console.log('üìä No Supabase client available, campaign saved locally only');
                showSuccessToast('‚úÖ Campa√±a creada correctamente');
            }
            
            closeModal();
            loadMonthlyBillingTable();
            loadDashboard();
        }

        function deleteCampaign(campaignId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            
            const client = clients.find(c => c.id === campaign.clientId);
            const clientName = client ? client.name : 'Cliente desconocido';
            
            const confirmMessage = `¬øEst√° seguro de eliminar la campa√±a de "${clientName}"?\n\nEsta acci√≥n eliminar√° todos los registros de facturaci√≥n asociados y no se puede deshacer.`;
            
            showDeleteConfirmationModal(confirmMessage, async () => {
                // Remove campaign
                campaigns = campaigns.filter(c => c.id !== campaignId);
                
                // Remove campaign statuses
                Object.keys(campaignStatuses).forEach(key => {
                    if (key.startsWith(`${campaignId}-`)) {
                        delete campaignStatuses[key];
                    }
                });
                
                // Auto-sync to Supabase if available
                await autoSyncToSupabase();
                
                // Refresh data
                loadMonthlyBillingTable();
                loadDashboard();
                updateChart();
            });
        }

        // Utility functions

        function editClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const agentOptions = agents.map(agent => 
                `<option value="${agent.id}" ${agent.id === client.agentId ? 'selected' : ''}>${agent.name}</option>`
            ).join('');
            
            const emisoraOptions = emisoras.map(emisora => 
                `<option value="${emisora.name}" ${emisora.name === client.emisora ? 'selected' : ''}>${emisora.name}</option>`
            ).join('');
            
            const modalContent = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Editar Cliente</h3>
                <form onsubmit="updateClient(event, ${clientId})" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del cliente</label>
                        <input type="text" name="name" value="${client.name}" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Emisora</label>
                        <select name="emisora" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Seleccionar emisora...</option>
                            ${emisoraOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Agente</label>
                        <select name="agentId" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Seleccionar agente...</option>
                            ${agentOptions}
                        </select>
                    </div>

                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Actualizar Cliente
                        </button>
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Cancelar
                        </button>
                    </div>
                </form>
            `;
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-lg w-full p-6";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function deleteClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            // Check if client has active campaigns
            const clientCampaigns = campaigns.filter(c => c.clientId === clientId);
            
            let confirmMessage = `¬øEst√° seguro de eliminar el cliente "${client.name}"?`;
            if (clientCampaigns.length > 0) {
                confirmMessage += `\n\nEste cliente tiene ${clientCampaigns.length} campa√±a(s) que tambi√©n se eliminar√°n.`;
            }
            
            // Show custom confirmation modal
            showDeleteConfirmationModal(confirmMessage, async () => {
                // Remove client
                clients = clients.filter(c => c.id !== clientId);
                
                // Remove client's campaigns
                campaigns = campaigns.filter(c => c.clientId !== clientId);
                
                // Remove client's campaign statuses
                Object.keys(campaignStatuses).forEach(key => {
                    const campaignId = parseInt(key.split('-')[0]);
                    const campaign = campaigns.find(c => c.id === campaignId);
                    if (!campaign) {
                        delete campaignStatuses[key];
                    }
                });
                
                // Auto-sync to Supabase if available
                await autoSyncToSupabase();
                
                // Refresh data
                loadClients();
                loadMonthlyBillingTable();
                loadDashboard();
            });
        }



        // Calculate commission for an agent based on sales amount and policy
        function calculateCommission(agentId, salesAmount) {
            const agent = agents.find(a => a.id === agentId);
            if (!agent || !agent.commissionPolicyId) return 0;
            
            const policy = commissionPolicies.find(p => p.id === agent.commissionPolicyId);
            if (!policy) return 0;
            
            // Find the tier that contains the sales amount
            for (const tier of policy.tiers) {
                const tierMax = tier.to || Infinity;
                
                if (salesAmount >= tier.from && salesAmount <= tierMax) {
                    // Apply the tier percentage to the entire sales amount
                    return (salesAmount * tier.percentage) / 100;
                }
            }
            
            return 0;
        }

        // Get the commission tier percentage for an agent based on sales amount
        function getCommissionTier(agentId, salesAmount) {
            const agent = agents.find(a => a.id === agentId);
            if (!agent || !agent.commissionPolicyId) return 0;
            
            const policy = commissionPolicies.find(p => p.id === agent.commissionPolicyId);
            if (!policy) return 0;
            
            // Find the tier that contains the sales amount
            for (const tier of policy.tiers) {
                const tierMax = tier.to || Infinity;
                
                if (salesAmount >= tier.from && salesAmount <= tierMax) {
                    return tier.percentage;
                }
            }
            
            return 0;
        }

        // Get agent sales for a specific month and year (only paid invoices)
        function getAgentSales(agentId, month, year) {
            let totalSales = 0;
            
            campaigns.forEach(campaign => {
                if (campaign.agentId === agentId && isMonthInCampaignPeriod(month, year, campaign)) {
                    // Check if this campaign's invoice for this month is paid
                    const campaignKey = `${campaign.id}-${month}-${year}`;
                    const status = campaignStatuses[campaignKey] || getMonthStatus(campaign, month, year);
                    
                    // Only count paid invoices for commission calculation
                    if (status === 'paid') {
                        totalSales += campaign.amount;
                    }
                }
            });
            
            return totalSales;
        }

        // Get agent sales for a specific year (only paid invoices)
        function getAgentYearSales(agentId, year) {
            let totalSales = 0;
            
            // Sum all monthly sales (which already filter for paid invoices only)
            for (let month = 1; month <= 12; month++) {
                totalSales += getAgentSales(agentId, month, year);
            }
            
            return totalSales;
        }

        // Load commissions table
        function loadCommissions() {
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            
            // Set default values
            document.getElementById('commission-month-filter').value = currentMonth;
            document.getElementById('commission-year-filter').value = currentYear;
            
            updateCommissions();
        }

        // Update commissions table
        function updateCommissions() {
            const selectedMonth = parseInt(document.getElementById('commission-month-filter').value);
            const selectedYear = parseInt(document.getElementById('commission-year-filter').value);
            
            const commissionsHtml = agents.map(agent => {
                const policy = commissionPolicies.find(p => p.id === agent.commissionPolicyId);
                const monthlySales = getAgentSales(agent.id, selectedMonth, selectedYear);
                const monthlyCommission = calculateCommission(agent.id, monthlySales);
                const yearlySales = getAgentYearSales(agent.id, selectedYear);
                const yearlyCommission = calculateCommission(agent.id, yearlySales);
                
                // Get current commission tier for monthly sales
                const monthlyTier = getCommissionTier(agent.id, monthlySales);
                const yearlyTier = getCommissionTier(agent.id, yearlySales);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium text-gray-900">${agent.name}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${monthlyTier} %
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center text-gray-900">${formatCurrency(monthlySales)}</td>
                        <td class="px-4 py-3 text-center font-semibold text-green-600">${formatCurrency(monthlyCommission)}</td>
                        <td class="px-4 py-3 text-center text-gray-900">${formatCurrency(yearlySales)}</td>
                        <td class="px-4 py-3 text-center font-semibold text-blue-600">${formatCurrency(yearlyCommission)}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('commissions-table').innerHTML = commissionsHtml;
        }

        // Campaign editing functions
        function editCampaign(campaignId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            
            const client = clients.find(c => c.id === campaign.clientId);
            const agentOptions = agents.map(agent => 
                `<option value="${agent.id}" ${agent.id === campaign.agentId ? 'selected' : ''}>${agent.name}</option>`
            ).join('');
            const emisoraOptions = emisoras.map(emisora => 
                `<option value="${emisora.name}" ${emisora.name === campaign.emisora ? 'selected' : ''}>${emisora.name}</option>`
            ).join('');
            
            // Generate monthly quotas for editing
            const monthlyQuotasHtml = generateMonthlyQuotasEditor(campaign);
            
            const modalContent = `
                <div class="max-w-4xl w-full">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Editar Campa√±a - ${client.name}</h3>
                    <form onsubmit="updateCampaign(event, ${campaignId})" class="space-y-6">
                        <!-- Basic campaign info -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Emisora</label>
                                <select name="emisora" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    ${emisoraOptions}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Agente</label>
                                <select name="agentId" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    ${agentOptions}
                                </select>
                            </div>
                        </div>
                        

                        
                        <!-- Monthly quotas editor -->
                        <div>
                            <h4 class="text-md font-medium text-gray-800 mb-3">Cuotas Mensuales</h4>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="max-h-80 overflow-y-auto pr-2" id="monthly-quotas-container">
                                    <div id="monthly-quotas-editor">
                                        ${monthlyQuotasHtml}
                                    </div>
                                </div>
                                <div class="mt-4 flex space-x-2 border-t pt-4">
                                    <button type="button" onclick="addNewQuotaPeriod(${campaignId})" class="bg-green-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-700 transition-colors">
                                        + A√±adir Nuevo Per√≠odo
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 pt-4 border-t">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                Guardar Cambios
                            </button>
                            <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-4xl w-full p-6";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function generateMonthlyQuotasEditor(campaign) {
            const quotaPeriods = getQuotaPeriods(campaign);
            
            return quotaPeriods.map((period, index) => {
                const startMonthName = getMonthName(period.startMonth);
                const endMonthName = getMonthName(period.endMonth);
                
                return `
                    <div class="quota-period border border-gray-200 rounded-lg p-4 mb-3" data-period-index="${index}" data-campaign-id="${period.id}">
                        <div class="flex justify-between items-start mb-3">
                            <h5 class="font-medium text-gray-800">
                                Per√≠odo ${index + 1}: ${startMonthName} ${period.startYear} - ${endMonthName} ${period.endYear}
                            </h5>
                            <button type="button" onclick="deleteQuotaPeriod(${period.id}, ${index})" class="text-red-600 hover:text-red-800 text-sm">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-7 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Mes inicio</label>
                                <select name="period_${index}_startMonth" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                    ${generateMonthOptions(period.startMonth)}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">A√±o inicio</label>
                                <input type="number" name="period_${index}_startYear" value="${period.startYear}" min="2020" max="2030" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Mes fin</label>
                                <select name="period_${index}_endMonth" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                    ${generateMonthOptions(period.endMonth)}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">A√±o fin</label>
                                <input type="number" name="period_${index}_endYear" value="${period.endYear}" min="2020" max="2030" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Cuota (‚Ç¨)</label>
                                <input type="number" name="period_${index}_amount" value="${period.amount}" min="0.01" step="0.01" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">D√≠a facturaci√≥n</label>
                                <input type="number" name="period_${index}_billingDay" value="${period.billingDay || 1}" min="1" max="31" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">D√≠as vencimiento</label>
                                <input type="number" name="period_${index}_dueAfterDays" value="${period.dueAfterDays || 30}" min="1" max="90" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                            </div>
                        </div>
                        <input type="hidden" name="period_${index}_campaignId" value="${period.id}">
                    </div>
                `;
            }).join('');
        }

        function getQuotaPeriods(campaign) {
            // Get all campaigns for the same client to show all periods
            const clientCampaigns = campaigns.filter(c => c.clientId === campaign.clientId);
            
            // Sort campaigns by start date to show them in chronological order
            clientCampaigns.sort((a, b) => {
                if (a.startYear !== b.startYear) return a.startYear - b.startYear;
                return a.startMonth - b.startMonth;
            });
            
            return clientCampaigns.map(c => ({
                id: c.id, // Include campaign ID for reference
                startMonth: c.startMonth,
                startYear: c.startYear,
                endMonth: c.endMonth,
                endYear: c.endYear,
                amount: c.amount,
                billingDay: c.billingDay || 1,
                dueAfterDays: c.dueAfterDays || 30
            }));
        }

        function generateMonthOptions(selectedMonth) {
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            return months.map((month, index) => {
                const value = index + 1;
                const selected = value === selectedMonth ? 'selected' : '';
                return `<option value="${value}" ${selected}>${month}</option>`;
            }).join('');
        }

        function getMonthName(monthNumber) {
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            return months[monthNumber - 1];
        }

        function addNewQuotaPeriod(campaignId) {
            const editor = document.getElementById('monthly-quotas-editor');
            const periodCount = editor.querySelectorAll('.quota-period').length;
            
            const newPeriodHtml = `
                <div class="quota-period border border-gray-200 rounded-lg p-4 mb-3" data-period-index="${periodCount}">
                    <div class="flex justify-between items-start mb-3">
                        <h5 class="font-medium text-gray-800">Nuevo Per√≠odo ${periodCount + 1}</h5>
                        <button type="button" onclick="this.parentElement.parentElement.parentElement.remove()" class="text-red-600 hover:text-red-800 text-sm">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-3">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Mes inicio</label>
                            <select name="period_${periodCount}_startMonth" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                ${generateMonthOptions(1)}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">A√±o inicio</label>
                            <input type="number" name="period_${periodCount}_startYear" value="2024" min="2020" max="2030" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Mes fin</label>
                            <select name="period_${periodCount}_endMonth" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                ${generateMonthOptions(12)}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">A√±o fin</label>
                            <input type="number" name="period_${periodCount}_endYear" value="2024" min="2020" max="2030" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Cuota (‚Ç¨)</label>
                            <input type="number" name="period_${periodCount}_amount" value="0" min="0.01" step="0.01" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">D√≠a facturaci√≥n</label>
                            <input type="number" name="period_${periodCount}_billingDay" value="1" min="1" max="31" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">D√≠as vencimiento</label>
                            <input type="number" name="period_${periodCount}_dueAfterDays" value="30" min="1" max="90" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                    </div>
                    <input type="hidden" name="period_${periodCount}_campaignId" value="">
                </div>
            `;
            
            editor.insertAdjacentHTML('beforeend', newPeriodHtml);
            
            // Scroll to the new period if the container is scrollable
            const container = document.getElementById('monthly-quotas-container');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }

        function deleteQuotaPeriod(campaignId, periodIndex) {
            const periodElement = document.querySelector(`[data-period-index="${periodIndex}"]`);
            if (periodElement) {
                // Check if it's the last period
                const totalPeriods = document.querySelectorAll('.quota-period').length;
                if (totalPeriods === 1) {
                    showSuccessToast('‚ö†Ô∏è No se puede eliminar el √∫nico per√≠odo. La campa√±a debe tener al menos un per√≠odo activo.');
                    return;
                }
                
                // Remove this specific period element immediately
                periodElement.remove();
                
                // Renumber the remaining periods to maintain sequential indexing
                const remainingPeriods = document.querySelectorAll('.quota-period');
                remainingPeriods.forEach((period, newIndex) => {
                    period.setAttribute('data-period-index', newIndex);
                    
                    // Update the period title
                    const titleElement = period.querySelector('h5');
                    if (titleElement) {
                        const titleText = titleElement.textContent;
                        const colonIndex = titleText.indexOf(':');
                        if (colonIndex !== -1) {
                            const afterColon = titleText.substring(colonIndex);
                            titleElement.textContent = `Per√≠odo ${newIndex + 1}${afterColon}`;
                        }
                    }
                    
                    // Update all input names within this period
                    const inputs = period.querySelectorAll('input, select');
                    inputs.forEach(input => {
                        const name = input.getAttribute('name');
                        if (name && name.startsWith('period_')) {
                            const parts = name.split('_');
                            if (parts.length >= 3) {
                                parts[1] = newIndex; // Update the index
                                input.setAttribute('name', parts.join('_'));
                            }
                        }
                    });
                });
                
                showSuccessToast('‚úÖ Per√≠odo eliminado correctamente');
            }
        }

        async function updateCampaign(event, campaignId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const originalCampaign = campaigns.find(c => c.id === campaignId);
            
            if (!originalCampaign) return;
            
            // Collect all periods with their campaign IDs
            const periods = [];
            let periodIndex = 0;
            
            while (formData.has(`period_${periodIndex}_startMonth`)) {
                const existingCampaignId = formData.get(`period_${periodIndex}_campaignId`);
                
                periods.push({
                    campaignId: existingCampaignId ? parseInt(existingCampaignId) : null,
                    startMonth: parseInt(formData.get(`period_${periodIndex}_startMonth`)),
                    startYear: parseInt(formData.get(`period_${periodIndex}_startYear`)),
                    endMonth: parseInt(formData.get(`period_${periodIndex}_endMonth`)),
                    endYear: parseInt(formData.get(`period_${periodIndex}_endYear`)),
                    amount: parseFloat(formData.get(`period_${periodIndex}_amount`)),
                    billingDay: parseInt(formData.get(`period_${periodIndex}_billingDay`)) || 1,
                    dueAfterDays: parseInt(formData.get(`period_${periodIndex}_dueAfterDays`)) || 30
                });
                periodIndex++;
            }
            
            if (periods.length === 0) {
                alert('Debe definir al menos un per√≠odo de facturaci√≥n.');
                return;
            }
            
            // Get all existing campaigns for this client
            const clientCampaigns = campaigns.filter(c => c.clientId === originalCampaign.clientId);
            const existingCampaignIds = new Set(clientCampaigns.map(c => c.id));
            
            // Track which campaigns we're keeping/updating
            const updatedCampaignIds = new Set();
            
            // Update or create campaigns for each period
            periods.forEach((period, index) => {
                if (period.campaignId && existingCampaignIds.has(period.campaignId)) {
                    // Update existing campaign
                    const campaignIndex = campaigns.findIndex(c => c.id === period.campaignId);
                    if (campaignIndex !== -1) {
                        campaigns[campaignIndex] = {
                            ...campaigns[campaignIndex],
                            emisora: formData.get('emisora'),
                            agentId: parseInt(formData.get('agentId')),
                            amount: period.amount,
                            startMonth: period.startMonth,
                            startYear: period.startYear,
                            endMonth: period.endMonth,
                            endYear: period.endYear,
                            billingDay: period.billingDay,
                            dueAfterDays: period.dueAfterDays
                        };
                        updatedCampaignIds.add(period.campaignId);
                    }
                } else {
                    // Create new campaign
                    const newCampaign = {
                        id: Math.max(...campaigns.map(c => c.id), 0) + 1,
                        clientId: originalCampaign.clientId,
                        emisora: formData.get('emisora'),
                        agentId: parseInt(formData.get('agentId')),
                        amount: period.amount,
                        startMonth: period.startMonth,
                        startYear: period.startYear,
                        endMonth: period.endMonth,
                        endYear: period.endYear,
                        billingDay: period.billingDay,
                        dueAfterDays: period.dueAfterDays
                    };
                    campaigns.push(newCampaign);
                    updatedCampaignIds.add(newCampaign.id);
                }
            });
            
            // Remove campaigns that are no longer in the periods list
            const campaignsToRemove = clientCampaigns.filter(c => !updatedCampaignIds.has(c.id));
            campaignsToRemove.forEach(campaign => {
                // Remove the campaign
                campaigns = campaigns.filter(c => c.id !== campaign.id);
                
                // Remove associated campaign statuses
                Object.keys(campaignStatuses).forEach(key => {
                    if (key.startsWith(`${campaign.id}-`)) {
                        delete campaignStatuses[key];
                    }
                });
            });
            
            // Auto-sync to Supabase if available
            await autoSyncToSupabase();
            
            closeModal();
            loadMonthlyBillingTable();
            loadDashboard();
            updateChart();
            
            // Show success toast
            showSuccessToast('‚úÖ Campa√±a actualizada exitosamente');
        }

        // Show overdue debt modal
        function showOverdueDebtModal() {
            const overdueDebtors = getOverdueDebtors();
            
            const debtorsHtml = overdueDebtors.map(debtor => {
                const oldestInvoiceDate = new Date(Math.min(...debtor.overdueInvoices.map(inv => new Date(inv.year, inv.month - 1, debtor.campaign.billingDay))));
                const today = new Date();
                const daysDiff = Math.floor((today - oldestInvoiceDate) / (1000 * 60 * 60 * 24));
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <button onclick="showClientStatsModal(${debtor.clientId})" class="font-medium text-blue-600 hover:text-blue-800 underline cursor-pointer">
                                ${debtor.clientName}
                            </button>
                        </td>
                        <td class="px-4 py-3 text-gray-700">${debtor.emisora}</td>
                        <td class="px-4 py-3 text-gray-700">${debtor.agentName}</td>
                        <td class="px-4 py-3 text-right font-semibold text-red-600">${formatCurrency(debtor.totalDebt)}</td>
                        <td class="px-4 py-3 text-center text-gray-700">${debtor.overdueInvoices.length}</td>
                        <td class="px-4 py-3 text-center text-gray-700">${daysDiff} d√≠as</td>
                    </tr>
                `;
            }).join('');
            
            const totalDebt = overdueDebtors.reduce((sum, debtor) => sum + debtor.totalDebt, 0);
            
            const modalContent = `
                <div class="max-w-4xl w-full">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                            <span class="text-red-600 text-2xl mr-2">‚ö†Ô∏è</span>
                            Deuda Vencida - ${formatCurrency(totalDebt)}
                        </h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                            <span class="text-2xl">√ó</span>
                        </button>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <p class="text-sm text-gray-600">
                            <strong>${overdueDebtors.length}</strong> cliente(s) con facturas vencidas
                        </p>
                    </div>
                    
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <div class="max-h-96 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Emisora</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Agente</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Deuda</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Facturas</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Antig√ºedad</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${debtorsHtml || '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No hay deudas vencidas</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="flex justify-end pt-6 border-t mt-6">
                        <button onclick="closeModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-4xl w-full p-6";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        // Get overdue debtors data
        function getOverdueDebtors() {
            const today = new Date();
            const overdueDebtors = [];
            
            // Group campaigns by client
            const clientCampaigns = {};
            campaigns.forEach(campaign => {
                if (!clientCampaigns[campaign.clientId]) {
                    clientCampaigns[campaign.clientId] = [];
                }
                clientCampaigns[campaign.clientId].push(campaign);
            });
            
            // Check each client for overdue invoices
            Object.keys(clientCampaigns).forEach(clientId => {
                const clientId_num = parseInt(clientId);
                const client = clients.find(c => c.id === clientId_num);
                if (!client) return;
                
                let totalDebt = 0;
                let overdueInvoices = [];
                let representativeCampaign = null;
                
                clientCampaigns[clientId].forEach(campaign => {
                    // Check all historical periods for this campaign
                    for (let year = campaign.startYear; year <= campaign.endYear; year++) {
                        const startMonth = year === campaign.startYear ? campaign.startMonth : 1;
                        const endMonth = year === campaign.endYear ? campaign.endMonth : 12;
                        
                        for (let month = startMonth; month <= endMonth; month++) {
                            if (isMonthInCampaignPeriod(month, year, campaign)) {
                                const campaignKey = `${campaign.id}-${month}-${year}`;
                                const status = campaignStatuses[campaignKey] || getMonthStatus(campaign, month, year);
                                
                                if (status === 'overdue') {
                                    totalDebt += campaign.amount;
                                    overdueInvoices.push({ month, year, amount: campaign.amount });
                                    representativeCampaign = campaign;
                                }
                            }
                        }
                    }
                });
                
                if (totalDebt > 0 && representativeCampaign) {
                    const agent = agents.find(a => a.id === representativeCampaign.agentId);
                    
                    overdueDebtors.push({
                        clientId: clientId_num,
                        clientName: client.name,
                        emisora: representativeCampaign.emisora,
                        agentName: agent ? agent.name : 'Sin asignar',
                        totalDebt: totalDebt,
                        overdueInvoices: overdueInvoices,
                        campaign: representativeCampaign
                    });
                }
            });
            
            // Sort by total debt (highest first)
            return overdueDebtors.sort((a, b) => b.totalDebt - a.totalDebt);
        }

        // Modal stack management
        let modalStack = [];

        // Client statistics functions
        function showClientStatsModal(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            // Store current modal state if there is one
            const currentModal = document.getElementById('modal-overlay');
            if (!currentModal.classList.contains('hidden')) {
                modalStack.push({
                    content: document.getElementById('modal-content').innerHTML,
                    className: document.getElementById('modal-content').className
                });
            }
            
            const clientStats = calculateClientStats(clientId);
            const agent = agents.find(a => a.id === client.agentId);
            
            const modalContent = `
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                        <span class="text-blue-600 text-2xl mr-3">üìä</span>
                        ${client.name}
                    </h3>
                    <button onclick="closeClientStatsModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="text-2xl">√ó</span>
                    </button>
                </div>
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm text-blue-600 font-medium">Total Facturado</p>
                        <p class="text-2xl font-bold text-blue-700">${formatCurrency(clientStats.totalBilled)}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-sm text-green-600 font-medium">Total Cobrado</p>
                        <p class="text-2xl font-bold text-green-700">${formatCurrency(clientStats.totalPaid)}</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <p class="text-sm text-purple-600 font-medium">Tasa de Cobro</p>
                        <p class="text-2xl font-bold text-purple-700">${clientStats.paymentRate} %</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <p class="text-sm text-red-600 font-medium">Deuda Pendiente</p>
                        <p class="text-2xl font-bold text-red-700">${formatCurrency(clientStats.totalDebt)}</p>
                    </div>
                </div>
                
                <!-- Client Info -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-1 gap-2 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">Emisora:</span>
                            <span class="text-gray-600 ml-2">${client.emisora}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Agente:</span>
                            <span class="text-gray-600 ml-2">${agent ? agent.name : 'Sin asignar'}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Campa√±as Activas:</span>
                            <span class="text-gray-600 ml-2">${clientStats.activeCampaigns}</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end pt-4 border-t">
                    <button onclick="closeClientStatsModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        ${modalStack.length > 0 ? 'Volver' : 'Cerrar'}
                    </button>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-lg w-full p-6";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function closeClientStatsModal() {
            if (modalStack.length > 0) {
                // Restore previous modal
                const previousModal = modalStack.pop();
                document.getElementById('modal-content').innerHTML = previousModal.content;
                document.getElementById('modal-content').className = previousModal.className;
            } else {
                // Close modal completely
                document.getElementById('modal-overlay').classList.add('hidden');
                modalStack = [];
            }
        }

        function calculateClientStats(clientId) {
            const clientCampaigns = campaigns.filter(c => c.clientId === clientId);
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            
            let totalBilled = 0;
            let totalPaid = 0;
            let totalDebt = 0;
            let unpaidInvoices = [];
            let monthlyHistory = [];
            
            // Para la tasa de cobro: solo facturas que ya deber√≠an estar resueltas (pagadas o vencidas)
            let resolvedInvoicesBilled = 0;
            let resolvedInvoicesPaid = 0;
            
            clientCampaigns.forEach(campaign => {
                for (let year = campaign.startYear; year <= campaign.endYear; year++) {
                    const startMonth = year === campaign.startYear ? campaign.startMonth : 1;
                    const endMonth = year === campaign.endYear ? campaign.endMonth : 12;
                    
                    for (let month = startMonth; month <= endMonth; month++) {
                        if (isMonthInCampaignPeriod(month, year, campaign)) {
                            totalBilled += campaign.amount;
                            
                            const campaignKey = `${campaign.id}-${month}-${year}`;
                            const status = campaignStatuses[campaignKey] || getMonthStatus(campaign, month, year);
                            
                            const record = {
                                month,
                                year,
                                amount: campaign.amount,
                                status,
                                campaign
                            };
                            
                            monthlyHistory.push(record);
                            
                            // Para tasa de cobro: solo facturas pagadas o vencidas (no pendientes ni no enviadas)
                            // Las pendientes est√°n en plazo, no se consideran para la tasa de cobro
                            if (status === 'paid' || status === 'overdue') {
                                resolvedInvoicesBilled += campaign.amount;
                                
                                if (status === 'paid') {
                                    resolvedInvoicesPaid += campaign.amount;
                                }
                            }
                            
                            if (status === 'paid') {
                                totalPaid += campaign.amount;
                            } else if (status === 'overdue') {
                                // Solo las vencidas se consideran deuda real
                                totalDebt += campaign.amount;
                                
                                const billingDate = new Date(year, month - 1, campaign.billingDay);
                                const daysOverdue = Math.max(0, Math.floor((today - billingDate) / (1000 * 60 * 60 * 24)));
                                
                                unpaidInvoices.push({
                                    month,
                                    year,
                                    amount: campaign.amount,
                                    status,
                                    daysOverdue
                                });
                            }
                        }
                    }
                }
            });
            
            // Sort monthly history by date (most recent first)
            monthlyHistory.sort((a, b) => {
                if (a.year !== b.year) return b.year - a.year;
                return b.month - a.month;
            });
            
            // Sort unpaid invoices by days overdue (most overdue first)
            unpaidInvoices.sort((a, b) => b.daysOverdue - a.daysOverdue);
            
            // Calcular tasa de cobro: solo sobre facturas resueltas (pagadas + vencidas)
            // Si todas las facturas resueltas est√°n pagadas = 100%
            // Si hay facturas vencidas, la tasa baja proporcionalmente
            const paymentRate = resolvedInvoicesBilled > 0 ? Math.round((resolvedInvoicesPaid / resolvedInvoicesBilled) * 100) : 100;
            
            const activeCampaigns = clientCampaigns.filter(campaign => {
                const endDate = new Date(campaign.endYear, campaign.endMonth - 1, 31);
                return endDate >= today;
            }).length;
            
            return {
                totalBilled,
                totalPaid,
                totalDebt,
                paymentRate,
                activeCampaigns,
                unpaidInvoices: unpaidInvoices.slice(0, 20), // Limit to 20 most recent
                monthlyHistory: monthlyHistory.slice(0, 12), // Last 12 months
                resolvedInvoicesBilled,
                resolvedInvoicesPaid
            };
        }

        function showTopClientsModal(type) {
            const topClients = getTopClients(type);
            
            const titles = {
                'revenue': 'Top Clientes por Ingresos',
                'loyalty': 'Top Clientes por Fidelidad',
                'payment': 'Clientes con Mejor Tasa de Cobro',
                'growth': 'Clientes con Mayor Crecimiento'
            };
            
            const icons = {
                'revenue': 'üëë',
                'loyalty': '‚≠ê',
                'payment': 'üíØ',
                'growth': 'üìà'
            };
            
            const clientsHtml = topClients.map((client, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∫`;
                const agent = agents.find(a => a.id === client.agentId);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-center text-lg">${medal}</td>
                        <td class="px-4 py-3">
                            <button onclick="showClientStatsModal(${client.id})" class="font-medium text-blue-600 hover:text-blue-800 underline cursor-pointer">
                                ${client.name}
                            </button>
                        </td>
                        <td class="px-4 py-3 text-gray-700">${client.emisora}</td>
                        <td class="px-4 py-3 text-gray-700">${agent ? agent.name : 'Sin asignar'}</td>
                        <td class="px-4 py-3 text-right font-semibold text-blue-600">${client.displayValue}</td>
                    </tr>
                `;
            }).join('');
            
            const modalContent = `
                <div class="max-w-4xl w-full">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                            <span class="text-2xl mr-3">${icons[type]}</span>
                            ${titles[type]}
                        </h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                            <span class="text-2xl">√ó</span>
                        </button>
                    </div>
                    
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Posici√≥n</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Emisora</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Agente</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">${getColumnHeader(type)}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${clientsHtml || '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No hay datos disponibles</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex justify-end pt-6 border-t mt-6">
                        <button onclick="closeModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-4xl w-full p-6";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function getTopClients(type) {
            const clientStats = clients.map(client => {
                const stats = calculateClientStats(client.id);
                return {
                    ...client,
                    ...stats
                };
            });
            
            switch (type) {
                case 'revenue':
                    return clientStats
                        .filter(c => c.totalPaid > 0)
                        .sort((a, b) => b.totalPaid - a.totalPaid)
                        .slice(0, 10)
                        .map(c => ({ ...c, displayValue: formatCurrency(c.totalPaid) }));
                        
                case 'loyalty':
                    return clientStats
                        .filter(c => c.activeCampaigns > 0)
                        .sort((a, b) => {
                            // Sort by active campaigns first, then by total months with campaigns
                            if (a.activeCampaigns !== b.activeCampaigns) {
                                return b.activeCampaigns - a.activeCampaigns;
                            }
                            return b.monthlyHistory.length - a.monthlyHistory.length;
                        })
                        .slice(0, 10)
                        .map(c => ({ ...c, displayValue: `${c.monthlyHistory.length} meses` }));
                        
                case 'payment':
                    return clientStats
                        .filter(c => c.totalBilled > 0)
                        .sort((a, b) => b.paymentRate - a.paymentRate)
                        .slice(0, 10)
                        .map(c => ({ ...c, displayValue: `${c.paymentRate} %` }));
                        
                case 'growth':
                    return clientStats
                        .filter(c => c.monthlyHistory.length >= 6)
                        .map(c => {
                            const recent = c.monthlyHistory.slice(0, 3).filter(h => h.status === 'paid');
                            const older = c.monthlyHistory.slice(3, 6).filter(h => h.status === 'paid');
                            
                            const recentAvg = recent.length > 0 ? recent.reduce((sum, h) => sum + h.amount, 0) / recent.length : 0;
                            const olderAvg = older.length > 0 ? older.reduce((sum, h) => sum + h.amount, 0) / older.length : 0;
                            
                            const growth = olderAvg > 0 ? ((recentAvg - olderAvg) / olderAvg) * 100 : 0;
                            
                            return { ...c, growth, displayValue: `${growth > 0 ? '+' : ''}${growth.toFixed(1)} %` };
                        })
                        .sort((a, b) => b.growth - a.growth)
                        .slice(0, 10);
                        
                default:
                    return [];
            }
        }

        function getColumnHeader(type) {
            switch (type) {
                case 'revenue': return 'Ingresos Totales';
                case 'loyalty': return 'Tiempo como Cliente';
                case 'payment': return 'Tasa de Cobro';
                case 'growth': return 'Crecimiento';
                default: return 'Valor';
            }
        }

        // Forecast Analysis Functions
        function loadForecast() {
            initForecastChart();
            updateForecast();
        }

        function initForecastChart() {
            const ctx = document.getElementById('forecast-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (forecastChart) {
                forecastChart.destroy();
            }
            
            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Ingresos Hist√≥ricos',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }, {
                        label: 'Proyecci√≥n',
                        data: [],
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 3,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.4,
                        pointBackgroundColor: 'rgb(34, 197, 94)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }, {
                        label: 'Rango de Confianza',
                        data: [],
                        borderColor: 'rgba(34, 197, 94, 0.3)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 1,
                        fill: '+1',
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function updateForecast() {
            const forecastMonths = parseInt(document.getElementById('forecast-months').value);
            const forecastModel = document.getElementById('forecast-model').value;
            
            const forecastData = calculateForecast(forecastMonths, forecastModel);
            
            // Update summary cards
            document.getElementById('forecast-3m').textContent = formatCurrency(forecastData.projections.threeMonth);
            document.getElementById('forecast-6m').textContent = formatCurrency(forecastData.projections.sixMonth);
            document.getElementById('monthly-trend').textContent = forecastData.monthlyTrend.toFixed(1).replace('.', ',') + ' %';
            document.getElementById('forecast-confidence').textContent = forecastData.confidence.toFixed(0) + ' %';
            
            // Update change indicators
            document.getElementById('forecast-3m-change').textContent = 
                (forecastData.changes.threeMonth >= 0 ? '+' : '') + forecastData.changes.threeMonth.toFixed(1).replace('.', ',') + ' % vs anterior';
            document.getElementById('forecast-6m-change').textContent = 
                (forecastData.changes.sixMonth >= 0 ? '+' : '') + forecastData.changes.sixMonth.toFixed(1).replace('.', ',') + ' % vs anterior';
            
            // Update chart
            if (forecastChart) {
                forecastChart.data.labels = forecastData.labels;
                forecastChart.data.datasets[0].data = forecastData.historical;
                forecastChart.data.datasets[1].data = forecastData.forecast;
                forecastChart.data.datasets[2].data = forecastData.confidenceRange;
                forecastChart.update();
            }
            

        }

        function calculateForecast(months, model) {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            
            // Get historical data (last 12 months)
            const historicalData = [];
            const labels = [];
            
            for (let i = 11; i >= 0; i--) {
                const date = new Date(currentYear, currentMonth - 1 - i, 1);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                
                let monthlyRevenue = 0;
                campaigns.forEach(campaign => {
                    if (isMonthInCampaignPeriod(month, year, campaign)) {
                        const campaignKey = `${campaign.id}-${month}-${year}`;
                        const status = campaignStatuses[campaignKey] || getMonthStatus(campaign, month, year);
                        
                        if (status === 'paid') {
                            monthlyRevenue += campaign.amount;
                        }
                    }
                });
                
                historicalData.push(monthlyRevenue);
                labels.push(getMonthName(month).substring(0, 3) + ' ' + year);
            }
            
            // Calculate forecast based on model
            const forecast = [];
            const confidenceRange = [];
            
            for (let i = 0; i < months; i++) {
                const futureDate = new Date(currentYear, currentMonth + i, 1);
                const futureYear = futureDate.getFullYear();
                const futureMonth = futureDate.getMonth() + 1;
                
                let projectedValue = 0;
                let confidence = 85; // Base confidence
                
                switch (model) {
                    case 'linear':
                        projectedValue = calculateLinearTrend(historicalData, i + 1);
                        confidence = Math.max(60, 85 - (i * 5)); // Decreasing confidence
                        break;
                    case 'seasonal':
                        projectedValue = calculateSeasonalForecast(historicalData, futureMonth, i + 1);
                        confidence = Math.max(70, 90 - (i * 3));
                        break;
                    case 'conservative':
                        projectedValue = calculateConservativeForecast(historicalData, i + 1);
                        confidence = Math.max(75, 95 - (i * 2));
                        break;
                }
                
                // Add scheduled campaigns for future months
                const scheduledRevenue = getScheduledRevenue(futureMonth, futureYear);
                projectedValue = Math.max(projectedValue, scheduledRevenue);
                
                forecast.push(projectedValue);
                
                // Calculate confidence range (¬±15% of projected value)
                const margin = projectedValue * 0.15;
                confidenceRange.push(projectedValue + margin);
                
                labels.push(getMonthName(futureMonth).substring(0, 3) + ' ' + futureYear);
            }
            
            // Calculate summary metrics
            const threeMonthProjection = forecast.slice(0, 3).reduce((sum, val) => sum + val, 0);
            const sixMonthProjection = forecast.slice(0, 6).reduce((sum, val) => sum + val, 0);
            
            // Calculate changes vs previous periods
            const lastThreeMonths = historicalData.slice(-3).reduce((sum, val) => sum + val, 0);
            const lastSixMonths = historicalData.slice(-6).reduce((sum, val) => sum + val, 0);
            
            const threeMonthChange = lastThreeMonths > 0 ? ((threeMonthProjection - lastThreeMonths) / lastThreeMonths) * 100 : 0;
            const sixMonthChange = lastSixMonths > 0 ? ((sixMonthProjection - lastSixMonths) / lastSixMonths) * 100 : 0;
            
            // Calculate monthly trend
            const monthlyTrend = calculateMonthlyTrend(historicalData);
            
            // Average confidence
            const avgConfidence = forecast.reduce((sum, _, i) => sum + Math.max(60, 90 - (i * 3)), 0) / forecast.length;
            
            return {
                labels,
                historical: [...historicalData, ...new Array(months).fill(null)],
                forecast: [...new Array(12).fill(null), ...forecast],
                confidenceRange: [...new Array(12).fill(null), ...confidenceRange],
                projections: {
                    threeMonth: threeMonthProjection,
                    sixMonth: sixMonthProjection
                },
                changes: {
                    threeMonth: threeMonthChange,
                    sixMonth: sixMonthChange
                },
                monthlyTrend,
                confidence: avgConfidence
            };
        }

        function calculateLinearTrend(data, futureIndex) {
            const n = data.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            
            for (let i = 0; i < n; i++) {
                sumX += i;
                sumY += data[i];
                sumXY += i * data[i];
                sumXX += i * i;
            }
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            return Math.max(0, slope * (n + futureIndex - 1) + intercept);
        }

        function calculateSeasonalForecast(data, month, futureIndex) {
            // Get seasonal pattern from historical data
            const seasonalFactors = {
                1: 0.95, 2: 0.90, 3: 1.05, 4: 1.10, 5: 1.15, 6: 1.20,
                7: 1.10, 8: 0.95, 9: 1.05, 10: 1.15, 11: 1.25, 12: 1.30
            };
            
            const baseValue = calculateLinearTrend(data, futureIndex);
            return baseValue * (seasonalFactors[month] || 1.0);
        }

        function calculateConservativeForecast(data, futureIndex) {
            // Use the average of the last 6 months with a slight decline
            const recentData = data.slice(-6);
            const average = recentData.reduce((sum, val) => sum + val, 0) / recentData.length;
            
            // Apply conservative decline factor
            const declineFactor = Math.pow(0.98, futureIndex);
            return average * declineFactor;
        }

        function getScheduledRevenue(month, year) {
            let scheduledRevenue = 0;
            
            campaigns.forEach(campaign => {
                if (isMonthInCampaignPeriod(month, year, campaign)) {
                    scheduledRevenue += campaign.amount;
                }
            });
            
            return scheduledRevenue;
        }

        function calculateMonthlyTrend(data) {
            if (data.length < 2) return 0;
            
            const recent = data.slice(-6);
            const older = data.slice(-12, -6);
            
            if (older.length === 0) return 0;
            
            const recentAvg = recent.reduce((sum, val) => sum + val, 0) / recent.length;
            const olderAvg = older.reduce((sum, val) => sum + val, 0) / older.length;
            
            return olderAvg > 0 ? ((recentAvg - olderAvg) / olderAvg) * 100 : 0;
        }



        function showForecastDetailsModal() {
            const forecastMonths = parseInt(document.getElementById('forecast-months').value);
            const forecastModel = document.getElementById('forecast-model').value;
            const forecastData = calculateForecast(forecastMonths, forecastModel);
            
            // Generate detailed monthly breakdown
            const monthlyBreakdown = forecastData.forecast.filter(val => val !== null).map((value, index) => {
                const futureDate = new Date();
                futureDate.setMonth(futureDate.getMonth() + index + 1);
                const monthName = getMonthName(futureDate.getMonth() + 1);
                const year = futureDate.getFullYear();
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium text-gray-900">${monthName} ${year}</td>
                        <td class="px-4 py-3 text-right text-blue-600 font-semibold">${formatCurrency(value)}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                                ${Math.max(60, 90 - (index * 3)).toFixed(0)} %
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
            
            const modelDescriptions = {
                'linear': 'Proyecci√≥n basada en tendencia lineal de los √∫ltimos 12 meses',
                'seasonal': 'Considera patrones estacionales hist√≥ricos y tendencias',
                'conservative': 'Estimaci√≥n conservadora basada en promedios recientes'
            };
            
            const modalContent = `
                <div class="max-w-4xl w-full">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                            <span class="text-blue-600 text-2xl mr-3">üìä</span>
                            Detalles de Proyecci√≥n de Ingresos
                        </h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                            <span class="text-2xl">√ó</span>
                        </button>
                    </div>
                    
                    <!-- Model Info -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h4 class="font-medium text-blue-800 mb-2">Modelo Utilizado: ${forecastModel.charAt(0).toUpperCase() + forecastModel.slice(1)}</h4>
                        <p class="text-sm text-blue-700">${modelDescriptions[forecastModel]}</p>
                    </div>
                    
                    <!-- Summary Metrics -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
                            <p class="text-sm text-gray-600">Proyecci√≥n Total</p>
                            <p class="text-2xl font-bold text-blue-600">${formatCurrency(forecastData.projections.sixMonth)}</p>
                            <p class="text-xs text-gray-500">${forecastMonths} meses</p>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
                            <p class="text-sm text-gray-600">Promedio Mensual</p>
                            <p class="text-2xl font-bold text-green-600">${formatCurrency(forecastData.projections.sixMonth / forecastMonths)}</p>
                            <p class="text-xs text-gray-500">estimado</p>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
                            <p class="text-sm text-gray-600">Confianza Promedio</p>
                            <p class="text-2xl font-bold text-purple-600">${forecastData.confidence.toFixed(0)} %</p>
                            <p class="text-xs text-gray-500">precisi√≥n estimada</p>
                        </div>
                    </div>
                    
                    <!-- Monthly Breakdown -->
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
                        <div class="bg-gray-50 px-4 py-3 border-b">
                            <h4 class="font-medium text-gray-800">Desglose Mensual</h4>
                        </div>
                        <div class="max-h-64 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mes</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Proyecci√≥n</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Confianza</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${monthlyBreakdown}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="flex justify-end pt-4 border-t">
                        <button onclick="closeModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-content').className = "bg-white rounded-xl shadow-2xl max-w-4xl w-full p-6";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        // Excel Export Functions
        function exportBillingTableToExcel() {
            const selectedYear = parseInt(document.getElementById('year-filter').value);
            const clientFilter = document.getElementById('client-filter')?.value.toLowerCase() || '';
            const emisoraFilter = document.getElementById('emisora-filter')?.value || '';
            const agentFilter = document.getElementById('agent-filter')?.value || '';
            
            // Use the same filtered campaigns as the table
            const exportData = [];
            
            // Add header row
            const headerRow = [
                'Cliente', 'Emisora', 'Agente',
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre',
                'Total Anual'
            ];
            exportData.push(headerRow);
            
            // Group campaigns by client (same logic as table)
            const clientCampaigns = {};
            
            filteredCampaigns.forEach(campaign => {
                if (!clientCampaigns[campaign.clientId]) {
                    clientCampaigns[campaign.clientId] = [];
                }
                clientCampaigns[campaign.clientId].push(campaign);
            });
            
            // Add data rows
            Object.keys(clientCampaigns).forEach(clientId => {
                const clientId_num = parseInt(clientId);
                const client = clients.find(c => c.id === clientId_num);
                if (!client) return;
                
                const clientCampaignsList = clientCampaigns[clientId];
                const representativeCampaign = clientCampaignsList[0];
                const agent = agents.find(a => a.id === representativeCampaign.agentId);
                
                let rowTotal = 0;
                const monthlyAmounts = [];
                
                for (let month = 1; month <= 12; month++) {
                    let monthTotal = 0;
                    
                    clientCampaignsList.forEach(campaign => {
                        if (isMonthInCampaignPeriod(month, selectedYear, campaign)) {
                            monthTotal += campaign.amount;
                        }
                    });
                    
                    monthlyAmounts.push(monthTotal);
                    rowTotal += monthTotal;
                }
                
                // Only add row if client has activity in the year
                if (rowTotal > 0) {
                    const dataRow = [
                        client.name,
                        representativeCampaign.emisora,
                        agent ? agent.name : 'Sin asignar',
                        ...monthlyAmounts,
                        rowTotal
                    ];
                    exportData.push(dataRow);
                }
            });
            
            // Add totals row
            const monthlyTotals = new Array(12).fill(0);
            filteredCampaigns.forEach(campaign => {
                for (let month = 1; month <= 12; month++) {
                    if (isMonthInCampaignPeriod(month, selectedYear, campaign)) {
                        monthlyTotals[month - 1] += campaign.amount;
                    }
                }
            });
            
            const totalAmount = monthlyTotals.reduce((sum, total) => sum + total, 0);
            const totalsRow = [
                'TOTALES', '', '',
                ...monthlyTotals,
                totalAmount
            ];
            exportData.push(totalsRow);
            
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            
            // Set column widths
            const colWidths = [
                { wch: 25 }, // Cliente
                { wch: 15 }, // Emisora
                { wch: 20 }, // Agente
                ...new Array(12).fill({ wch: 12 }), // Months
                { wch: 15 }  // Total
            ];
            ws['!cols'] = colWidths;
            
            // Style the header row
            const headerRange = XLSX.utils.decode_range(ws['!ref']);
            for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!ws[cellAddress]) continue;
                ws[cellAddress].s = {
                    font: { bold: true },
                    fill: { fgColor: { rgb: "F3F4F6" } }
                };
            }
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, `Facturaci√≥n ${selectedYear}`);
            
            // Generate filename with filters
            let filename = `Facturacion_Mensual_${selectedYear}`;
            if (emisoraFilter) filename += `_${emisoraFilter}`;
            if (agentFilter) {
                const agent = agents.find(a => a.id === parseInt(agentFilter));
                if (agent) filename += `_${agent.name.replace(/\s+/g, '_')}`;
            }
            if (clientFilter) filename += `_filtrado`;
            filename += '.xlsx';
            
            // Save file
            XLSX.writeFile(wb, filename);
            
            // Show success message
            showSuccessToast(`‚úÖ Tabla exportada como ${filename}`);
        }

        function exportClientsToExcel() {
            // Use the current filtered clients
            const exportData = [];
            
            // Add header row
            const headerRow = [
                'Cliente', 'Emisora', 'Agente', 'Estado', 'Fin de Campa√±a', 
                'Total Facturado', 'Total Cobrado', 'Tasa de Cobro (%)', 'Deuda Vencida'
            ];
            exportData.push(headerRow);
            
            // Add data rows
            filteredClients.forEach(client => {
                const agent = agents.find(a => a.id === client.agentId);
                const status = getClientStatus(client.id);
                const campaignEndDate = getClientCampaignEndDate(client.id);
                const clientStats = calculateClientStats(client.id);
                
                const dataRow = [
                    client.name,
                    client.emisora,
                    agent ? agent.name : 'Sin asignar',
                    status,
                    campaignEndDate,
                    clientStats.totalBilled,
                    clientStats.totalPaid,
                    clientStats.paymentRate,
                    clientStats.totalDebt
                ];
                exportData.push(dataRow);
            });
            
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            
            // Set column widths
            const colWidths = [
                { wch: 25 }, // Cliente
                { wch: 15 }, // Emisora
                { wch: 20 }, // Agente
                { wch: 12 }, // Estado
                { wch: 15 }, // Fin Campa√±a
                { wch: 15 }, // Total Facturado
                { wch: 15 }, // Total Cobrado
                { wch: 12 }, // Tasa Cobro
                { wch: 15 }  // Deuda Vencida
            ];
            ws['!cols'] = colWidths;
            
            // Style the header row
            const headerRange = XLSX.utils.decode_range(ws['!ref']);
            for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!ws[cellAddress]) continue;
                ws[cellAddress].s = {
                    font: { bold: true },
                    fill: { fgColor: { rgb: "F3F4F6" } }
                };
            }
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Clientes');
            
            // Generate filename with filters
            let filename = 'Clientes';
            const emisoraFilter = document.getElementById('client-emisora-filter')?.value || '';
            const agentFilter = document.getElementById('client-agent-filter')?.value || '';
            const statusFilter = document.getElementById('client-status-filter')?.value || '';
            const nameFilter = document.getElementById('client-name-filter')?.value || '';
            
            if (emisoraFilter) filename += `_${emisoraFilter}`;
            if (agentFilter) {
                const agent = agents.find(a => a.id === parseInt(agentFilter));
                if (agent) filename += `_${agent.name.replace(/\s+/g, '_')}`;
            }
            if (statusFilter) filename += `_${statusFilter}`;
            if (nameFilter) filename += '_filtrado';
            filename += '.xlsx';
            
            // Save file
            XLSX.writeFile(wb, filename);
            
            // Show success message
            showSuccessToast(`‚úÖ Clientes exportados como ${filename}`);
        }

        // Initialize dashboard on load
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            const today = new Date();
            const days = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];
            const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
            
            const dayName = days[today.getDay()];
            const day = today.getDate();
            const monthName = months[today.getMonth()];
            const year = today.getFullYear();
            
            const dateString = `${dayName}, ${day} de ${monthName} de ${year}`;
            document.getElementById('current-date').textContent = dateString;
            
            // Set current year as default for both filters
            const currentYear = new Date().getFullYear();
            
            // Set year for billing table filter
            const yearFilter = document.getElementById('year-filter');
            if (yearFilter) {
                yearFilter.value = currentYear;
            }
            
            // Set year for chart filter
            const chartYearFilter = document.getElementById('chart-year-filter');
            if (chartYearFilter) {
                chartYearFilter.value = currentYear;
            }
            
            // Initialize Supabase if credentials exist
            initSupabase();
            
            // Initialize charts after a short delay to ensure DOM is ready
            setTimeout(() => {
                if (document.getElementById('main-app') && !document.getElementById('main-app').classList.contains('hidden')) {
                    initChart();
                    loadForecast();
                }
            }, 500);
        });

        // Function to initialize dashboard after login
        function initializeDashboard() {
            console.log('üìä Initializing dashboard...');
            console.log('üìä Data check - Clients:', clients.length, 'Campaigns:', campaigns.length, 'Agents:', agents.length);
            
            // Start Holded sync if enabled
            if (holdedSyncEnabled && holdedApiKey) {
                startHoldedSync();
            }
            
            // Restore the last active tab instead of always showing dashboard
            restoreActiveTab();
            
            // Initialize charts
            setTimeout(() => {
                initChart();
                loadForecast();
            }, 100);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96bd4d3974aef76d',t:'MTc1NDYzODE1NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
